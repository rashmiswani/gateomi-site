<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="Register your face and details for secure access with Gateomi's AI-powered system.">
  <meta name="keywords" content="Gateomi, AI Security, Face Recognition, User Registration, Smart Access">
  <meta name="author" content="Gateomi Team">
  <title>Register User | Gateomi</title>
  <link rel="icon" type="image/x-icon" href="https://storage.googleapis.com/gateomi-static-data/logo.png">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Inter', sans-serif;
    }
    body {
      background: #f8f9fa;
      color: #333;
    }
    header {
      background: white;
      padding: 0px 40px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
    }
    .logo img {
      height: 70px;
    }
    nav {
      display: flex;
      align-items: center;
      gap: 20px;
    }
    nav a {
      margin-left: 20px;
      text-decoration: none;
      color: #555;
      font-weight: 500;
    }
    .admin-profile {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .admin-info {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      font-size: 14px;
    }
    .admin-info #admin-name {
      font-weight: 600;
      color: #1f2937;
    }
    .admin-info #admin-society {
      font-size: 12px;
      color: #6b7280;
    }
    .logout-btn {
      background: #ef4444;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    .logout-btn:hover {
      background: #dc2626;
    }
    .hidden {
      display: none !important;
    }
    .container {
      max-width: 60%;
      margin: 60px auto;
      background: white;
      padding: 40px;
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    h2 {
      text-align: center;
      margin-bottom: 30px;
      color: #1f2937;
    }
    label {
      font-weight: 600;
      display: block;
      margin-top: 20px;
      color: #374151;
    }
    input, select, textarea {
      width: 100%;
      padding: 10px;
      margin-top: 8px;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      font-size: 14px;
      background-color: white;
      transition: border-color 0.2s;
    }
    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: #2a9df4;
      box-shadow: 0 0 0 3px rgba(42, 157, 244, 0.1);
    }
    button {
      margin-top: 30px;
      background: #2a9df4;
      color: white;
      padding: 12px 24px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      width: 100%;
      transition: background-color 0.2s;
    }
    button:hover {
      background: #1e7bb8;
    }
    button:disabled {
      background: #9ca3af;
      cursor: not-allowed;
    }
    footer {
      padding: 40px;
      background: #f1f1f1;
      text-align: center;
      font-size: 14px;
      color: #777;
      margin-top: 60px;
    }
    footer a {
      color: #2a9df4;
      text-decoration: none;
    }
    footer a:hover {
      text-decoration: underline;
    }

    video {
      height: 135px;
      margin: 10px 5px;
      border: 2px solid #d1d5db;
      border-radius: 8px;
    }

    video.mirror {
      transform: scaleX(-1);
    }
    
    img {
      height: 135px;
      margin: 10px 5px;
      border: 2px solid #d1d5db;
      border-radius: 8px;
    }
    #image-preview {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 10px;
      margin-top: 20px;
    }
    #capture-button {
      width: auto;
      padding: 8px 20px;
      background-color: #2a9df4;
      color: white;
      border: none;
      cursor: pointer;
      border-radius: 6px;
      font-weight: 500;
    }
    #capture-button:disabled {
      background: #9ca3af;
      cursor: not-allowed;
    }
    #flip-camera-button {
      width: auto;
      padding: 8px 20px;
      background-color: #6c757d;
      color: white;
      border: none;
      cursor: pointer;
      border-radius: 6px;
      font-weight: 500;
    }
    #flip-camera-button:disabled {
      background: #9ca3af;
      cursor: not-allowed;
    }
    #submit {
        background-color: #28a745;
        color: white;
        border: none;
        cursor: pointer;
        font-size: 16px;
        padding: 12px;
        width: 100%;
        border-radius: 6px;
        margin-top: 20px;
        transition: background-color 0.3s ease;
        font-weight: 600;
    }
    #submit:hover {
        background-color: #218838;
    }
    select {
        width: 100%;
        padding: 10px;
        margin-top: 8px;
        border: 1px solid #d1d5db;
        border-radius: 6px;
        font-size: 14px;
        background-color: white;
        appearance: none;
        -webkit-appearance: none;
        -moz-appearance: none;
        background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20width%3D%2212%22%20height%3D%228%22%20viewBox%3D%220%200%2012%208%22%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%3E%3Cpath%20d%3D%22M6%208L0%200h12L6%208z%22%20fill%3D%22%23444%22/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 10px center;
        background-size: 12px 8px;
        padding-right: 30px;
    }
    select:focus {
        border-color: #2a9df4;
        outline: none;
        box-shadow: 0 0 0 3px rgba(42, 157, 244, 0.1);
    }
    select:disabled {
        background-color: #f9fafb;
        color: #9ca3af;
        cursor: not-allowed;
    }

    .toast {
      position: fixed;
      top: 20px;
      right: 20px;
      background: #28a745;
      color: white;
      padding: 16px 24px;
      border-radius: 8px;
      font-weight: 600;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 20px;
      opacity: 0;
      transform: translateY(-20px);
      transition: opacity 0.4s ease, transform 0.4s ease;
      z-index: 9999;
      min-width: 300px;
    }

    .toast.toast-error {
      background: #dc3545;
    }

    .toast.visible {
      opacity: 1;
      transform: translateY(0);
    }

    .toast-close {
      cursor: pointer;
      font-size: 18px;
      font-weight: normal;
    }

    .hidden { 
      display: none; 
    }
    
    #expire_section {
        display: block;
        transition: all 0.3s ease;
    }

    #expire_section.hidden {
        display: none !important;
        visibility: hidden !important;
        opacity: 0 !important;
        height: 0 !important;
        overflow: hidden !important;
        margin: 0 !important;
        padding: 0 !important;
    }

    #expire_at {
        display: block !important;
    }

    .checkbox-container {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-top: 20px;
    }

    .checkbox-container input[type="checkbox"] {
      width: auto;
      margin: 0;
    }

    .webcam-section {
      margin-top: 20px;
    }

    .webcam-controls {
      display: flex;
      align-items: center;
      gap: 20px;
      flex-wrap: wrap;
      margin-top: 10px;
    }

    .webcam-buttons {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }

    .portal-login-section {
      margin-top: 24px;
      padding: 16px;
      border: 1px solid #e2e8f0;
      border-radius: 10px;
      background: #f8fafc;
    }

    .portal-login-note {
      font-size: 12px;
      color: #6b7280;
      margin-top: 8px;
    }
    .allowed-gates-section {
      margin-top: 24px;
      padding: 20px;
      border: 1px solid #dbeafe;
      border-radius: 14px;
      background: #f8fbff;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    .allowed-gates-heading {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .allowed-gates-title {
      font-size: 16px;
      font-weight: 600;
      color: #1f2937;
    }
    .allowed-gates-hint {
      font-size: 13px;
      color: #6b7280;
    }
    .allowed-gates-toggle {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 14px;
    }
    .allowed-gates-wrapper {
      border: 1px solid #cbd5f5;
      border-radius: 12px;
      background: #ffffff;
      padding: 12px;
      max-height: 200px;
      overflow-y: auto;
      display: block;
    }
    .allowed-gates-wrapper.hidden {
      display: none;
    }
    .allowed-gates-wrapper.disabled {
      opacity: 0.5;
      pointer-events: none;
    }
    .allowed-gates-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .device-option {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 14px;
      color: #1f2937;
    }
    .device-option input[type="checkbox"] {
      accent-color: #2563eb;
      margin: 0;
      width:2% !important
    }
    .device-label {
      font-weight: 500;
      color: #1f2937;
    }

    #allowed-gates-all {
      width:2% !important;
    }
    @media (max-width: 768px) {
      .container {
        max-width: 95%;
        margin: 30px auto;
        padding: 20px;
      }
      
      .form-row {
        grid-template-columns: 1fr;
      }
      
      .webcam-controls {
        flex-direction: column;
        align-items: flex-start;
      }
    }
  </style>
</head>
<body>
  <header>
    <div class="logo">
      <a href="index.html">
        <img src="https://storage.googleapis.com/gateomi-static-data/logo.png" alt="Gateomi Logo">
      </a>
    </div>
    <nav>
      <a href="index.html">Home</a>
      <a href="register.html">Register</a>
      <a href="login.html" id="admin-login-link">Login</a>
      <div id="admin-profile" class="admin-profile hidden">
        <span class="admin-info">
          <span id="admin-name">Admin</span>
          <span id="admin-society">Society</span>
        </span>
        <button id="header-logout" class="logout-btn">Logout</button>
      </div>
    </nav>
  </header>

  <div id="toast" class="toast hidden">
    <span id="toast-message">This is a toast</span>
    <span id="toast-close" class="toast-close">&times;</span>
  </div>

  <div class="container">
    <h2>Register New User</h2>
    <form id="reg-form">
      <div class="form-row">
        <div>
          <label for="state_name">State</label>
          <select name="state_name" id="state_name" required>
            <option value="">Loading...</option>
          </select>
        </div>
        
        <div>
          <label for="city_name">City</label>
          <select name="city_name" id="city_name" required disabled>
            <option value="">Select state first</option>
          </select>
        </div>
      </div>

      <label for="society">Society</label>
      <select name="society_name" id="society" required>
        <option value="">Loading...</option>
      </select>

      <label for="user_type">User Type</label>
      <select name="user_type" id="user_type" required>
        <option value="">Select User Type</option>
        <option value="resident">Resident</option>
        <option value="maintenance staff">Maintenance Staff</option>
        <option value="housekeeping staff">Housekeeping Staff</option>
        <option value="security">Security</option>
        <option value="labor">Labor</option>
        <option value="maid">Maid</option>
        <option value="mali">Mali</option>
      </select>

      <div class="form-row">
        <div>
          <label for="tower">Tower Name</label>
          <input name="tower_name" id="tower" placeholder="Required for residents only">
        </div>
        
        <div>
          <label for="flat">Flat Number</label>
          <input name="flat_number" id="flat" placeholder="Required for residents only">
        </div>
      </div>

      <div class="form-row">
        <div>
          <label for="username">User Name</label>
          <input name="user_name" id="username" required>
        </div>
        
        <div>
          <label for="phone">Mobile Number</label>
          <input name="mobile_number" id="phone" required>
        </div>
      </div>

      <div class="portal-login-section">
        <label for="portal-login-toggle">Portal Access</label>
        <div class="checkbox-container" style="margin-top: 8px;">
          <input type="checkbox" id="portal-login-toggle" name="portal_login">
          <span>Provide portal login for this user</span>
        </div>
        <div id="portal-login-fields" class="hidden">
          <label for="portal-email">Portal Email</label>
          <input type="email" id="portal-email" name="portal_email" placeholder="name@example.com">
          <p class="portal-login-note">We’ll email a temporary password and login code once the user is registered.</p>
        </div>
      </div>

      <div class="allowed-gates-section">
        <div class="allowed-gates-heading">
          <span class="allowed-gates-title">Allowed Gates</span>
          <span class="allowed-gates-hint">Uncheck “All gates” to limit this user to specific entry points.</span>
        </div>
        <div class="allowed-gates-toggle">
          <input type="checkbox" id="allowed-gates-all" checked>
          <span>Allow this user at all gates</span>
        </div>
        <div id="allowed-gates-wrapper" class="allowed-gates-wrapper">
          <div id="allowed-gates-list" class="allowed-gates-list">
            <span class="portal-login-note">Select a society to load gates.</span>
          </div>
        </div>
      </div>

      <div class="checkbox-container">
        <input type="checkbox" name="forever_access" id="forever_access" value="true" 
               onchange="toggleExpireSection()">
        <label for="forever_access" style="margin: 0;">Forever Access (no expiration)</label>
      </div>

      <div id="expire_section">
        <label for="expire_at">Expiration Date *</label>
        <input type="date" name="expire_at" id="expire_at" min="" required>
      </div>

      <div class="webcam-section">
        <label>Webcam</label>
        <div class="webcam-controls">
          <video id="video" autoplay></video>
          <div class="webcam-buttons">
            <button type="button" id="capture-button">Capture Image</button>
            <button type="button" id="flip-camera-button">Flip Camera</button>
          </div>
        </div>
        <div id="image-preview"></div>
      </div>

      <button type="submit" id="submit">Submit</button>
    </form>
  </div>

  <footer>
    &copy; 2025 GATEOMI. All rights reserved. | <a href="index.html">Back to Home</a>
  </footer>

  <script>
    // const backend_url ="http://localhost:8000"
    const backend_url =  "https://gateomi-backend-647776055629.asia-south2.run.app";

    const video = document.getElementById("video");
    const preview = document.getElementById("image-preview");
    const flipButton = document.getElementById("flip-camera-button");
    const maxImages = 6;
    let capturedImages = [];
    let activeStream = null;
    let currentFacingMode = "user";
    const portalLoginToggle = document.getElementById("portal-login-toggle");
    const portalLoginFields = document.getElementById("portal-login-fields");
    const portalEmailInput = document.getElementById("portal-email");
    const portalMandatoryRoles = ["resident", "security", "maintenance staff"];
    const allowedGatesAllToggle = document.getElementById("allowed-gates-all");
    const allowedGatesWrapper = document.getElementById("allowed-gates-wrapper");
    const allowedGatesList = document.getElementById("allowed-gates-list");
    let societyDevices = [];
    let societyDeviceMap = {};

    function applyVideoMirror() {
      const shouldMirror = currentFacingMode === "user";
      video.classList.toggle("mirror", shouldMirror);
    }

    async function startCamera(facingMode = currentFacingMode) {
      try {
        if (activeStream) {
          activeStream.getTracks().forEach(track => track.stop());
          activeStream = null;
        }

        const constraints = { video: { facingMode: { ideal: facingMode } } };
        const stream = await navigator.mediaDevices.getUserMedia(constraints);
        activeStream = stream;
        currentFacingMode = facingMode;
        video.srcObject = stream;
        applyVideoMirror();
      } catch (err) {
        console.error("Camera error:", err);
        if (facingMode !== "user") {
          showToast("Unable to switch camera. Reverting to default view.", true);
          await startCamera("user");
        } else {
          alert("Unable to access camera. Please allow camera permissions.");
        }
      } finally {
        if (flipButton) {
          flipButton.disabled = false;
        }
      }
    }

    async function toggleCameraFacing() {
      if (!flipButton) return;
      flipButton.disabled = true;
      const nextMode = currentFacingMode === "user" ? "environment" : "user";
      await startCamera(nextMode);
    }

    async function captureImage() {
      if (capturedImages.length >= maxImages) {
        showToast("Max 6 images allowed", true);
        return;
      }

      const canvas = document.createElement("canvas");
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      const ctx = canvas.getContext("2d");

      if (currentFacingMode === "user") {
        ctx.translate(canvas.width, 0);
        ctx.scale(-1, 1);
      }
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
      
      const dataURL = canvas.toDataURL("image/jpeg");
      capturedImages.push(dataURL);

      const imgWrapper = document.createElement("div");
      imgWrapper.style.position = "relative";
      imgWrapper.style.display = "inline-block";

      const img = document.createElement("img");
      img.src = dataURL;
      img.alt = "Captured image";

      const removeBtn = document.createElement("span");
      removeBtn.innerHTML = "&times;";
      removeBtn.style.position = "absolute";
      removeBtn.style.top = "-8px";
      removeBtn.style.right = "-8px";
      removeBtn.style.background = "#dc3545";
      removeBtn.style.color = "white";
      removeBtn.style.width = "20px";
      removeBtn.style.height = "20px";
      removeBtn.style.borderRadius = "50%";
      removeBtn.style.display = "flex";
      removeBtn.style.alignItems = "center";
      removeBtn.style.justifyContent = "center";
      removeBtn.style.fontSize = "14px";
      removeBtn.style.cursor = "pointer";
      removeBtn.style.boxShadow = "0 2px 6px rgba(0,0,0,0.3)";
      removeBtn.title = "Remove this image";

      removeBtn.onclick = () => {
        const index = capturedImages.indexOf(dataURL);
        if (index !== -1) {
          capturedImages.splice(index, 1);
        }
        preview.removeChild(imgWrapper);
        document.getElementById("capture-button").disabled = capturedImages.length >= maxImages;
      };

      imgWrapper.appendChild(img);
      imgWrapper.appendChild(removeBtn);
      preview.appendChild(imgWrapper);

      if (capturedImages.length === maxImages) {
        document.getElementById("capture-button").disabled = true;
      }
    }

    async function loadStatesAndCities() {
        const stateSelect = document.getElementById("state_name");
        const citySelect = document.getElementById("city_name");
        const societySelect = document.getElementById("society");

        const stateRes = await fetch(backend_url+"/list-states");
        const states = await stateRes.json();

        stateSelect.innerHTML = "<option value=''>Select State</option>";
        states.forEach(state => {
            const opt = document.createElement("option");
            opt.value = state;
            opt.textContent = state;
            stateSelect.appendChild(opt);
        });

        stateSelect.addEventListener("change", async () => {
            const selectedState = stateSelect.value;
            resetAllowedDevicesUI();
            if (!selectedState) {
                citySelect.innerHTML = "<option value=''>Select state first</option>";
                citySelect.disabled = true;
                societySelect.innerHTML = "<option value=''>Select state and city first</option>";
                societySelect.disabled = true;
                return;
            }

            const cityRes = await fetch(`${backend_url}/list-cities?state=${encodeURIComponent(selectedState)}`);
            const cities = await cityRes.json();

            citySelect.disabled = false;
            citySelect.innerHTML = "<option value=''>Select City</option>";
            cities.forEach(city => {
                const opt = document.createElement("option");
                opt.value = city;
                opt.textContent = city;
                citySelect.appendChild(opt);
            });

            societySelect.innerHTML = "<option value=''>Select state and city first</option>";
            societySelect.disabled = true;
        });

        citySelect.addEventListener("change", async () => {
            const selectedState = stateSelect.value;
            const selectedCity = citySelect.value;
            
            if (!selectedState || !selectedCity) {
                societySelect.innerHTML = "<option value=''>Select state and city first</option>";
                societySelect.disabled = true;
                resetAllowedDevicesUI();
                return;
            }

            try {
                const societyRes = await fetch(`${backend_url}/list-societies?state=${encodeURIComponent(selectedState)}&city=${encodeURIComponent(selectedCity)}`);
                const societies = await societyRes.json();

                societySelect.disabled = false;
                societySelect.innerHTML = "<option value=''>Select Society</option>";
                societies.forEach(society => {
                    const opt = document.createElement("option");
                    opt.value = society;
                    opt.textContent = society;
                    societySelect.appendChild(opt);
                });
            } catch (error) {
                console.error("Error loading societies:", error);
                societySelect.innerHTML = "<option value=''>Error loading societies</option>";
                societySelect.disabled = true;
            }
        });

        societySelect.addEventListener("change", () => {
            const selectedSociety = societySelect.value;
            if (!selectedSociety) {
                resetAllowedDevicesUI();
                return;
            }
            loadSocietyDevices();
        });
    }

    async function submitForm(e) {
        e.preventDefault();
        if (capturedImages.length === 0) return alert("Please capture at least 1 image.");

        const form = document.getElementById("reg-form");
        const submitBtn = document.getElementById("submit");
        const foreverCheckbox = document.getElementById("forever_access");

        submitBtn.disabled = true;
        submitBtn.textContent = "Submitting...";

        const formData = new FormData(form);
        const wantsPortalLogin = portalLoginToggle ? (portalLoginToggle.checked || portalLoginToggle.disabled) : false;
        const portalEmailValue = portalEmailInput ? portalEmailInput.value.trim() : "";

        if (wantsPortalLogin && !portalEmailValue) {
            showToast("Portal email is required for login provisioning.", true);
            submitBtn.disabled = false;
            submitBtn.textContent = "Submit";
            return;
        }

        if (portalLoginToggle) {
            formData.set("portal_login", wantsPortalLogin ? "true" : "false");
        }
        if (portalEmailInput) {
            formData.set("portal_email", portalEmailValue);
        }

        formData.delete("allowed_device_ids");
        const selectedDevices = getSelectedAllowedDevices();
        if (selectedDevices.length) {
            selectedDevices.forEach((deviceId) => formData.append("allowed_device_ids", deviceId));
        }

        if (foreverCheckbox.checked) {
            formData.delete("expire_at");
        } else {
            const expireAt = formData.get("expire_at");
            if (!expireAt) {
                alert("Please provide an expiration date or check 'Forever Access'");
                submitBtn.disabled = false;
                submitBtn.textContent = "Submit";
                return;
            }
        }

        capturedImages.forEach((base64, idx) => {
            const byteString = atob(base64.split(',')[1]);
            const mimeString = base64.split(',')[0].split(':')[1].split(';')[0];
            const ab = new ArrayBuffer(byteString.length);
            const ia = new Uint8Array(ab);
            for (let i = 0; i < byteString.length; i++) {
            ia[i] = byteString.charCodeAt(i);
            }
            const blob = new Blob([ab], { type: mimeString });
            formData.append("images", blob, `image${idx + 1}.jpg`);
        });

        try {
            const res = await fetch(backend_url + "/register-user", {
            method: "POST",
            body: formData,
            });

            const result = await res.json();
            if (result.status === "success") {
              showToast("User registered successfully!");
              form.reset();
              capturedImages = [];
              preview.innerHTML = "";
              document.getElementById("forever_access").checked = false;
              document.getElementById("expire_section").classList.remove("hidden");
              document.getElementById("expire_at").required = true;
              if (portalEmailInput) {
                portalEmailInput.value = "";
              }
              const currentUserType = document.getElementById("user_type").value || "";
              applyPortalDefaultsForUserType(currentUserType);
              resetAllowedDevicesUI();
              if (result.portal) {
                const portalMessages = [];
                if (result.portal.otp_sent) {
                  portalMessages.push("Portal login email sent.");
                } else if (result.portal.otp) {
                  portalMessages.push(`Portal OTP: ${result.portal.otp}`);
                }
                if (result.portal.temp_password) {
                  portalMessages.push(`Temp password: ${result.portal.temp_password}`);
                }
                if (portalMessages.length) {
                  showToast(portalMessages.join(" "));
                }
              }
            } else {
              showToast("Error: " + result.message, true);
            }
            document.getElementById("capture-button").disabled = false;
            
        } catch (err) {
            alert("Error submitting form: " + err.message);
        } finally {
            submitBtn.disabled = false;
            submitBtn.textContent = "Submit";
        }
    }

    function showToast(message, isError = false) {
      const toast = document.getElementById("toast");
      const toastMsg = document.getElementById("toast-message");
    
      toast.classList.remove("hidden", "toast-error", "visible");
      toastMsg.textContent = message;
      if (isError) toast.classList.add("toast-error");
      toast.classList.add("visible");
    
      const autoHide = setTimeout(() => {
        toast.classList.remove("visible");
        toast.classList.add("hidden");
      }, 10000);
    
      document.getElementById("toast-close").onclick = () => {
        toast.classList.remove("visible");
        toast.classList.add("hidden");
        clearTimeout(autoHide);
      };
    }

function toggleExpireSection() {
    const foreverCheckbox = document.getElementById("forever_access");
    const expireSection = document.getElementById("expire_section");
    const expireField = document.getElementById("expire_at");
    
    if (foreverCheckbox.checked) {
        expireSection.classList.add("hidden");
        expireField.required = false;
        expireField.value = "";
    } else {
        expireSection.classList.remove("hidden");
        expireField.required = true;
        const today = new Date().toISOString().split('T')[0];
        expireField.min = today;
    }
}

function updatePortalLoginUI() {
    if (!portalLoginToggle || !portalLoginFields) {
        return;
    }
    const wantsPortal = portalLoginToggle.checked || portalLoginToggle.disabled;
    portalLoginFields.classList.toggle('hidden', !wantsPortal);
    if (portalEmailInput) {
        portalEmailInput.required = wantsPortal;
        if (!wantsPortal) {
            portalEmailInput.value = '';
        }
    }
}

function applyPortalDefaultsForUserType(userType) {
    if (!portalLoginToggle) {
        return;
    }
    if (portalMandatoryRoles.includes(userType)) {
        portalLoginToggle.checked = true;
        portalLoginToggle.disabled = true;
    } else {
        portalLoginToggle.disabled = false;
    }
    updatePortalLoginUI();
}

function resetAllowedDevicesUI() {
    if (allowedGatesAllToggle) {
        allowedGatesAllToggle.checked = true;
    }
    if (allowedGatesList) {
        allowedGatesList.innerHTML = '<span class="portal-login-note">Select a society to load gates.</span>';
    }
    if (allowedGatesWrapper) {
        allowedGatesWrapper.classList.add('hidden');
        allowedGatesWrapper.classList.remove('disabled');
    }
    societyDevices = [];
    societyDeviceMap = {};
    syncAllowedDevicesState();
}

function syncAllowedDevicesState() {
    if (!allowedGatesList) {
        return;
    }
    const allChecked = allowedGatesAllToggle ? allowedGatesAllToggle.checked : true;
    if (allowedGatesWrapper) {
        allowedGatesWrapper.classList.toggle('hidden', societyDevices.length === 0);
        allowedGatesWrapper.classList.toggle('disabled', allChecked);
    }
    const checkboxes = allowedGatesList.querySelectorAll('input.allowed-gate-checkbox');
    checkboxes.forEach((checkbox) => {
        checkbox.disabled = allChecked;
        if (allChecked) {
            checkbox.checked = false;
        }
    });
}

function getSelectedAllowedDevices() {
    if (!allowedGatesList || (allowedGatesAllToggle && allowedGatesAllToggle.checked)) {
        return [];
    }
    const checkboxes = allowedGatesList.querySelectorAll('input.allowed-gate-checkbox:checked');
    return Array.from(checkboxes).map((checkbox) => checkbox.value);
}

function renderAllowedDevices() {
    if (!allowedGatesList) {
        return;
    }
    allowedGatesList.innerHTML = '';
    if (!societyDevices.length) {
        allowedGatesList.innerHTML = '<span class="portal-login-note">No gates available.</span>';
        return;
    }
    societyDevices.forEach((device) => {
        const option = document.createElement('label');
        option.className = 'device-option';
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.value = device.id;
        checkbox.dataset.deviceId = device.id;
        checkbox.classList.add('allowed-gate-checkbox');
        checkbox.addEventListener('change', () => {
            if (allowedGatesAllToggle && allowedGatesAllToggle.checked) {
                allowedGatesAllToggle.checked = false;
                syncAllowedDevicesState();
            }
        });
        const span = document.createElement('span');
        span.className = 'device-label';
        const labelText = device.label || device.display_name || device.name || device.device_id || device.id || 'Unnamed gate';
        span.textContent = labelText;
        option.title = labelText;
        option.appendChild(checkbox);
        option.appendChild(span);
        console.debug('Render gate option', device);
        allowedGatesList.appendChild(option);
    });
    if (allowedGatesWrapper) {
        allowedGatesWrapper.classList.remove('hidden');
    }
    syncAllowedDevicesState();
}

async function loadSocietyDevices() {
    if (!allowedGatesList) {
        return;
    }
    const token = localStorage.getItem(tokenStorageKey);
    if (!token) {
        resetAllowedDevicesUI();
        return;
    }
    try {
        const response = await fetch(`${backend_url}/admin/devices`, {
            headers: {
                Authorization: `Bearer ${token}`,
                'Content-Type': 'application/json',
            },
        });
        if (!response.ok) {
            throw new Error(`Failed to load devices (${response.status})`);
        }
        const data = await response.json();
        societyDevices = Array.isArray(data.devices) ? data.devices : [];
        societyDeviceMap = {};
        societyDevices.forEach((device) => {
            societyDeviceMap[device.id] = device.label;
        });
        renderAllowedDevices();
    } catch (error) {
        console.error('Device load error:', error);
        societyDevices = [];
        societyDeviceMap = {};
        if (allowedGatesList) {
            allowedGatesList.innerHTML = '<span class="portal-login-note">Unable to load gates.</span>';
        }
    }
}

document.getElementById("capture-button").addEventListener("click", captureImage);
document.getElementById("reg-form").addEventListener("submit", submitForm);
if (flipButton) {
  flipButton.addEventListener("click", toggleCameraFacing);
}

if (portalLoginToggle) {
  portalLoginToggle.addEventListener("change", () => {
    if (portalLoginToggle.disabled) {
      portalLoginToggle.checked = true;
      return;
    }
    updatePortalLoginUI();
  });
}

if (allowedGatesAllToggle) {
  allowedGatesAllToggle.addEventListener('change', syncAllowedDevicesState);
}

startCamera();
loadStatesAndCities();

    document.getElementById("user_type").addEventListener("change", function() {
        const userType = this.value;
        const towerField = document.getElementById("tower");
        const flatField = document.getElementById("flat");
        
        if (userType === "resident") {
            towerField.required = true;
            flatField.required = true;
            towerField.placeholder = "Required for residents";
            flatField.placeholder = "Required for residents";
        } else {
            towerField.required = false;
            flatField.required = false;
            towerField.placeholder = "Optional for non-residents";
            flatField.placeholder = "Optional for non-residents";
        }

        applyPortalDefaultsForUserType(userType);
    });

    document.addEventListener("DOMContentLoaded", function() {
        const today = new Date().toISOString().split('T')[0];
        document.getElementById("expire_at").min = today;
        
        document.getElementById("forever_access").checked = false;
        document.getElementById("expire_section").classList.remove("hidden");
        document.getElementById("expire_at").required = true;
        const initialUserType = document.getElementById("user_type").value;
        applyPortalDefaultsForUserType(initialUserType);
        resetAllowedDevicesUI();
    });

    // Login state management
    const tokenStorageKey = 'gateomiAdminToken';
    const profileStorageKey = 'gateomiAdminProfile';
    
    function updateHeaderForLoggedInUser() {
      const adminLoginLink = document.getElementById('admin-login-link');
      const adminProfile = document.getElementById('admin-profile');
      const adminName = document.getElementById('admin-name');
      const adminSociety = document.getElementById('admin-society');
      const headerLogout = document.getElementById('header-logout');
      
      if (adminLoginLink && adminProfile) {
        adminLoginLink.style.display = 'none';
        adminProfile.classList.remove('hidden');
        
        if (adminName) adminName.textContent = 'Admin';
        if (adminSociety) adminSociety.textContent = 'Society';
        
        if (headerLogout) {
          headerLogout.onclick = () => {
            localStorage.removeItem(tokenStorageKey);
            localStorage.removeItem(profileStorageKey);
            window.location.reload();
          };
        }
      }
    }
    
    function updateHeaderForLoggedOutUser() {
      const adminLoginLink = document.getElementById('admin-login-link');
      const adminProfile = document.getElementById('admin-profile');
      
      if (adminLoginLink && adminProfile) {
        adminLoginLink.style.display = 'inline';
        adminProfile.classList.add('hidden');
      }
    }
    
    function checkLoginState() {
      const storedToken = localStorage.getItem(tokenStorageKey);
      const storedProfile = localStorage.getItem(profileStorageKey);
      
      if (storedToken && storedProfile) {
        try {
          const profile = JSON.parse(storedProfile);
          updateHeaderForLoggedInUser();
          if (profile.name) {
            const adminName = document.getElementById('admin-name');
            if (adminName) adminName.textContent = profile.name;
          }
          if (profile.society && profile.city) {
            const adminSociety = document.getElementById('admin-society');
            if (adminSociety) adminSociety.textContent = `${profile.society}, ${profile.city}`;
          }
        } catch (error) {
          localStorage.removeItem(tokenStorageKey);
          localStorage.removeItem(profileStorageKey);
          updateHeaderForLoggedOutUser();
        }
      } else {
        updateHeaderForLoggedOutUser();
      }
    }
    
    document.addEventListener('DOMContentLoaded', checkLoginState);
  </script>
</body>
</html>
