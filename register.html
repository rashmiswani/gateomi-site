<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="Register your face and details for secure access with Gateomi's AI-powered system.">
<meta name="keywords" content="Gateomi, AI Security, Face Recognition, User Registration, Smart Access">
<meta name="author" content="Gateomi Team">
  <title>Register User | Gateomi</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Inter', sans-serif;
    }
    body {
      background: #f8f9fa;
      color: #333;
    }
    header {
      background: white;
      padding: 0px 40px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
    }
    .logo {
      font-size: 24px;
      font-weight: 600;
      color: #2a9df4;
    }
    nav a {
      margin-left: 20px;
      text-decoration: none;
      color: #555;
      font-weight: 500;
    }
    .container {
      max-width: 60%;
      margin: 60px auto;
      background: white;
      padding: 40px;
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    h2 {
      text-align: center;
      margin-bottom: 30px;
    }
    label {
      font-weight: bold;
      display: block;
      margin-top: 20px;
    }
    input, select, textarea {
      width: 100%;
      padding: 10px;
      margin-top: 8px;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 14px;
    }
    button {
      margin-top: 30px;
      background: #2a9df4;
      color: white;
      padding: 12px 24px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      width: 100%;
    }
    footer {
      padding: 40px;
      background: #f1f1f1;
      text-align: center;
      font-size: 14px;
      color: #777;
      margin-top: 60px;
    }
    input, select, textarea {
        font-size: 14px;
        padding: 8px;
        margin-top: 6px;
        margin-bottom: 12px;
        width: 100%;
        max-width: 100%;
        border: 1px solid #ccc;
        border-radius: 6px;
        background-color: white;
        box-sizing: border-box;
    }

    video {
/*       width: 180px; */
      height: 135px;
      margin: 10px 5px;
      border: 2px solid #444;
      transform: scaleX(-1); /* Mirror video preview like selfie camera */
    }
    
    img {
      height: 135px;
      margin: 10px 5px;
      border: 2px solid #444;
    }
    #image-preview {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 10px;
    }
    #capture-button {
      width: auto;
      padding: 8px 20px;
      background-color: #2a9df4;
      color: white;
      border: none;
      cursor: pointer;
    }
    #capture-button:disabled {
      background: #aaa;
    }
    #submit {
        background-color: #28a745;
        color: white;
        border: none;
        cursor: pointer;
        font-size: 16px;
        padding: 10px;
        width: 100%;
        border-radius: 6px;
        margin-top: 20px;
        transition: background-color 0.3s ease;
    }
    #submit:hover {
        background-color: #218838;
    }
    select {
        width: 100%;
        padding: 8px;
        margin-top: 6px;
        margin-bottom: 12px;
        border: 1px solid #ccc;
        border-radius: 6px;
        font-size: 14px;
        background-color: white;
        appearance: none;             /* removes default OS arrow */
        -webkit-appearance: none;
        -moz-appearance: none;
        background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20width%3D%2212%22%20height%3D%228%22%20viewBox%3D%220%200%2012%208%22%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%3E%3Cpath%20d%3D%22M6%208L0%200h12L6%208z%22%20fill%3D%22%23444%22/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 10px center;
        background-size: 12px 8px;
        padding-right: 30px; /* space for arrow */
    }
    select:focus {
        border-color: blue;
        outline: none;
    }

    .toast {
  position: fixed;
  top: 20px;
  right: 20px;
  background: #28a745;
  color: white;
  padding: 16px 24px;
  border-radius: 8px;
  font-weight: bold;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 20px;
  opacity: 0;
  transform: translateY(-20px);
  transition: opacity 0.4s ease, transform 0.4s ease;
  z-index: 9999;
  min-width: 300px;
}

.toast.toast-error {
  background: #dc3545;
}

.toast.visible {
  opacity: 1;
  transform: translateY(0);
}

.toast-close {
  cursor: pointer;
  font-size: 18px;
  font-weight: normal;
}

.hidden { display: none; }
.toast.visible { display: flex; opacity: 1; transform: translateY(0); }
    
#expire_section {
    display: block;
    transition: all 0.3s ease;
}

#expire_section.hidden {
    display: none !important;
    visibility: hidden !important;
    opacity: 0 !important;
    height: 0 !important;
    overflow: hidden !important;
    margin: 0 !important;
    padding: 0 !important;
}

#expire_at {
    display: block !important;
}
  </style>
</head>
<body>
  

  <header>
    <div class="logo">
      <a href="index.html">
      <img src="https://storage.googleapis.com/gateomi-static-content/logo.png" alt="Gateomi Logo" style="height: 70px; vertical-align: middle;border:0">
      </a>
    </div>
    <nav>
      <a href="index.html">Home</a>
      <a href="register.html">Register</a>
    </nav>
   
  </header>
  <div id="toast" class="toast hidden">
    <span id="toast-message">This is a toast</span>
    <span id="toast-close" class="toast-close">&times;</span>
  </div>

  <div class="container">
    <h2>Register New User</h2>
    <form id="reg-form">
        <label for="state_name">State</label>
        <select name="state_name" id="state_name" required>
          <option value="">Loading...</option>
        </select>
        
        <label for="city_name">City</label>
        <select name="city_name" id="city_name" required disabled>
          <option value="">Select state first</option>
        </select>

      <label for="society">Society</label>
      <select name="society_name" id="society" required>
        <option value="">Loading...</option>
      </select>

      <label for="user_type">User Type</label>
      <select name="user_type" id="user_type" required>
        <option value="">Select User Type</option>
        <option value="resident">Resident</option>
        <option value="maid">Maid</option>
        <option value="labor">Labor</option>
        <option value="maintenance staff">Maintenance Staff</option>
        <option value="security">Security</option>
      </select>

      <label for="tower">Tower Name</label>
      <input name="tower_name" id="tower" placeholder="Required for residents only">

      <label for="flat">Flat Number</label>
      <input name="flat_number" id="flat" placeholder="Required for residents only">

      <label for="username">User Name</label>
      <input name="user_name" id="username" required>

      <label for="phone">Mobile Number</label>
      <input name="mobile_number" id="phone" required>

      <label for="forever_access" style="display: flex; align-items: center; gap: 10px; margin-top: 20px;">
        <input type="checkbox" name="forever_access" id="forever_access" value="true" 
               style="width: auto; margin: 0;" 
               onchange="toggleExpireSection()">
        <span>Forever Access (no expiration)</span>
      </label>

      <div id="expire_section">
        <label for="expire_at">Expiration Date *</label>
        <input type="date" name="expire_at" id="expire_at" min="" required>
      </div>

      <label>Webcam</label>
      <div style="display: flex; align-items: center; gap: 20px; flex-wrap: wrap;">
        <video id="video" autoplay></video>
        <button type="button" id="capture-button">Capture Image</button>
      </div>
      <!--
      <video id="video" autoplay></video>
      <button type="button" id="capture-button">Capture Image</button> -->

      <div id="image-preview"></div>

      <button type="submit" id="submit">Submit</button>
    </form>
  </div>

  <script>
    // const backend_url = "http://localhost:8000"
    // const backend_url = "https://gateomi-backend.onrender.com"
    // const backend_url="https://gateomi-backend-1056170451599.asia-south1.run.app"
    const backend_url="https://gateomi-backend-647776055629.asia-south1.run.app"

    const video = document.getElementById("video");
    const preview = document.getElementById("image-preview");
    const maxImages = 6;
    let capturedImages = [];

    async function startCamera() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: true });
        video.srcObject = stream;
      } catch (err) {
        alert("Unable to access camera. Please allow camera permissions.");
      }
    }

    async function captureImage() {
      if (capturedImages.length >= maxImages) {
        showToast("Max 6 images allowed", true);
        return;
      }

      const canvas = document.createElement("canvas");
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      const ctx = canvas.getContext("2d");
      
      // Flip the captured image horizontally to get correct orientation
      // (since video is mirrored, we need to flip the capture)
      ctx.scale(-1, 1);
      ctx.drawImage(video, -canvas.width, 0, canvas.width, canvas.height);
      
      const dataURL = canvas.toDataURL("image/jpeg");

      // Add to memory
      capturedImages.push(dataURL);

      // Create wrapper div
      const imgWrapper = document.createElement("div");
      imgWrapper.style.position = "relative";
      imgWrapper.style.display = "inline-block";

      // Create image
      const img = document.createElement("img");
      img.src = dataURL;
      img.alt = "Captured image";

      // Create remove button
      const removeBtn = document.createElement("span");
      removeBtn.innerHTML = "&times;";
      removeBtn.style.position = "absolute";
      removeBtn.style.top = "-8px";
      removeBtn.style.right = "-8px";
      removeBtn.style.background = "#dc3545";
      removeBtn.style.color = "white";
      removeBtn.style.width = "20px";
      removeBtn.style.height = "20px";
      removeBtn.style.borderRadius = "50%";
      removeBtn.style.display = "flex";
      removeBtn.style.alignItems = "center";
      removeBtn.style.justifyContent = "center";
      removeBtn.style.fontSize = "14px";
      removeBtn.style.cursor = "pointer";
      removeBtn.style.boxShadow = "0 2px 6px rgba(0,0,0,0.3)";
      removeBtn.title = "Remove this image";

      // Remove logic
      removeBtn.onclick = () => {
        const index = capturedImages.indexOf(dataURL);
        if (index !== -1) {
          capturedImages.splice(index, 1);
        }
        preview.removeChild(imgWrapper);
        document.getElementById("capture-button").disabled = capturedImages.length >= maxImages;
      };

      imgWrapper.appendChild(img);
      imgWrapper.appendChild(removeBtn);
      preview.appendChild(imgWrapper);

      // Disable button if max reached
      if (capturedImages.length === maxImages) {
        document.getElementById("capture-button").disabled = true;
      }
    }


    async function loadStatesAndCities() {
        const stateSelect = document.getElementById("state_name");
        const citySelect = document.getElementById("city_name");
        const societySelect = document.getElementById("society");

        const stateRes = await fetch(backend_url+"/list-states");
        const states = await stateRes.json();

        stateSelect.innerHTML = "<option value=''>Select State</option>";
        states.forEach(state => {
            const opt = document.createElement("option");
            opt.value = state;
            opt.textContent = state;
            stateSelect.appendChild(opt);
        });

        stateSelect.addEventListener("change", async () => {
            const selectedState = stateSelect.value;
            if (!selectedState) {
                citySelect.innerHTML = "<option value=''>Select state first</option>";
                citySelect.disabled = true;
                societySelect.innerHTML = "<option value=''>Select state and city first</option>";
                societySelect.disabled = true;
                return;
            }

            const cityRes = await fetch(`${backend_url}/list-cities?state=${encodeURIComponent(selectedState)}`);
            const cities = await cityRes.json();

            citySelect.disabled = false;
            citySelect.innerHTML = "<option value=''>Select City</option>";
            cities.forEach(city => {
                const opt = document.createElement("option");
                opt.value = city;
                opt.textContent = city;
                citySelect.appendChild(opt);
            });

            // Reset society dropdown when state changes
            societySelect.innerHTML = "<option value=''>Select state and city first</option>";
            societySelect.disabled = true;
        });

        citySelect.addEventListener("change", async () => {
            const selectedState = stateSelect.value;
            const selectedCity = citySelect.value;
            
            if (!selectedState || !selectedCity) {
                societySelect.innerHTML = "<option value=''>Select state and city first</option>";
                societySelect.disabled = true;
                return;
            }

            try {
                const societyRes = await fetch(`${backend_url}/list-societies?state=${encodeURIComponent(selectedState)}&city=${encodeURIComponent(selectedCity)}`);
                const societies = await societyRes.json();

                societySelect.disabled = false;
                societySelect.innerHTML = "<option value=''>Select Society</option>";
                societies.forEach(society => {
                    const opt = document.createElement("option");
                    opt.value = society;
                    opt.textContent = society;
                    societySelect.appendChild(opt);
                });
            } catch (error) {
                console.error("Error loading societies:", error);
                societySelect.innerHTML = "<option value=''>Error loading societies</option>";
                societySelect.disabled = true;
            }
        });
    }



    async function submitForm(e) {
        e.preventDefault();
        if (capturedImages.length === 0) return alert("Please capture at least 1 image.");

        const form = document.getElementById("reg-form");
        const submitBtn = document.getElementById("submit");
        const foreverCheckbox = document.getElementById("forever_access");

        submitBtn.disabled = true;
        submitBtn.textContent = "Submitting...";

        const formData = new FormData(form);

        // Handle expire_at based on forever_access checkbox
        if (foreverCheckbox.checked) {
            // If forever access is checked, don't send expire_at (will be null on backend)
            formData.delete("expire_at");
        } else {
            // If forever access is not checked, ensure expire_at is provided
            const expireAt = formData.get("expire_at");
            if (!expireAt) {
                alert("Please provide an expiration date or check 'Forever Access'");
                submitBtn.disabled = false;
                submitBtn.textContent = "Submit";
                return;
            }
        }

        capturedImages.forEach((base64, idx) => {
            const byteString = atob(base64.split(',')[1]);
            const mimeString = base64.split(',')[0].split(':')[1].split(';')[0];
            const ab = new ArrayBuffer(byteString.length);
            const ia = new Uint8Array(ab);
            for (let i = 0; i < byteString.length; i++) {
            ia[i] = byteString.charCodeAt(i);
            }
            const blob = new Blob([ab], { type: mimeString });
            formData.append("images", blob, `image${idx + 1}.jpg`);
        });

        try {
            const res = await fetch(backend_url + "/register-user", {
            method: "POST",
            body: formData,
            });

            const result = await res.json();
            if (result.status === "success") {
              showToast("User registered!");
              form.reset();
              capturedImages = [];
              preview.innerHTML = "";
              // Reset form state
              document.getElementById("forever_access").checked = false;
              document.getElementById("expire_section").classList.remove("hidden");
              document.getElementById("expire_at").required = true;
            } else {
              showToast("Error: " + result.message, true);
            }
            document.getElementById("capture-button").disabled = false;
            
        } catch (err) {
            alert("Error submitting form: " + err.message);
        } finally {
            submitBtn.disabled = false;
            submitBtn.textContent = "Submit";
        }
    }


    function showToast(message, isError = false) {
      const toast = document.getElementById("toast");
      const toastMsg = document.getElementById("toast-message");
    
      toast.classList.remove("hidden", "toast-error", "visible");
      toastMsg.textContent = message;
      if (isError) toast.classList.add("toast-error");
      toast.classList.add("visible");
    
      const autoHide = setTimeout(() => {
        toast.classList.remove("visible");
        toast.classList.add("hidden");
      }, 10000);
    
      document.getElementById("toast-close").onclick = () => {
        toast.classList.remove("visible");
        toast.classList.add("hidden");
        clearTimeout(autoHide);
      };
    }

    document.getElementById("capture-button").addEventListener("click", captureImage);
    document.getElementById("reg-form").addEventListener("submit", submitForm);

    startCamera();
    loadStatesAndCities();

    // Handle user type changes
    document.getElementById("user_type").addEventListener("change", function() {
        const userType = this.value;
        const towerField = document.getElementById("tower");
        const flatField = document.getElementById("flat");
        
        if (userType === "resident") {
            towerField.required = true;
            flatField.required = true;
            towerField.placeholder = "Required for residents";
            flatField.placeholder = "Required for residents";
        } else {
            towerField.required = false;
            flatField.required = false;
            towerField.placeholder = "Optional for non-residents";
            flatField.placeholder = "Optional for non-residents";
        }
    });

    // Simple function to toggle expiration section
    function toggleExpireSection() {
        const foreverCheckbox = document.getElementById("forever_access");
        const expireSection = document.getElementById("expire_section");
        const expireField = document.getElementById("expire_at");
        
        console.log("Checkbox checked:", foreverCheckbox.checked);
        
        if (foreverCheckbox.checked) {
            // Hide expiration section
            expireSection.classList.add("hidden");
            expireField.required = false;
            expireField.value = "";
            console.log("Hiding expiration section");
        } else {
            // Show expiration section
            expireSection.classList.remove("hidden");
            expireField.required = true;
            const today = new Date().toISOString().split('T')[0];
            expireField.min = today;
            console.log("Showing expiration section");
        }
    }

    // Initialize on page load
    document.addEventListener("DOMContentLoaded", function() {
        const today = new Date().toISOString().split('T')[0];
        document.getElementById("expire_at").min = today;
        
        // Set initial state
        document.getElementById("forever_access").checked = false;
        document.getElementById("expire_section").classList.remove("hidden");
        document.getElementById("expire_at").required = true;
        
        console.log("Page loaded - initial state set");
    });
  </script>
<footer>
  &copy; 2025 GATEOMI. All rights reserved. | <a href="index.html">Back to Home</a>
</footer>

</body>
</html>
