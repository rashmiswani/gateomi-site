<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Society Dashboard | Gateomi</title>
  <link rel="icon" type="image/x-icon" href="https://storage.googleapis.com/gateomi-static-data/logo.png">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.6/dist/chart.umd.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Inter', sans-serif;
    }
    body {
      background: #f8f9fa;
      color: #333;
      min-height: 100vh;
    }
    header {
      background: white;
      padding: 0 40px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
    }
    .logo img {
      height: 70px;
    }
    nav a {
      margin-left: 20px;
      text-decoration: none;
      color: #555;
      font-weight: 500;
    }
    .admin-profile {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .admin-info {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      font-size: 14px;
    }
    .admin-info #admin-name {
      font-weight: 600;
      color: #1f2937;
    }
    .admin-info #admin-society {
      font-size: 12px;
      color: #6b7280;
    }
    .logout-btn {
      background: #ef4444;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    .logout-btn:hover {
      background: #dc2626;
    }
    .hidden {
      display: none !important;
    }
    .page-shell {
      /* max-width: 1200px; */
      margin: 40px auto;
      padding: 0 20px 60px;
    }
    .card {
      background: white;
      border-radius: 12px;
      box-shadow: 0 8px 24px rgba(15, 23, 42, 0.08);
      padding: 36px;
      margin-bottom: 30px;
    }
    .card h2 {
      margin-bottom: 12px;
      font-size: 26px;
    }
    .card p {
      color: #666;
      margin-bottom: 20px;
    }
    button {
      background: #2a9df4;
      color: white;
      border: none;
      border-radius: 8px;
      padding: 12px 20px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.12s ease, box-shadow 0.12s ease;
    }
    button:hover {
      transform: translateY(-1px);
      box-shadow: 0 6px 16px rgba(42, 157, 244, 0.25);
    }
    button.secondary {
      background: #6c757d;
    }
    button:disabled {
      opacity: 0.6;
      cursor: wait;
      box-shadow: none;
    }
    .hidden {
      display: none !important;
    }
    .feedback {
      margin-bottom: 18px;
      padding: 14px 16px;
      border-radius: 10px;
      font-size: 14px;
    }
    .feedback.error {
      background: #ffe9e9;
      color: #b02a37;
      border: 1px solid #f5c2c7;
    }
    .feedback.success {
      background: #e9f7ef;
      color: #1e7e34;
      border: 1px solid #badbcc;
    }
    .portal-toolbar {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 16px;
      margin-bottom: 24px;
    }
    .portal-toolbar h2 {
      font-size: 28px;
      margin-bottom: 4px;
    }
    .portal-toolbar .small-label {
      color: #6b7280;
    }
    .portal-body {
      display: grid;
      grid-template-columns: 220px 1fr;
      gap: 24px;
    }
    .portal-nav {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .portal-nav .nav-link {
      padding: 14px 16px;
      border-radius: 10px;
      border: 1px solid #e4e7ec;
      background: #f8fafc;
      text-align: left;
      color: #1f2937;
      font-weight: 600;
      transition: all 0.15s ease;
    }
    .portal-nav .nav-link:hover {
      background: #eef2ff;
      border-color: #c7d2fe;
      transform: translateY(-1px);
    }
    .portal-nav .nav-link.active {
      background: linear-gradient(135deg, #2a9df4, #7f5af0);
      color: white;
      border-color: transparent;
      box-shadow: 0 12px 24px rgba(42, 157, 244, 0.25);
    }
    .portal-content {
      background: #ffffff;
      border-radius: 16px;
      border: 1px solid #e5e7eb;
      padding: 28px;
      box-shadow: 0 10px 30px rgba(148, 163, 184, 0.15);
    }
    .portal-section {
      display: none;
      flex-direction: column;
      gap: 26px;
    }
    .portal-section.active {
      display: flex;
    }
    .summary-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 18px;
    }
    .summary-tile {
      background: #f8fafc;
      border: 1px solid #e2e8f0;
      border-radius: 14px;
      padding: 18px;
      transition: transform 0.12s ease, box-shadow 0.12s ease;
    }
    .summary-tile:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 24px rgba(15, 23, 42, 0.08);
    }
    .summary-tile h4 {
      font-size: 13px;
      color: #475569;
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }
    .summary-tile span {
      font-weight: 700;
      font-size: 28px;
      color: #1f2937;
      display: block;
    }
    .summary-tile .small-label {
      margin-top: 4px;
      color: #64748b;
      font-size: 13px;
    }
    .charts-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 18px;
      margin: 26px 0 10px;
    }
    .chart-card {
      background: #ffffff;
      border-radius: 16px;
      border: 1px solid #e2e8f0;
      padding: 20px;
      box-shadow: 0 10px 24px rgba(15, 23, 42, 0.05);
      min-height: 280px;
    }
    .chart-card__title {
      font-weight: 600;
      margin-bottom: 12px;
      color: #1f2937;
    }
    .chart-card__caption {
      margin-top: 8px;
      font-size: 12px;
      color: #64748b;
    }
    .chart-card canvas {
      width: 100% !important;
      height: 240px !important;
    }
    .logs-panel {
      background: #f8fafc;
      border-radius: 16px;
      border: 1px solid #e2e8f0;
      padding: 22px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    .logs-panel__header {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
    }
    .logs-panel__controls {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    select {
      border-radius: 8px;
      border: 1px solid #d0d5dd;
      padding: 10px 14px;
      font-size: 14px;
      background: white;
      appearance: none;
      -webkit-appearance: none;
      -moz-appearance: none;
      background-image: linear-gradient(45deg, transparent 50%, #1f2937 50%), linear-gradient(135deg, #1f2937 50%, transparent 50%);
      background-position: calc(100% - 18px) calc(50% - 3px), calc(100% - 12px) calc(50% - 3px);
      background-size: 6px 6px, 6px 6px;
      background-repeat: no-repeat;
      padding-right: 34px;
    }
    .table-wrapper {
      border: 1px solid #e2e8f0;
      border-radius: 12px;
      overflow: hidden;
      background: white;
    }
    table {
      width: 100%;
      border-collapse: collapse;
    }
    th, td {
      text-align: left;
      padding: 14px 16px;
      border-bottom: 1px solid #f1f5f9;
      vertical-align: top;
      font-size: 14px;
    }
    th {
      color: #475569;
      font-weight: 600;
      background: #f8fafc;
      text-transform: uppercase;
      font-size: 12px;
      letter-spacing: 0.06em;
    }
    .status-chip {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 600;
      text-transform: capitalize;
    }
    .status-chip.pending {
      background: #fff4cc;
      color: #b7791f;
    }
    .status-chip.active {
      background: #dcfce7;
      color: #166534;
    }
    .status-chip.inactive {
      background: #fee2e2;
      color: #b91c1c;
    }
    .person-cell {
      display: flex;
      align-items: center;
      gap: 14px;
    }
    .person-avatar {
      width: 48px;
      height: 48px;
      border-radius: 10px;
      overflow: hidden;
      background: linear-gradient(135deg, #cbd5f5, #f1f5f9);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      color: #334155;
      text-transform: uppercase;
    }
    .person-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .person-name {
      font-weight: 600;
      color: #111827;
      margin-bottom: 6px;
    }
    .person-meta {
      color: #64748b;
      font-size: 13px;
    }
    .contact-link {
      color: #2563eb;
      text-decoration: none;
      font-weight: 500;
    }
    .contact-link:hover {
      text-decoration: underline;
    }
    .user-detail-link {
      background: none;
      border: none;
      padding: 0;
      margin: 0;
      color: #2563eb;
      font-weight: 600;
      cursor: pointer;
    }
    .user-detail-link:hover {
      text-decoration: underline;
    }
    .filters-bar {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
      background: #f8fafc;
      border: 1px solid #e2e8f0;
      border-radius: 12px;
      padding: 14px 16px;
    }
    .filters-group {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
    }
    .filters-group input[type="search"] {
      min-width: 240px;
      border-radius: 8px;
      border: 1px solid #d0d5dd;
      padding: 10px 14px;
      font-size: 14px;
    }
    .filters-group select {
      border-radius: 8px;
      border: 1px solid #d0d5dd;
      padding: 10px 14px;
      font-size: 14px;
      background: white;
    }
    .table-actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    .table-actions button {
      padding: 8px 14px;
      font-size: 13px;
    }
    .table-actions button.action-primary {
      background: #22c55e;
    }
    .table-actions button.action-danger {
      background: #ef4444;
    }
    .table-actions button.action-secondary {
      background: #6b7280;
    }
    .pagination-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-top: 14px;
      padding: 12px 0;
      color: #475569;
      font-size: 14px;
    }
    .pagination-controls {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .pagination-controls button {
      padding: 8px 14px;
      font-size: 13px;
      background: #e2e8f0;
      color: #0f172a;
    }
    .pagination-controls button:disabled {
      opacity: 0.4;
      cursor: not-allowed;
      box-shadow: none;
      transform: none;
    }
    .modal {
      position: fixed;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 999;
    }
    .modal.hidden {
      display: none;
    }
    .modal-backdrop {
      position: absolute;
      inset: 0;
      background: rgba(15, 23, 42, 0.55);
      backdrop-filter: blur(2px);
    }
    .modal-dialog {
      position: relative;
      width: min(92vw, 880px);
      max-height: 90vh;
      overflow-y: auto;
      background: #ffffff;
      border-radius: 18px;
      box-shadow: 0 24px 60px rgba(15, 23, 42, 0.25);
      padding: 32px;
      z-index: 1;
    }
    .modal-close {
      position: absolute;
      top: 18px;
      right: 18px;
      background: rgba(15, 23, 42, 0.08);
      color: #0f172a;
      border: 1px solid rgba(15, 23, 42, 0.12);
      width: 36px;
      height: 36px;
      border-radius: 999px;
      font-size: 20px;
      line-height: 1;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.18s ease, transform 0.18s ease;
    }
    .modal-close:hover,
    .modal-close:focus-visible {
      background: rgba(15, 23, 42, 0.16);
      transform: scale(1.05);
      outline: none;
    }
    .modal-loading,
    .modal-error {
      padding: 18px;
      border-radius: 10px;
      margin-top: 12px;
    }
    .modal-loading {
      background: #f8fafc;
      color: #1f2937;
      border: 1px solid #e2e8f0;
    }
    .modal-error {
      background: #fee2e2;
      color: #b91c1c;
      border: 1px solid #fecaca;
    }
    .modal-content {
      display: flex;
      flex-direction: column;
      gap: 24px;
    }
    .user-form-dialog {
      width: min(92vw, 640px);
      max-height: 90vh;
      padding: 36px 36px 30px;
      border-radius: 22px;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    .user-form-dialog h3 {
      font-size: 26px;
      font-weight: 700;
      color: #0f172a;
      margin-bottom: 4px;
    }
    .user-form-society {
      font-size: 13px;
      color: #475569;
      margin-top: 2px;
      letter-spacing: 0.01em;
    }
    .user-form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 18px 20px;
      margin-top: 6px;
    }
    .user-form-field {
      display: flex;
      flex-direction: column;
      gap: 6px;
      width: 100%;
      margin-bottom: 12px;
    }
    .user-form-field label {
      font-size: 13px;
      font-weight: 600;
      color: #1f2937;
    }
    .user-form-field input,
    .user-form-field select {
      width: 100%;
      border: 1px solid #d0d5dd;
      border-radius: 10px;
      padding: 10px 12px;
      font-size: 14px;
      background: #ffffff;
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
      min-height: 44px;
      height: 44px;
      line-height: 24px;
      appearance: none;
      -webkit-appearance: none;
      -moz-appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg width='12' height='8' viewBox='0 0 12 8' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1.5L6 6.5L11 1.5' stroke='%2357636B' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 12px center;
      padding-right: 36px;
    }
    .user-form-field input:focus,
    .user-form-field select:focus {
      outline: none;
      border-color: #2563eb;
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.18);
    }
    .user-form-toggle {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
      font-size: 13px;
      color: #1f2937;
      padding: 10px 12px;
      border: 1px solid #e2e8f0;
      border-radius: 10px;
      background: #f8fafc;
      font-weight: 600;
      margin-top: 12px;
    }
    .user-form-toggle input[type="checkbox"] {
      width: auto;
      height: auto;
      margin: 0;
    }
    .user-form-expire-row.hidden {
      display: none !important;
    }
    .user-form-upload {
      border: 1px dashed rgba(37, 99, 235, 0.35);
      background: rgba(59, 130, 246, 0.08);
      border-radius: 14px;
      padding: 18px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      font-size: 13px;
      color: #475569;
      margin-top: 18px;
    }
    .user-form-upload input[type="file"] {
      border: none;
      padding: 0;
    }
    .user-form-note {
      margin: 0;
      font-size: 12px;
      color: #64748b;
    }
    .user-form-existing {
      display: flex;
      flex-direction: column;
      gap: 12px;
      border: 1px solid #e2e8f0;
      border-radius: 14px;
      padding: 18px;
      background: #f8fafc;
      margin-top: 18px;
    }
    .user-form-existing.hidden {
      display: none;
    }
    .user-form-existing-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 13px;
      color: #475569;
      font-weight: 600;
    }
    .user-form-existing-header span {
      font-weight: 500;
      color: #1d4ed8;
    }
    .user-form-existing-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
    }
    .user-form-existing-card {
      position: relative;
      width: 96px;
      height: 96px;
      border-radius: 12px;
      overflow: hidden;
      border: 1px solid rgba(148, 163, 184, 0.3);
      background: #f1f5f9;
      box-shadow: 0 6px 16px rgba(15, 23, 42, 0.12);
    }
    .user-form-existing-card img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }
    .user-form-existing-card.removed {
      border-color: #f87171;
    }
    .user-form-existing-card.removed img {
      filter: grayscale(1);
      opacity: 0.4;
    }
    .user-form-existing-placeholder {
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 28px;
      background: #f1f5f9;
      color: #475569;
    }
    .user-form-existing-toggle {
      position: absolute;
      left: 6px;
      top: 6px;
      padding: 4px 8px;
      font-size: 11px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      background: rgba(15, 23, 42, 0.82);
      color: #ffffff;
    }
    .user-form-existing-card.removed .user-form-existing-toggle {
      background: #dc2626;
    }
    .user-form-actions {
      display: flex;
      justify-content: flex-end;
      gap: 12px;
      margin-top: 6px;
      padding-top: 18px;
      border-top: 1px solid #e2e8f0;
    }
    .user-form-actions button.secondary {
      background: #6b7280;
    }
    .user-form-submit {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 20px;
      border-radius: 10px;
      font-weight: 600;
    }
    .user-form-submit .spinner {
      width: 18px;
      height: 18px;
      border-width: 2px;
    }
    @media (max-width: 640px) {
      .user-form-dialog {
        padding: 28px 22px 24px;
      }
      .user-form-grid {
        grid-template-columns: 1fr;
      }
      .user-form-actions {
        flex-direction: column-reverse;
        align-items: stretch;
      }
      .user-form-actions button {
        width: 100%;
      }
    }
    .user-detail-header {
      display: grid;
      grid-template-columns: minmax(0, 1fr) minmax(0, 1fr);
      gap: 20px;
      align-items: start;
    }
    .user-detail-header .user-detail-name {
      font-size: 24px;
      font-weight: 700;
      color: #0f172a;
      margin-bottom: 6px;
    }
    .user-detail-header .user-detail-meta {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 12px;
      font-size: 14px;
      color: #475569;
    }
    #user-detail-dialog {
      width: min(92vw, 720px);
    }
    .user-detail-gallery {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 12px;
    }
    .user-detail-gallery.empty {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      background: #f8fafc;
      border: 1px dashed #d8dee9;
      border-radius: 14px;
    }
    .user-detail-gallery-placeholder {
      font-size: 14px;
      color: #64748b;
      text-align: center;
      width: 100%;
    }
    .user-detail-gallery img {
      width: 100%;
      border-radius: 14px;
      box-shadow: 0 12px 24px rgba(15, 23, 42, 0.18);
      aspect-ratio: 1 / 1;
      object-fit: cover;
    }
    .user-detail-gallery figure {
      margin: 0;
    }
    .user-detail-gallery figcaption {
      margin-top: 6px;
      font-size: 13px;
      color: #475569;
      text-align: center;
    }
    .user-detail-gallery.empty {
      display: block;
      background: #f8fafc;
      border: 1px dashed #cbd5f5;
      border-radius: 14px;
      padding: 24px;
      text-align: center;
      color: #475569;
    }
    .user-detail-logs h4 {
      font-size: 18px;
      margin-bottom: 10px;
      color: #0f172a;
    }
    .detail-logs-table th,
    .detail-logs-table td {
      font-size: 13px;
      padding: 10px 12px;
    }
    .detail-logs-table td {
      color: #475569;
    }
    .custom-date-inputs {
      display: flex;
      gap: 8px;
      align-items: center;
    }
    .custom-date-inputs input[type="date"] {
      padding: 8px 12px;
      border: 1px solid #d0d5dd;
      border-radius: 6px;
      font-size: 14px;
      background: white;
    }
    .access-log-row {
      transition: background-color 0.2s ease;
    }
    .access-log-row:hover {
      background-color: #f8fafc;
    }
    .recognition-score {
      font-weight: 600;
    }
    .recognition-score.high {
      color: #16a34a;
    }
    .recognition-score.medium {
      color: #ca8a04;
    }
    .recognition-score.low {
      color: #dc2626;
    }
    .action-badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 600;
      text-transform: capitalize;
    }
    .action-badge.entry {
      background: #dcfce7;
      color: #166534;
    }
    .action-badge.exit {
      background: #fef3c7;
      color: #92400e;
    }
    .action-badge.access_granted {
      background: #dbeafe;
      color: #1e40af;
    }
    .action-badge.access_denied {
      background: #fee2e2;
      color: #991b1b;
    }
    .action-badge.authorized {
      background: #dcfce7;
      color: #166534;
    }
    .action-badge.unauthorized {
      background: #fee2e2;
      color: #991b1b;
    }
    .location-info {
      font-size: 13px;
      color: #6b7280;
    }
    .location-info .building {
      font-weight: 600;
      color: #374151;
    }
    .loading-logs {
      text-align: center;
      padding: 40px;
      color: #6b7280;
    }
    .loading-logs .spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 2px solid #e5e7eb;
      border-top: 2px solid #2a9df4;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-right: 8px;
    }
    @keyframes spin {
    }
    .face-thumbnail {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 50px;
      height: 50px;
      position: relative;
    }
    .thumbnail-img {
      width: 50px;
      height: 50px;
      object-fit: cover;
      border-radius: 8px;
      border: 2px solid #e5e7eb;
    }
    .no-thumbnail {
      width: 50px;
      height: 50px;
      background: #f3f4f6;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
    }
    .no-thumbnail-icon {
      font-size: 20px;
      color: #9ca3af;
      margin-bottom: 2px;
    }
    .no-thumbnail-text {
      font-size: 10px;
      color: #9ca3af;
      font-weight: 500;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    @keyframes shimmerSlide {
      0% { transform: translateX(-100%); }
      100% { transform: translateX(100%); }
    }

    @media (max-width: 768px) {
      .modal-dialog {
        width: min(94vw, 720px);
        padding: 24px;
      }
      .user-detail-header {
        grid-template-columns: 1fr;
      }
    }
    .section-heading h3 {
      font-size: 20px;
      margin-bottom: 6px;
    }
    .section-heading .small-label {
      color: #64748b;
    }
    .empty-state {
      background: #f8fafc;
      border: 1px dashed #cbd5f5;
      border-radius: 16px;
      padding: 32px;
      text-align: center;
      color: #475569;
      display: flex;
      flex-direction: column;
      gap: 14px;
      align-items: center;
    }
    .empty-state h4 {
      font-size: 20px;
      color: #1f2937;
    }
    footer {
      text-align: center;
      padding: 40px 20px;
      margin-top: 60px;
      background: #f1f5f9;
      color: #64748b;
      font-size: 14px;
    }
    @media (max-width: 992px) {
      .portal-body {
        grid-template-columns: 1fr;
      }
      .portal-nav {
        flex-direction: row;
        justify-content: space-between;
      }
      .portal-nav .nav-link {
        flex: 1;
        text-align: center;
      }
    }
    .custom-date-inputs {
      display: flex;
      gap: 8px;
      align-items: center;
    }
    .custom-date-inputs input[type="date"] {
      padding: 8px 12px;
      border: 1px solid #d0d5dd;
      border-radius: 6px;
      font-size: 14px;
      background: white;
    }
    .access-log-row {
      transition: background-color 0.2s ease;
    }
    .access-log-row:hover {
      background-color: #f8fafc;
    }
    .recognition-score {
      font-weight: 600;
    }
    .recognition-score.high {
      color: #16a34a;
    }
    .recognition-score.medium {
      color: #ca8a04;
    }
    .recognition-score.low {
      color: #dc2626;
    }
    .action-badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 600;
      text-transform: capitalize;
    }
    .action-badge.entry {
      background: #dcfce7;
      color: #166534;
    }
    .action-badge.exit {
      background: #fef3c7;
      color: #92400e;
    }
    .action-badge.access_granted {
      background: #dbeafe;
      color: #1e40af;
    }
    .action-badge.access_denied {
      background: #fee2e2;
      color: #991b1b;
    }
    .action-badge.authorized {
      background: #dcfce7;
      color: #166534;
    }
    .action-badge.unauthorized {
      background: #fee2e2;
      color: #991b1b;
    }
    .location-info {
      font-size: 13px;
      color: #6b7280;
    }
    .location-info .building {
      font-weight: 600;
      color: #374151;
    }
    .loading-logs {
      text-align: center;
      padding: 40px;
      color: #6b7280;
    }
    .loading-logs .spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 2px solid #e5e7eb;
      border-top: 2px solid #2a9df4;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-right: 8px;
    }
    @keyframes spin {
    }
    .face-thumbnail {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 50px;
      height: 50px;
      position: relative;
    }
    .thumbnail-img {
      width: 50px;
      height: 50px;
      object-fit: cover;
      border-radius: 8px;
      border: 2px solid #e5e7eb;
    }
    .no-thumbnail {
      width: 50px;
      height: 50px;
      background: #f3f4f6;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
    }
    .no-thumbnail-icon {
      font-size: 20px;
      color: #9ca3af;
      margin-bottom: 2px;
    }
    .no-thumbnail-text {
      font-size: 10px;
      color: #9ca3af;
      font-weight: 500;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    @keyframes shimmerSlide {
      0% { transform: translateX(-100%); }
      100% { transform: translateX(100%); }
    }

    @media (max-width: 768px) {
      header { padding: 0 20px; }
      .card { padding: 24px; }
      .portal-content { padding: 20px; }
      .portal-toolbar {
        flex-direction: column;
        align-items: flex-start;
      }
      table { display: block; overflow-x: auto; }
    }

    /* User Statistics Styles */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    
    .stat-card {
      background: white;
      border-radius: 12px;
      padding: 24px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
      display: flex;
      align-items: center;
      gap: 16px;
      position: relative;
      overflow: hidden;
      border-left: 4px solid #2a9df4;
    }

    .stat-card.loading > * {
      visibility: hidden;
    }

    .stat-card.loading::before,
    .stat-card.loading::after {
      content: "";
      position: absolute;
      inset: 0;
      pointer-events: none;
    }

    .stat-card.loading::before {
      background: #f3f4f6;
      opacity: 0.9;
      z-index: 1;
    }

    .stat-card.loading::after {
      background: linear-gradient(90deg, rgba(243, 244, 246, 0) 0%, rgba(209, 213, 219, 0.75) 50%, rgba(243, 244, 246, 0) 100%);
      transform: translateX(-100%);
      animation: shimmerSlide 1.4s ease-in-out infinite;
      z-index: 2;
    }
    
    .stat-icon {
      font-size: 32px;
      width: 60px;
      height: 60px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #f0f9ff;
      border-radius: 12px;
    }
    
    .stat-content {
      flex: 1;
    }
    
    .stat-number {
      font-size: 28px;
      font-weight: 700;
      color: #1f2937;
      line-height: 1;
      margin-bottom: 4px;
    }
    
    .stat-label {
      font-size: 14px;
      color: #6b7280;
      font-weight: 500;
    }
    
    .attendance-summary {
      background: white;
      border-radius: 12px;
      padding: 24px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
      display: flex;
      flex-wrap: wrap;
    }
    
    .attendance-summary h4 {
      margin: 0 0 20px 0;
      font-size: 18px;
      color: #1f2937;
    }
    
    .attendance-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 20px;
    }
    
    .attendance-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 16px;
      border-radius: 8px;
    }
    
    .attendance-item.present {
      background: #f0fdf4;
      border-left: 4px solid #22c55e;
    }
    
    .attendance-item.absent {
      background: #fef2f2;
      border-left: 4px solid #ef4444;
    }
    
    .attendance-item.total {
      background: #f0f9ff;
      border-left: 4px solid #2a9df4;
    }
    
    .attendance-icon {
      font-size: 24px;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .attendance-content {
      flex: 1;
    }
    
    .attendance-number {
      font-size: 20px;
      font-weight: 700;
      color: #1f2937;
      line-height: 1;
      margin-bottom: 2px;
    }
    
    .attendance-label {
      font-size: 12px;
      color: #6b7280;
      font-weight: 500;
    }
    
    /* Active Users Table Styles */
    .loading-users {
      text-align: center;
      padding: 40px;
      color: #6b7280;
    }
    
    .user-photo {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid #e5e7eb;
    }
    
    .no-photo {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: #f3f4f6;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #9ca3af;
      font-size: 16px;
      border: 2px solid #e5e7eb;
    }
    
    .access-expiry {
      font-size: 13px;
    }
    
    .access-expiry.forever {
      color: #059669;
      font-weight: 600;
    }
    
    .access-expiry.expired {
      color: #dc2626;
      font-weight: 600;
    }
    
    .access-expiry.expiring-soon {
      color: #d97706;
      font-weight: 600;
    }
    
    .access-expiry.valid {
      color: #059669;
    }
    
    /* Attendance Table Styles */
    .attendance-table-wrapper {
      background: white;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    }
    
    .loading-attendance {
      text-align: center;
      padding: 40px;
      color: #6b7280;
    }
    
    .attendance-percentage {
      font-weight: 600;
    }
    
    .attendance-percentage.high {
      color: #059669;
    }
    
    .attendance-percentage.medium {
      color: #d97706;
    }
    
    .attendance-percentage.low {
      color: #dc2626;
    }
    
    .last-login {
      font-size: 13px;
      color: #6b7280;
    }
    
    .last-login.recent {
      color: #059669;
    }
    
    .last-login.old {
      color: #dc2626;
    }
    
    /* Refresh Button */
    .refresh-btn {
      background: #10b981;
      color: white;
      border: none;
      border-radius: 6px;
      padding: 8px 16px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    
    .refresh-btn:hover {
      background: #059669;
    }
    
    /* Responsive adjustments */
    @media (max-width: 768px) {
      .stats-grid {
        grid-template-columns: 1fr;
      }
      
      .attendance-stats {
        grid-template-columns: 1fr;
      }
      
      .stat-card {
        padding: 16px;
      }
      
      .stat-icon {
        width: 50px;
        height: 50px;
        font-size: 24px;
      }
      
      .stat-number {
        font-size: 24px;
      }
    }


    /* User Attendance Section Styles */
    .user-info {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .user-thumbnail {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid #e5e7eb;
    }

    .user-thumbnail-placeholder {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background-color: #f3f4f6;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      border: 2px solid #e5e7eb;
    }

    .status-badge {
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 500;
      text-transform: uppercase;
    }

    .status-badge.status-active {
      background-color: #dcfce7;
      color: #166534;
    }

    .status-badge.status-inactive {
      background-color: #fee2e2;
      color: #991b1b;
    }

    .btn-small {
      padding: 4px 8px;
      font-size: 12px;
      border-radius: 4px;
      border: 1px solid #d1d5db;
      background-color: #ffffff;
      color: #374151;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-small:hover {
      background-color: #f9fafb;
      border-color: #9ca3af;
    }

    .log-entry {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 8px 12px;
      border: 1px solid #e5e7eb;
      border-radius: 6px;
      margin-bottom: 8px;
      background-color: #f9fafb;
    }

    .log-time {
      font-size: 12px;
      color: #6b7280;
      min-width: 140px;
    }

    .log-action {
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 500;
      text-transform: uppercase;
    }

    .log-action.entry,
    .log-action.access_granted,
    .log-action.authorized {
      background-color: #dcfce7;
      color: #166534;
    }

    .log-action.exit {
      background-color: #fef3c7;
      color: #92400e;
    }

    .log-camera {
      font-size: 12px;
      color: #374151;
      flex: 1;
    }

    .log-score {
      font-size: 11px;
      color: #6b7280;
    }

    .no-logs {
      text-align: center;
      color: #6b7280;
      font-style: italic;
      padding: 20px;
    }

    .attendance-summary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .attendance-summary h4 {
      color: white;
    }

    .attendance-summary p {
      color: rgba(255, 255, 255, 0.9);
    }

    .attendance-summary .small-label {
      color: rgba(255, 255, 255, 0.7);
    }

    
    /* User Attendance Section Styles */
    .user-info {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .user-thumbnail {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid #e5e7eb;
    }

    .user-thumbnail-placeholder {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background-color: #f3f4f6;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      border: 2px solid #e5e7eb;
    }

    .status-badge {
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 500;
      text-transform: uppercase;
    }

    .status-badge.status-active {
      background-color: #dcfce7;
      color: #166534;
    }

    .status-badge.status-inactive {
      background-color: #fee2e2;
      color: #991b1b;
    }

    .user-type-badge {
      padding: 2px 6px;
      border-radius: 8px;
      font-size: 11px;
      font-weight: 500;
      background-color: #f3f4f6;
      color: #374151;
      text-transform: capitalize;
    }

    .btn-small {
      padding: 4px 8px;
      font-size: 12px;
      border-radius: 4px;
      border: 1px solid #d1d5db;
      background-color: #ffffff;
      color: #374151;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-small:hover {
      background-color: #f9fafb;
      border-color: #9ca3af;
    }

    .log-entry {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 8px 12px;
      border: 1px solid #e5e7eb;
      border-radius: 6px;
      margin-bottom: 8px;
      background-color: #f9fafb;
    }

    .log-time {
      font-size: 12px;
      color: #6b7280;
      min-width: 140px;
    }

    .log-action {
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 500;
      text-transform: uppercase;
    }

    .log-action.entry,
    .log-action.access_granted,
    .log-action.authorized {
      background-color: #dcfce7;
      color: #166534;
    }

    .log-action.exit {
      background-color: #fef3c7;
      color: #92400e;
    }

    .log-camera {
      font-size: 12px;
      color: #374151;
      flex: 1;
    }

    .log-score {
      font-size: 11px;
      color: #6b7280;
    }

    .no-logs {
      text-align: center;
      color: #6b7280;
      font-style: italic;
      padding: 20px;
    }

    .loading-logs {
      text-align: center;
      padding: 40px;
      color: #6b7280;
    }

    .spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid #f3f3f3;
      border-top: 3px solid #3498db;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-right: 10px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Pagination styles */
    .pagination-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 20px;
      padding: 15px 0;
    }

    .pagination-controls {
      display: flex;
      gap: 10px;
    }

    .pagination-controls button {
      padding: 8px 16px;
      border: 1px solid #d1d5db;
      background-color: #ffffff;
      color: #374151;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .pagination-controls button:hover:not(:disabled) {
      background-color: #f9fafb;
      border-color: #9ca3af;
    }

    .pagination-controls button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* Filters bar improvements */
    .filters-bar {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      margin-bottom: 20px;
      padding: 15px;
      background-color: #f8fafc;
      border-radius: 8px;
      border: 1px solid #e2e8f0;
    }

    .filters-group {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .filters-group label {
      font-weight: 500;
      color: #374151;
      white-space: nowrap;
    }

    .filters-group input,
    .filters-group select {
      padding: 8px 12px;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      font-size: 14px;
    }

    .filters-group input:focus,
    .filters-group select:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    /* Visitor pass management */
    .visitor-grid {
      display: grid;
      grid-template-columns: minmax(0, 420px) minmax(0, 1fr);
      gap: 24px;
      align-items: start;
    }
    @media (max-width: 1024px) {
      .visitor-grid {
        grid-template-columns: 1fr;
      }
    }
    .visitor-form-card,
    .visitor-table-card {
      background: #ffffff;
      border: 1px solid #e5e7eb;
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 10px 30px rgba(148, 163, 184, 0.12);
    }
    .visitor-form .form-row {
      display: flex;
      gap: 16px;
      flex-wrap: wrap;
    }
    .visitor-form .form-field {
      flex: 1;
      display: flex;
      flex-direction: column;
      margin-bottom: 16px;
      min-width: 180px;
    }
    .visitor-form label {
      font-weight: 600;
      color: #1f2937;
      margin-bottom: 6px;
    }
    .visitor-form input,
    .visitor-form select,
    .visitor-form textarea {
      border: 1px solid #d1d5db;
      border-radius: 10px;
      padding: 10px 12px;
      font-size: 14px;
      color: #1f2937;
      background: #ffffff;
      transition: border-color 0.12s ease, box-shadow 0.12s ease;
    }
    .visitor-form input:focus,
    .visitor-form select:focus,
    .visitor-form textarea:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.18);
    }
    .visitor-form textarea {
      resize: vertical;
    }
    .checkbox-field {
      flex-direction: row !important;
      align-items: center;
      gap: 8px;
    }
    .checkbox-field input {
      width: auto;
      accent-color: #3b82f6;
    }
    .hint-text {
      font-size: 12px;
      color: #6b7280;
    }
    .visitor-form .form-actions {
      display: flex;
      gap: 12px;
      margin-top: 8px;
    }
    .visitor-form .form-actions button {
      flex: 1;
    }
    .visitor-pass-preview {
      margin-top: 24px;
      padding: 20px;
      border-radius: 12px;
      border: 1px dashed #93c5fd;
      background: #eff6ff;
    }
    .preview-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    .preview-content {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
      text-align: center;
    }
    .preview-code {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 16px;
    }
    .code-label {
      font-weight: 600;
      color: #1f2937;
    }
    .code-value {
      font-family: 'Inter', monospace;
      font-weight: 700;
      letter-spacing: 0.08em;
      color: #1f2937;
    }
    .preview-content img {
      width: 200px;
      height: 200px;
      object-fit: contain;
      background: #ffffff;
      border-radius: 12px;
      border: 1px solid #dbeafe;
      padding: 12px;
    }
    .preview-actions {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      justify-content: center;
    }
    .preview-meta {
      font-size: 13px;
      color: #1f2937;
    }
    .device-selector {
      display: flex;
      flex-direction: column;
      gap: 10px;
      padding: 12px;
      border: 1px solid #e2e8f0;
      border-radius: 10px;
      background: #f8fafc;
      max-height: 220px;
      overflow-y: auto;
    }
    .device-choices {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .device-option {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
      color: #1f2937;
    }
    .device-option input[type="checkbox"] {
      accent-color: #2563eb;
    }
    .link-button {
      background: none;
      border: none;
      color: #2563eb;
      font-weight: 600;
      cursor: pointer;
      padding: 0;
    }
    .link-button:hover {
      text-decoration: underline;
    }
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.45);
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 24px;
      z-index: 2000;
    }
    .modal-overlay.hidden {
      display: none;
    }
    .visitor-preview-modal {
      max-width: 420px;
      width: 100%;
      background: #ffffff;
      border-radius: 18px;
      padding: 24px;
      box-shadow: 0 25px 60px rgba(15, 23, 42, 0.25);
      position: relative;
    }
    .visitor-preview-modal .modal-close {
      position: absolute;
      top: 14px;
      right: 14px;
      background: none;
      border: none;
      font-size: 28px;
      line-height: 1;
      cursor: pointer;
      color: #1f2937;
    }
    .visitor-preview-modal .modal-close:hover {
      color: #dc2626;
    }
    .visitor-table-card .table-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 18px;
      gap: 12px;
    }
    .visitor-table-card .table-actions {
      display: flex;
      gap: 12px;
      align-items: center;
    }
    .visitor-table-card .table-wrapper {
      overflow: auto;
      max-height: 360px;
    }
    .visitor-table-card .table-wrapper table {
      min-width: 720px;
    }
    .visitor-table-card select {
      border-radius: 8px;
      padding: 8px 12px;
      border: 1px solid #d1d5db;
      background: #ffffff;
    }
    .visitor-action-buttons {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      justify-content: center;
    }
    .visitor-action-buttons .danger {
      background: #fee2e2;
      color: #b91c1c;
      border: 1px solid rgba(248, 113, 113, 0.5);
    }
    .visitor-action-buttons .danger:hover {
      background: #fecaca;
    }
    .badge {
      display: inline-flex;
      align-items: center;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 600;
      text-transform: capitalize;
    }
    .badge.active {
      background: rgba(34, 197, 94, 0.16);
      color: #166534;
    }
    .badge.expired {
      background: rgba(248, 113, 113, 0.16);
      color: #991b1b;
    }
    .badge.used,
    .badge.revoked {
      background: rgba(249, 115, 22, 0.16);
      color: #92400e;
    }
</style>
</head>
<body>
  <header>
    <div class="logo">
      <a href="index.html"><img src="https://storage.googleapis.com/gateomi-static-data/logo.png" alt="Gateomi Logo"></a>
    </div>
    <nav>
      <a href="index.html">Home</a>
      <a href="register.html">Register User</a>
      <a href="login.html" id="admin-login-link">Admin Login</a>
      <div id="admin-profile" class="admin-profile hidden">
        <span class="admin-info">
          <span id="admin-name">Admin</span>
          <span id="admin-society">Society</span>
        </span>
        <button id="header-logout" class="logout-btn">Logout</button>
      </div>
    </nav>
  </header>

  <main class="page-shell">
    <section id="portal" class="portal card">
      <div class="portal-toolbar">
        <div>
          <h2>Society Operations Console</h2>
          <p id="society-subtitle" class="small-label"></p>
        </div>
        <div class="toolbar-actions" style="display:flex; gap:12px;">
          <!-- <button id="refresh-button" class="secondary" type="button">Refresh Data</button> -->
          <!-- <button id="logout-button" type="button">Log out</button> -->
        </div>
      </div>
      <div id="dashboard-feedback" class="feedback hidden"></div>
      <div class="portal-body">
        <nav class="portal-nav">
          <button class="nav-link active" data-section="overview-section">Dashboard</button>
          <button class="nav-link" data-section="users-section">Society Users</button>
          <button class="nav-link" data-section="user-attendance-section">User Attendance</button>
          <button class="nav-link" data-section="access-logs-section">Access Logs</button>
          
          <button class="nav-link" data-section="visitors-section">Visitor Passes</button>
          
          
          
        </nav>
        <div class="portal-content">
          <section id="overview-section" class="portal-section active">
            <div class="summary-grid" id="summary-grid"></div>

            <!-- Society User Statistics -->
            <div class="section-heading" style="margin-top: 30px;">
              <h3>Society Users</h3>
              <p class="small-label">Overview of user registrations and today's attendance.</p>
            </div>
            <div class="stats-grid" id="user-stats-grid">
              <div class="stat-card">
                <h4>Total Users</h4>
                <p id="total-users-count">0</p>
              </div>
              <div class="stat-card">
                <h4>Active Users</h4>
                <p id="active-users-count">0</p>
              </div>
              <div class="stat-card">
                <h4>Inactive Users</h4>
                <p id="inactive-users-count">0</p>
              </div>
              <div class="stat-card">
                <h4>Approval Pending Users</h4>
                <p id="pending-users-count">0</p>
              </div>
              <div class="stat-card attendance-summary">
                <h4>Today's Attendance</h4>
                <p>Present: <span id="today-present-count">0</span></p>
                <p>Absent: <span id="today-absent-count">0</span></p>
                <!-- <p class="small-label">Total Active: <span id="today-total-active">0</span></p> -->
              </div>
            </div>

            <div class="charts-grid" id="overview-charts">
              <div class="chart-card">
                <div class="chart-card__title">Users by Status</div>
                <canvas id="users-status-chart" aria-label="Users by status chart" role="img"></canvas>
              </div>
              <div class="chart-card">
                <div class="chart-card__title">Today's Attendance</div>
                <canvas id="attendance-chart" aria-label="Today's attendance chart" role="img"></canvas>
              </div>
              <div class="chart-card">
                <div class="chart-card__title">Daily Entry Trend</div>
                <canvas id="daily-entry-chart" aria-label="Daily entry trend chart" role="img"></canvas>
              </div>
              <div class="chart-card">
                <div class="chart-card__title">Top Active Members</div>
                <canvas id="top-users-chart" aria-label="Top active members chart" role="img"></canvas>
                <p class="chart-card__caption" id="top-users-chart-caption"></p>
              </div>
            </div>

            <!-- Working Days Section -->
            <div class="section-heading" style="margin-top: 40px;">
              <h3>User Working Days Summary</h3>
              <p class="small-label">View total working days for each user over different time periods.</p>
            </div>
            
            <!-- Filters Bar -->
            <div class="filters-bar">
              <div class="filters-group">
                <label for="working-days-period">Time Period:</label>
                <select id="working-days-period">
                  <option value="today" selected>Today</option>
                  <option value="tomorrow">Tomorrow</option>
                  <option value="this_week">This Week</option>
                  <option value="this_month">This Month</option>
                  <option value="custom">Custom Range</option>
                </select>
                <div id="working-days-custom-date" class="custom-date-inputs hidden">
                  <input type="date" id="working-days-date-from" />
                  <input type="date" id="working-days-date-to" />
                </div>
              </div>
              <div class="filters-group">
                <input type="search" id="working-days-search" placeholder="Search by name, flat, mobile..." />
                <select id="working-days-status-filter">
                  <option value="">All Status</option>
                  <option value="active">Active</option>
                  <option value="inactive">Inactive</option>
                  <option value="pending">Pending</option>
                </select>
                <select id="working-days-page-size">
                  <option value="10" selected>10 / page</option>
                  <option value="25">25 / page</option>
                  <option value="50">50 / page</option>
                  <option value="100">100 / page</option>
                  <option value="150">150 / page</option>
                </select>
                <button id="working-days-load-btn" type="button">Load Data</button>
                <button id="working-days-refresh-btn" class="refresh-btn" type="button">Refresh</button>
                <button id="working-days-download-btn" class="secondary" type="button">Download Excel</button>
              </div>
            </div>

            <!-- Working Days Table -->
            <div class="table-wrapper">
              <table>
                <thead>
                  <tr>
                    <th>Person</th>
                    <th>Contact</th>
                    <th>Type</th>
                    <th>Status</th>
                    <th>Working Days</th>
                    <th>Total Entries</th>
                    <th>First Access</th>
                    <th>Last Access</th>
                  </tr>
                </thead>
                <tbody id="working-days-table-body">
                  <tr>
                    <td colspan="8" style="text-align: center; padding: 40px; color: #6b7280;">
                      Select a time period and click "Load Data" to view working days summary
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
            
            <!-- Pagination -->
            <div class="pagination-bar">
              <span id="working-days-pagination-info">No users to display.</span>
              <div class="pagination-controls">
                <button id="working-days-prev" type="button">Prev</button>
                <button id="working-days-next" type="button">Next</button>
              </div>
            </div>          </section>
          <section id="access-logs-section" class="portal-section">
            <div class="section-heading">
              <h3>Access Logs</h3>
              <p class="small-label">View and filter authorized person access logs from all cameras.</p>
            </div>
            
            <!-- Filters Bar -->
            <div class="filters-bar">
              <div class="filters-group">
                <input type="search" id="logs-username-search" placeholder="Search by username" />
                <select id="logs-camera-filter">
                  <option value="">All cameras</option>
                </select>
                <select id="logs-action-filter">
                  <option value="">All actions</option>
                </select>
                <select id="logs-date-range">
                  <option value="1">Last 1 day</option>
                  <option value="7">Last 7 days</option>
                  <option value="15">Last 15 days</option>
                  <option value="30" selected>Last 30 days</option>
                  <option value="90">Last 3 months</option>
                  <option value="180">Last 6 months</option>
                  <option value="365">Last 1 year</option>
                  <option value="custom">Custom date range</option>
                </select>
                <div id="custom-date-range" class="custom-date-inputs hidden">
                  <input type="date" id="logs-date-from" />
                  <input type="date" id="logs-date-to" />
                </div>
              </div>
              <div class="filters-group">
                <select id="logs-page-size">
                  <option value="25">25 / page</option>
                  <option value="50" selected>50 / page</option>
                  <option value="100">100 / page</option>
                </select>
                <button id="logs-apply-filters" type="button">Apply Filters</button>
                <button id="logs-clear-filters" class="secondary" type="button">Clear</button>
              </div>
            </div>
            
            <!-- Logs Table -->
            <div class="table-wrapper">
              <table>
                <thead>
                  <tr>
                    <th>Face</th>
                    <th>Timestamp</th>
                    <th>Person</th>
                    <th>Camera</th>
                    <th>Action</th>
                    <th>Recognition Score</th>
                  </tr>
                </thead>
                <tbody id="access-logs-table-body"></tbody>
              </table>
            </div>
            
            <!-- Pagination -->
            <div class="pagination-bar">
              <span id="access-logs-pagination-info">Loading logs...</span>
              <div class="pagination-controls">
                <button id="access-logs-prev" type="button">Prev</button>
                <button id="access-logs-next" type="button">Next</button>
              </div>
            </div>
          </section>
          <section id="visitors-section" class="portal-section">
            <div class="section-heading">
              <h3>Visitor Passes</h3>
              <p class="small-label">Generate QR codes and access codes for visitors and track their status.</p>
            </div>
            <div class="visitor-grid">
    <div class="visitor-form-card">
      <form id="visitor-pass-form" class="visitor-form">
                  <div class="form-row">
                    <div class="form-field">
                      <label for="visitor-name-input">Visitor Name</label>
                      <input type="text" id="visitor-name-input" required placeholder="Full name" />
                    </div>
                    <div class="form-field">
                      <label for="visitor-contact-input">Contact Number</label>
                      <input type="tel" id="visitor-contact-input" placeholder="Optional" />
                    </div>
                  </div>
                  <div class="form-row">
                    <div class="form-field">
                      <label for="visitor-purpose-input">Purpose</label>
                      <input type="text" id="visitor-purpose-input" placeholder="e.g. Delivery, Guest" />
                    </div>
                    <div class="form-field">
                      <label for="visitor-host-input">Host Name</label>
                      <input type="text" id="visitor-host-input" placeholder="Resident or company name" readonly />
                    </div>
                  </div>
                  <div class="form-row">
                    <div class="form-field">
                      <label for="visitor-tower-input">Tower / Building</label>
                      <input type="text" id="visitor-tower-input" placeholder="Optional" />
                    </div>
                    <div class="form-field">
                      <label for="visitor-flat-input">Flat / Unit</label>
                      <input type="text" id="visitor-flat-input" placeholder="Optional" />
                    </div>
                  </div>
                  <div class="form-row">
                    <div class="form-field">
                      <label for="visitor-validity-select">Validity</label>
                      <select id="visitor-validity-select">
                        <option value="30">30 minutes</option>
                        <option value="60">1 hour</option>
                        <option value="240">4 hours</option>
                        <option value="720">12 hours</option>
                        <option value="1440">1 day</option>
                        <option value="4320">3 days</option>
                        <option value="10080">7 days</option>
                        <option value="43200">30 days</option>
                        <option value="custom">Custom range</option>
                      </select>
                    </div>
                    <div class="form-field">
                      <label for="visitor-max-uses-input">Max Entries</label>
                      <input type="number" id="visitor-max-uses-input" min="1" placeholder="1" />
                    </div>
                  </div>
                  <div id="visitor-custom-range" class="form-row hidden">
                    <div class="form-field">
                      <label for="visitor-custom-start">Valid From</label>
                      <input type="datetime-local" id="visitor-custom-start" />
                    </div>
                    <div class="form-field">
                      <label for="visitor-custom-end">Valid Until</label>
                      <input type="datetime-local" id="visitor-custom-end" />
                    </div>
                  </div>
                  <div class="form-field checkbox-field">
                    <label>
                      <input type="checkbox" id="visitor-allow-multiple" />
                      Allow multiple entries
                    </label>
                    <span class="hint-text">If unchecked, the pass expires after the first successful scan.</span>
                  </div>
                  <div class="form-field">
                    <label for="visitor-device-all">Allowed Gates</label>
                    <div class="device-selector">
                      <label class="device-option">
                        <input type="checkbox" id="visitor-device-all" checked />
                        <span>All gates</span>
                      </label>
                      <div id="visitor-device-list" class="device-choices"></div>
                    </div>
                    <span class="hint-text">Uncheck "All gates" to select specific entry points for this pass.</span>
                  </div>
                  <div class="form-field">
                    <label for="visitor-notes-input">Notes for security</label>
                    <textarea id="visitor-notes-input" rows="3" placeholder="Optional instructions for guards"></textarea>
                  </div>
                  <div id="visitor-form-feedback" class="feedback hidden"></div>
                  <div class="form-actions">
                    <button type="submit">Generate Visitor Pass</button>
                    <button type="button" id="visitor-reset-form" class="secondary">Clear</button>
                  </div>
      </form>
    </div>
              <div class="visitor-table-card">
                <div class="table-header">
                  <div>
                    <h4>Existing Passes</h4>
                    <p class="small-label">Codes expire automatically at the selected time.</p>
                  </div>
                  <div class="table-actions">
                    <select id="visitor-status-filter">
                      <option value="">All statuses</option>
                      <option value="active">Active</option>
                      <option value="used">Used</option>
                      <option value="expired">Expired</option>
                      <option value="revoked">Revoked</option>
                    </select>
                    <button type="button" id="refresh-visitor-passes" class="secondary">Refresh</button>
                  </div>
                </div>
                <div class="table-wrapper">
                  <table>
                    <thead>
                      <tr>
                        <th>Visitor</th>
                        <th>Code</th>
                        <th>Status</th>
                        <th>Valid Until</th>
                        <th>Allowed Gates</th>
                        <th>Entries</th>
                        <th>Actions</th>
                      </tr>
                    </thead>
                    <tbody id="visitor-pass-table-body">
                      <tr>
                        <td colspan="6" style="text-align: center; padding: 32px; color: #6b7280;">
                          No passes yet. Generate one to get started.
                        </td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </section>
          <section id="users-section" class="portal-section">
          
            <div class="section-heading">
              <h3>Society Users</h3>
              <p class="small-label">Manage and view all registered society users.</p>
            </div>
            
            <!-- Filters Bar -->
            <div class="filters-bar">
              <div class="filters-group">
                <input type="search" id="users-search" placeholder="Search by name, flat, mobile..." />
                <select id="users-status-filter">
                  <option value="">All Status</option>
                  <option value="active">Active</option>
                  <option value="inactive">Inactive</option>
                  <option value="pending">Pending</option>
                </select>
                <select id="users-type-filter">
                  <option value="">All Types</option>
                  <option value="resident">Resident</option>
                  <option value="maid">Maid</option>
                  <option value="labor">Labor</option>
                  <option value="security">Security</option>
                  <option value="maintenance staff">Maintenance Staff</option>
                  <option value="housekeeping staff">Housekeeping Staff</option>
                  <option value="mali">Mali</option>
                </select>
                <select id="users-page-size">
                  <option value="10">10 / page</option>
                  <option value="25" selected>25 / page</option>
                  <option value="50">50 / page</option>
                  <option value="100">100 / page</option>
                </select>
              </div>
              <div class="filters-group">
                <button id="users-apply-filters" type="button">Apply Filters</button>
                <button id="users-clear-filters" class="secondary" type="button">Clear</button>
                <button id="users-refresh" class="refresh-btn" type="button">Refresh</button>
                <button id="users-add" type="button">Add User</button>
              </div>
            </div>

            <!-- Users Table -->
            <div class="table-wrapper">
              <table>
                <thead>
                  <tr>
                    <th>Person</th>
                    <th>Contact</th>
                    <th>Type</th>
                    <th>Status</th>
                    <th>Access Expiry</th>
                    <th>Registered On</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="users-table-body">
                  <tr>
                    <td colspan="7" style="text-align: center; padding: 40px; color: #6b7280;">
                      <div class="spinner"></div> Loading users...
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
            
            <!-- Pagination -->
            <div class="pagination-bar">
              <span id="users-pagination-info">Loading...</span>
              <div class="pagination-controls">
                <button id="users-prev" type="button">Prev</button>
                <button id="users-next" type="button">Next</button>
              </div>
            </div>

          </section>

          <!-- User Attendance Section -->
          <section id="user-attendance-section" class="portal-section">
            <div class="section-heading">
              <h3>User Attendance</h3>
              <p class="small-label">View daily attendance status and entry logs for all society users.</p>
            </div>
            
            <!-- Date Selection and Filters -->
            <div class="filters-bar">
              <div class="filters-group">
                <label for="attendance-date">Select Date:</label>
                <input type="date" id="attendance-date" />
                <button id="load-attendance-btn" class="primary">Load Attendance</button>
                <button id="refresh-attendance-btn" class="secondary">Refresh</button>
              </div>
              <div class="filters-group">
                <input type="search" id="attendance-search" placeholder="Search by name, flat, mobile..." />
                <select id="attendance-status-filter">
                  <option value="all">All Status</option>
                  <option value="present">Present</option>
                  <option value="absent">Absent</option>
                </select>
                <select id="attendance-user-type-filter">
                  <option value="all">All Types</option>
                  <option value="resident">Resident</option>
                  <option value="maid">Maid</option>
                  <option value="labor">Labor</option>
                  <option value="security">Security</option>
                  <option value="maintenance staff">Maintenance Staff</option>
                  <option value="housekeeping staff">Housekeeping Staff</option>
                  <option value="mali">Mali</option>
                </select>
                <select id="attendance-page-size">
                  <option value="10" selected>10 / page</option>
                  <option value="25">25 / page</option>
                  <option value="50">50 / page</option>
                  <option value="100">100 / page</option>
                </select>
              </div>
            </div>

            <!-- Attendance Summary -->
            <div class="stats-grid" id="attendance-stats-grid">
              <div class="stat-card">
                <h4>Total Users</h4>
                <p id="attendance-total-users">0</p>
              </div>
              <div class="stat-card">
                <h4>Present</h4>
                <p id="attendance-present-count">0</p>
              </div>
              <div class="stat-card">
                <h4>Absent</h4>
                <p id="attendance-absent-count">0</p>
              </div>
              <div class="stat-card">
                <h4>Attendance %</h4>
                <p id="attendance-percentage">0%</p>
              </div>
            </div>

            <!-- User List with Attendance -->
            <div class="table-wrapper">
              <table>
                <thead>
                  <tr>
                    <th>Person</th>
                    <th>Contact</th>
                    <th>Type</th>
                    <th>Status</th>
                    <th>All Entry Times</th>
                    <th>Total Entries</th>
                    <th>Total Logs</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="attendance-table-body">
                  <tr>
                    <td colspan="8" style="text-align: center; padding: 40px; color: #6b7280;">
                      Select a date and click "Load Attendance" to view user attendance
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
            
            <!-- Pagination -->
            <div class="pagination-bar">
              <span id="attendance-pagination-info">No users to display.</span>
              <div class="pagination-controls">
                <button id="attendance-prev" type="button">Prev</button>
                <button id="attendance-next" type="button">Next</button>
              </div>
            </div>
          </section>
        </div>
      </div>
    </section>
  </main>
  <footer>
     <span id="year"></span> Gateomi. All rights reserved.
  </footer>
  <div id="user-form-overlay" class="modal hidden">
    <div class="modal-backdrop" data-close-user-form="true"></div>
    <div class="modal-dialog user-form-dialog">
      <button class="modal-close" type="button" data-close-user-form="true" aria-label="Close user form">&times;</button>
      <form id="user-form" novalidate>
        <div>
          <h3 id="user-form-title">Register New User</h3>
          <p class="user-form-society" id="user-form-society"></p>
        </div>
        <div id="user-form-error" class="modal-error hidden"></div>
        <div class="user-form-grid">
          <div class="user-form-field">
            <label for="user-form-name">Full Name</label>
            <input type="text" id="user-form-name" name="name" placeholder="e.g. Riya Sharma" required />
          </div>
          <div class="user-form-field">
            <label for="user-form-mobile">Mobile Number</label>
            <input type="tel" id="user-form-mobile" name="mobile_number" placeholder="10-digit mobile" required />
          </div>
          <div class="user-form-field">
            <label for="user-form-type">User Type</label>
            <select id="user-form-type" name="user_type" required>
              <option value="">Select type</option>
              <option value="resident">Resident</option>
              <option value="maintenance staff">Maintenance Staff</option>
              <option value="housekeeping staff">Housekeeping Staff</option>
              <option value="security">Security</option>
              <option value="labor">Labor</option>
              <option value="maid">Maid</option>
              <option value="mali">Mali</option>
            </select>
          </div>
          <div class="user-form-field">
            <label for="user-form-tower">Tower</label>
            <input type="text" id="user-form-tower" name="tower_name" placeholder="Optional unless resident" />
          </div>
          <div class="user-form-field">
            <label for="user-form-flat">Flat Number</label>
            <input type="text" id="user-form-flat" name="flat_number" placeholder="Required for residents" />
          </div>
        </div>
        <div class="user-form-field">
          <label class="user-form-toggle">
            <input type="checkbox" id="user-form-forever" name="forever_access" />
            Grant forever access (no expiry)
          </label>
        </div>
        <div class="user-form-field user-form-expire-row" id="user-form-expire-row">
          <label for="user-form-expire">Access expiry date</label>
          <input type="date" id="user-form-expire" name="expire_at" />
        </div>
        <div class="user-form-existing hidden" id="user-form-existing">
          <div class="user-form-existing-header">
            <strong>Existing Images</strong>
            <span id="user-form-existing-count"></span>
          </div>
          <div class="user-form-existing-grid" id="user-form-existing-grid"></div>
          <p class="user-form-note">Select images to remove before saving.</p>
        </div>
        <div class="user-form-upload" id="user-form-images-row">
          <div><strong>Face Images</strong></div>
          <p class="user-form-note">Upload up to 6 clear face photos (use high quality images for best accuracy).</p>
          <input type="file" id="user-form-images" accept="image/*" multiple />
        </div>
        <div class="user-form-actions">
          <button type="button" class="secondary" id="user-form-cancel">Cancel</button>
          <button type="submit" id="user-form-submit" class="user-form-submit">
            <span class="spinner hidden" id="user-form-submit-spinner"></span>
            <span id="user-form-submit-text">Register User</span>
          </button>
        </div>
      </form>
    </div>
  </div>

  <div id="user-detail-overlay" class="modal hidden">
    <div class="modal-backdrop" data-close-detail="true"></div>
    <div class="modal-dialog" id="user-detail-dialog">
      <button class="modal-close" id="user-detail-close" aria-label="Close user detail">&times;</button>
      <div id="user-detail-loading" class="modal-loading">Loading user details</div>
      <div id="user-detail-error" class="modal-error hidden"></div>
      <div id="user-detail-content" class="modal-content hidden">
        <div class="user-detail-header" id="user-detail-info"></div>
        <div class="user-detail-gallery" id="user-detail-gallery"></div>
        <div class="user-detail-logs">
          <h4>Daily Access Summary</h4>
          <div class="table-wrapper">
            <table class="detail-logs-table">
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Total Logs</th>
                  <th>Entries</th>
                  <th>Exits</th>
                  <th>First Entry</th>
                  <th>Last Exit</th>
                </tr>
              </thead>
              <tbody id="user-detail-logs-body"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
<script>
    // const backend_url = "http://localhost:8000";
    const backend_url =  "https://gateomi-backend-647776055629.asia-south2.run.app";

    const tokenStorageKey = 'gateomiAdminToken';
    const profileStorageKey = 'gateomiAdminProfile';
    const gcsBucketName = 'gateomi-data';

    // Get all DOM elements
    const portalSection = document.getElementById('portal');
    const dashboardFeedback = document.getElementById('dashboard-feedback');
    const summaryGrid = document.getElementById('summary-grid');
    // const refreshButton = document.getElementById('refresh-button');
    // const logoutButton = document.getElementById('logout-button');
    const societySubtitle = document.getElementById('society-subtitle');
    const navButtons = document.querySelectorAll('.portal-nav .nav-link');
    const portalSections = document.querySelectorAll('.portal-section');

    // Access Logs elements
    const logsDateRange = document.getElementById('logs-date-range');
    if (!logsDateRange) {
      console.warn('logsDateRange element not found');
    }
    const logsUsernameSearch = document.getElementById('logs-username-search');
    const logsCameraFilter = document.getElementById('logs-camera-filter');
    const logsActionFilter = document.getElementById('logs-action-filter');
    const customDateRange = document.getElementById('custom-date-range');
    const logsDateFrom = document.getElementById('logs-date-from');
    const logsDateTo = document.getElementById('logs-date-to');
    const logsPageSize = document.getElementById('logs-page-size');
    const logsApplyFilters = document.getElementById('logs-apply-filters');
    const logsClearFilters = document.getElementById('logs-clear-filters');
    const accessLogsTableBody = document.getElementById('access-logs-table-body');
    const accessLogsPaginationInfo = document.getElementById('access-logs-pagination-info');
    const accessLogsPrevButton = document.getElementById('access-logs-prev');
    const accessLogsNextButton = document.getElementById('access-logs-next');

    // User detail modal elements
    const userDetailOverlay = document.getElementById('user-detail-overlay');
    const userDetailLoading = document.getElementById('user-detail-loading');
    const userDetailError = document.getElementById('user-detail-error');
    const userDetailContent = document.getElementById('user-detail-content');
    const userDetailInfo = document.getElementById('user-detail-info');
    const userDetailGallery = document.getElementById('user-detail-gallery');
    const userDetailLogsBody = document.getElementById('user-detail-logs-body');
    const userDetailCloseButton = document.getElementById('user-detail-close');
    const userDetailBackdrop = userDetailOverlay ? userDetailOverlay.querySelector('[data-close-detail="true"]') : null;

    // Visitor pass elements
    const visitorPassForm = document.getElementById('visitor-pass-form');
    const visitorNameInput = document.getElementById('visitor-name-input');
    const visitorContactInput = document.getElementById('visitor-contact-input');
    const visitorPurposeInput = document.getElementById('visitor-purpose-input');
    const visitorHostInput = document.getElementById('visitor-host-input');
    const visitorTowerInput = document.getElementById('visitor-tower-input');
    const visitorFlatInput = document.getElementById('visitor-flat-input');
    const visitorValiditySelect = document.getElementById('visitor-validity-select');
    const visitorMaxUsesInput = document.getElementById('visitor-max-uses-input');
    const visitorCustomRange = document.getElementById('visitor-custom-range');
    const visitorCustomStart = document.getElementById('visitor-custom-start');
    const visitorCustomEnd = document.getElementById('visitor-custom-end');
    const visitorAllowMultiple = document.getElementById('visitor-allow-multiple');
    const visitorNotesInput = document.getElementById('visitor-notes-input');
    const visitorFormFeedback = document.getElementById('visitor-form-feedback');
    const visitorResetFormBtn = document.getElementById('visitor-reset-form');
    const visitorPassPreview = document.getElementById('visitor-pass-preview');
    const visitorPassCodeEl = document.getElementById('visitor-pass-code');
    const visitorPassQrEl = document.getElementById('visitor-pass-qr');
    const visitorCopyCodeBtn = document.getElementById('visitor-copy-code');
    const visitorDownloadQrBtn = document.getElementById('visitor-download-qr');
    const visitorClosePreviewBtn = document.getElementById('visitor-close-preview');
    const visitorRefreshPassBtn = document.getElementById('visitor-refresh-pass');
    const visitorPreviewMeta = document.getElementById('visitor-preview-meta');
    const visitorDeviceSelectAll = document.getElementById('visitor-device-all');
    const visitorDeviceList = document.getElementById('visitor-device-list');
    const visitorStatusFilter = document.getElementById('visitor-status-filter');
    const refreshVisitorPassesBtn = document.getElementById('refresh-visitor-passes');
    const visitorTableBody = document.getElementById('visitor-pass-table-body');

    let currentToken = null;
    // User Statistics elements
    const userStatsGrid = document.getElementById('user-stats-grid');
    const userStatsCards = userStatsGrid ? Array.from(userStatsGrid.querySelectorAll('.stat-card')) : [];
    const totalUsersCount = document.getElementById('total-users-count');
    const activeUsersCount = document.getElementById('active-users-count');
    const inactiveUsersCount = document.getElementById('inactive-users-count');
    const pendingUsersCount = document.getElementById('pending-users-count');
    const todayPresentCount = document.getElementById('today-present-count');
    const todayAbsentCount = document.getElementById('today-absent-count');
    const usersStatusChartCanvas = document.getElementById('users-status-chart');
    const attendanceChartCanvas = document.getElementById('attendance-chart');
    const dailyEntryChartCanvas = document.getElementById('daily-entry-chart');
    const topUsersChartCanvas = document.getElementById('top-users-chart');
    const topUsersChartCaption = document.getElementById('top-users-chart-caption');
    // const todayTotalActive = document.getElementById('today-total-active');


    // User management state variables

    let currentProfile = null;
    let currentLogsPage = 1;
    let currentLogsPageSize = 50;
    let currentLogsData = null;
    let visitorPasses = [];
    let visitorDevices = [];
    let visitorDeviceMap = {};
    let isSubmittingVisitor = false;
    let currentVisitorPreview = null;
    let usersStatusChartInstance = null;
    let attendanceBarChartInstance = null;
    let dailyEntryChartInstance = null;
    let topUsersChartInstance = null;
    let overviewAnalyticsLoaded = false;
    const OVERVIEW_ANALYTICS_LOOKBACK_DAYS = 14;
    const chartPalette = {
      active: '#34d399',
      inactive: '#94a3b8',
      pending: '#fbbf24',
      present: '#22c55e',
      absent: '#ef4444',
      fallback: '#d1d5db',
      primary: '#2a9df4',
      accent: '#7f5af0'
    };
    const MAX_USER_IMAGES = 6;

    const yearElement = document.getElementById('year');
    if (yearElement) {
      yearElement.textContent = new Date().getFullYear();
    }

    function setUserStatsLoading(isLoading) {
      if (!userStatsGrid || !userStatsCards.length) {
        return;
      }

      if (isLoading) {
        userStatsGrid.setAttribute('aria-busy', 'true');
      } else {
        userStatsGrid.removeAttribute('aria-busy');
      }

      userStatsCards.forEach(card => {
        card.classList.toggle('loading', isLoading);
      });
    }

    function showElement(el) {
      el.classList.remove('hidden');
    }

    function hideElement(el) {
      el.classList.add('hidden');
    }

    function showFeedback(el, message, type = 'error') {
      el.textContent = message;
      el.classList.remove('hidden', 'error', 'success');
      el.classList.add('feedback', type);
    }

    function clearFeedback(el) {
      el.classList.add('hidden');
      el.textContent = '';
    }

    function activateSection(targetId) {
      portalSections.forEach(section => {
        section.classList.toggle('active', section.id === targetId);
      });
      navButtons.forEach(button => {
        button.classList.toggle('active', button.dataset.section === targetId);
      });
      
      if (targetId === "access-logs-section" && !currentLogsData) {
        loadAccessLogs();
      }
      loadSectionData(targetId);
    }

    function handleLogout(skipMessage = false) {
      currentToken = null;
      currentProfile = null;
      localStorage.removeItem(tokenStorageKey);
      localStorage.removeItem(profileStorageKey);
      updateHeaderForLoggedOutUser();      if (!skipMessage) {
        showFeedback(dashboardFeedback, 'You have been logged out.', 'success');
      }
      window.location.href = 'login.html';
    }

    function updateHeaderForLoggedInUser() {
      const adminLoginLink = document.getElementById('admin-login-link');
      const adminProfile = document.getElementById('admin-profile');
      const adminName = document.getElementById('admin-name');
      const adminSociety = document.getElementById('admin-society');
      const headerLogout = document.getElementById('header-logout');
      
      if (currentProfile && adminLoginLink && adminProfile) {
        // Hide admin login link
        adminLoginLink.style.display = 'none';
        
        // Show admin profile
        adminProfile.classList.remove('hidden');
        
        // Update admin info
        if (adminName) adminName.textContent = currentProfile.name || 'Admin';
        if (adminSociety) adminSociety.textContent = `${currentProfile.society}, ${currentProfile.city}`;
        
        // Add logout event listener
        if (headerLogout) {
          headerLogout.onclick = () => handleLogout();
        }
      }
    }
    
    function updateHeaderForLoggedOutUser() {
      const adminLoginLink = document.getElementById('admin-login-link');
      const adminProfile = document.getElementById('admin-profile');
      
      if (adminLoginLink && adminProfile) {
        // Show admin login link
        adminLoginLink.style.display = 'inline';
        
        // Hide admin profile
        adminProfile.classList.add('hidden');
      }
    }
    function checkAuthentication() {
      const storedToken = localStorage.getItem(tokenStorageKey);
      const storedProfile = localStorage.getItem(profileStorageKey);
      
      if (!storedToken || !storedProfile) {
        window.location.href = 'login.html';
        return;
      }
      
      try {
        currentToken = storedToken;
        currentProfile = JSON.parse(storedProfile);
        societySubtitle.textContent = `${currentProfile.society}, ${currentProfile.city}, ${currentProfile.state}`;
        const adminDisplayName = currentProfile.name || currentProfile.full_name || '';
        if (visitorHostInput && adminDisplayName) {
          visitorHostInput.value = adminDisplayName;
        }
        updateHeaderForLoggedInUser();
      } catch (error) {
        localStorage.removeItem(tokenStorageKey);
        localStorage.removeItem(profileStorageKey);
      updateHeaderForLoggedOutUser();
        window.location.href = 'login.html';
      }
    }

    // Access Logs functionality
    function formatTimestamp(timestamp) {
      if (!timestamp) return "";
      try {
        const date = new Date(timestamp);
        return date.toLocaleString(undefined, {
          year: "numeric",
          month: "short",
          day: "numeric",
          hour: "2-digit",
          minute: "2-digit",
          second: "2-digit"
        });
      } catch (error) {
        return timestamp;
      }
    }

    function formatShortDateLabel(dateInput) {
      if (!dateInput) return '';
      const dateValue = new Date(dateInput);
      if (Number.isNaN(dateValue.getTime())) {
        return dateInput;
      }
      return dateValue.toLocaleDateString(undefined, { month: 'short', day: 'numeric' });
    }

    function formatDateRangeLabel(from, to) {
      if (!from || !to) return '';
      const fromDate = new Date(from);
      const toDate = new Date(to);
      if (Number.isNaN(fromDate.getTime()) || Number.isNaN(toDate.getTime())) {
        return `${from}  ${to}`;
      }

      const sameYear = fromDate.getFullYear() === toDate.getFullYear();
      const startOptions = { month: 'short', day: 'numeric' };
      const endOptions = { month: 'short', day: 'numeric', year: 'numeric' };
      if (!sameYear) {
        startOptions.year = 'numeric';
      }

      const fromLabel = fromDate.toLocaleDateString(undefined, startOptions);
      const toLabel = toDate.toLocaleDateString(undefined, endOptions);
      return `${fromLabel}  ${toLabel}`;
    }

    function formatDateTimeIST(value) {
      if (!value) {
        return '-';
      }

      const date = new Date(value);
      if (Number.isNaN(date.getTime())) {
        return '-';
      }

      return date.toLocaleString('en-IN', {
        timeZone: 'Asia/Kolkata',
        year: 'numeric',
        month: 'short',
        day: 'numeric',
        hour: 'numeric',
        minute: '2-digit',
      });
    }

    function getRecognitionScoreClass(score) {
      if (!score) return "";
      if (score >= 0.8) return "high";
      if (score >= 0.6) return "medium";
      return "low";
    }

    function getActionBadgeClass(action) {
      const actionMap = {
        "entry": "entry",
        "exit": "exit",
        "access_granted": "access_granted",
        "access_denied": "access_denied",
        "authorized": "authorized",
        "unauthorized": "unauthorized"
      };
      return actionMap[action?.toLowerCase()] || "";
    }

    function formatLocation(log) {
      const parts = [];
      if (log.location_building) parts.push(`<span class="building">${log.location_building}</span>`);
      if (log.location_unit) parts.push(`Unit ${log.location_unit}`);
      return parts.length > 0 ? `<div class="location-info">${parts.join("  ")}</div>` : "";
    }

    function renderAccessLogsTable(logsData) {
      if (!logsData || !logsData.logs) {
        accessLogsTableBody.innerHTML = "<tr><td colspan=\"6\" class=\"loading-logs\">No logs found</td></tr>";
        return;
      }

      accessLogsTableBody.innerHTML = "";

      if (logsData.logs.length === 0) {
        const row = document.createElement("tr");
        const cell = document.createElement("td");
        cell.colSpan = 6;
        cell.textContent = "No access logs found for the selected filters.";
        cell.style.textAlign = "center";
        cell.style.padding = "40px";
        cell.style.color = "#6b7280";
        row.appendChild(cell);
        accessLogsTableBody.appendChild(row);
        return;
      }

      logsData.logs.forEach(log => {
        const row = document.createElement("tr");
        row.className = "access-log-row";
        
        const recognitionScoreClass = getRecognitionScoreClass(log.confidence);
        const actionBadgeClass = getActionBadgeClass(log.action);
        const nameInitial = ((log.person_name || "").trim().charAt(0) || "?").toUpperCase();
        
        row.innerHTML = `
          <td>
            <div class="face-thumbnail">
             
              <div class="no-thumbnail" style="display: "flex"};">
                <div class="no-thumbnail-icon">${nameInitial}</div>
              </div>
            </div>
          </td>
          <td>
            <div style="font-size: 13px; color: #374151;">${formatTimestamp(log.timestamp)}</div>
          </td>
          <td>
            <div style="font-weight: 600; color: #111827;">${log.person_name || "Unknown"}</div>
            <div style="font-size: 12px; color: #6b7280;">${log.user_id || "No ID"}</div>
          </td>
          <td>
            <div style="font-weight: 500; color: #374151;">${log.camera_name || ""}</div>
            <div style="font-size: 12px; color: #6b7280;">${log.device_id || ""}</div>
          </td>
          <td>
            <span class="action-badge ${actionBadgeClass}">${log.action || "unknown"}</span>
          </td>
          <td>
            <div class="recognition-score ${recognitionScoreClass}">
              ${log.confidence ? (log.confidence * 100).toFixed(1) + "%" : ""}
            </div>
          </td>
        `;
        accessLogsTableBody.appendChild(row);
      });
    }

    function renderAccessLogsPagination(logsData) {
      if (!logsData) {
        accessLogsPaginationInfo.textContent = "No data available";
        accessLogsPrevButton.disabled = true;
        accessLogsNextButton.disabled = true;
        return;
      }

      const { total_count, page, page_size, total_pages } = logsData;
      const startItem = (page - 1) * page_size + 1;
      const endItem = Math.min(page * page_size, total_count);

      if (total_count === 0) {
        accessLogsPaginationInfo.textContent = "No logs found";
      } else {
        accessLogsPaginationInfo.textContent = `Showing ${startItem}${endItem} of ${total_count} logs`;
      }

      accessLogsPrevButton.disabled = page <= 1;
      accessLogsNextButton.disabled = page >= total_pages;
    }

    function populateLogsFilterOptions(logsData) {
      if (!logsData) return;

      // Populate camera filter
      const cameraOptions = logsData.cameras || [];
      logsCameraFilter.innerHTML = "<option value=\"\">All cameras</option>";
      cameraOptions.forEach(camera => {
        const option = document.createElement("option");
        option.value = camera;
        option.textContent = camera;
        logsCameraFilter.appendChild(option);
      });

      // Populate action filter
      const actionOptions = logsData.actions || [];
      logsActionFilter.innerHTML = "<option value=\"\">All actions</option>";
      actionOptions.forEach(action => {
        const option = document.createElement("option");
        option.value = action;
        option.textContent = action.replace(/_/g, " ").replace(/\b\w/g, l => l.toUpperCase());
        logsActionFilter.appendChild(option);
      });
    }

    function getDateRangeFromSelection() {
      const range = logsDateRange.value;
      const today = new Date();
      
      if (range === "custom") {
        return {
          from: logsDateFrom.value,
          to: logsDateTo.value
        };
      }
      
      const days = parseInt(range);
      if (isNaN(days)) return { from: "", to: "" };
      
      const fromDate = new Date(today);
      fromDate.setDate(today.getDate() - days + 1);
      
      return {
        from: fromDate.toISOString().split("T")[0],
        to: today.toISOString().split("T")[0]
      };
    }

    async function loadAccessLogs() {
      if (!currentToken) return;

      // Show loading state
      accessLogsTableBody.innerHTML = "<tr><td colspan=\"6\" class=\"loading-logs\"><span class=\"spinner\"></span>Loading access logs...</td></tr>";

      try {
        const dateRange = getDateRangeFromSelection();
        const params = new URLSearchParams({
          page: currentLogsPage.toString(),
          page_size: currentLogsPageSize.toString()
        });

        if (logsCameraFilter.value) params.append("camera_name", logsCameraFilter.value);
        if (logsUsernameSearch.value.trim()) params.append("username", logsUsernameSearch.value.trim());
        if (dateRange.from) params.append("date_from", dateRange.from);
        if (dateRange.to) params.append("date_to", dateRange.to);
        if (logsActionFilter.value) params.append("action", logsActionFilter.value);

        const response = await fetch(`${backend_url}/admin/authorized-logs?${params}`, {
          headers: { "Authorization": `Bearer ${currentToken}` }
        });

        if (response.status === 401) {
          handleLogout(true);
          return;
        }

        if (!response.ok) {
          throw new Error("Failed to load access logs");
        }

        const data = await response.json();
        currentLogsData = data;
        
        renderAccessLogsTable(data);
        renderAccessLogsPagination(data);
        populateLogsFilterOptions(data);

      } catch (error) {
        console.error("Error loading access logs:", error);
        accessLogsTableBody.innerHTML = "<tr><td colspan=\"6\" style=\"text-align: center; padding: 40px; color: #dc2626;\">Error loading access logs. Please try again.</td></tr>";
        showFeedback(dashboardFeedback, error.message || "Failed to load access logs", "error");
      }
    }

    function applyLogsFilters() {
      currentLogsPage = 1;
      loadAccessLogs();
    }

    function clearLogsFilters() {
      logsUsernameSearch.value = "";
      logsCameraFilter.value = "";
      logsActionFilter.value = "";
      logsDateRange.value = "30";
      logsDateFrom.value = "";
      logsDateTo.value = "";
      customDateRange.classList.add("hidden");
      currentLogsPage = 1;
      loadAccessLogs();
    }

    // Visitor passes functionality
    function formatVisitorDate(value) {
      return formatDateTimeIST(value);
    }

    function formatVisitorEntries(pass) {
      const used = typeof pass.use_count === "number" ? pass.use_count : 0;
      if (pass.max_uses === undefined || pass.max_uses === null) {
        return `${used} / unlimited`;
      }
      return `${used} / ${pass.max_uses}`;
    }

    function normalizeVisitorStatus(pass) {
      const status = (pass.status || "").toLowerCase();
      if (status !== "active") {
        return status;
      }
      if (pass.valid_until) {
        const expiresAt = new Date(pass.valid_until);
        if (!Number.isNaN(expiresAt.getTime()) && expiresAt < new Date()) {
          return "expired";
        }
      }
      return "active";
    }

    function getAllowedDeviceLabels(pass) {
      if (!pass) {
        return [];
      }
      if (Array.isArray(pass.allowed_device_labels) && pass.allowed_device_labels.length) {
        return pass.allowed_device_labels;
      }
      if (Array.isArray(pass.allowed_device_ids) && pass.allowed_device_ids.length) {
        return pass.allowed_device_ids.map((deviceId) => visitorDeviceMap[deviceId] || deviceId);
      }
      return [];
    }

    function getAllowedDevicesText(pass) {
      const labels = getAllowedDeviceLabels(pass);
      return labels.length ? labels.join(", ") : "All gates";
    }

    function showVisitorFeedback(message, type = "info") {
      if (visitorFormFeedback) {
        showFeedback(visitorFormFeedback, message, type);
      } else {
        showFeedback(dashboardFeedback, message, type);
      }
    }

    function resetVisitorForm() {
      if (visitorPassForm) {
        visitorPassForm.reset();
      }
      if (visitorValiditySelect) {
        visitorValiditySelect.value = "60";
      }
      if (visitorCustomRange) {
        visitorCustomRange.classList.add("hidden");
      }
      if (visitorAllowMultiple) {
        visitorAllowMultiple.checked = false;
      }
      if (visitorMaxUsesInput) {
        visitorMaxUsesInput.value = "";
        visitorMaxUsesInput.disabled = true;
      }
      if (visitorDeviceSelectAll) {
        visitorDeviceSelectAll.checked = true;
      }
      syncVisitorDeviceSelectionState();
      if (visitorHostInput && currentProfile) {
        const adminDisplayName = currentProfile.name || currentProfile.full_name || '';
        if (adminDisplayName) {
          visitorHostInput.value = adminDisplayName;
        }
      }
    }

    function hideVisitorPreview() {
      currentVisitorPreview = null;
      if (visitorPassPreview) {
        visitorPassPreview.classList.add("hidden");
      }
      const overlay = document.getElementById('visitor-preview-overlay');
      if (overlay) {
        overlay.classList.add('hidden');
      }
    }

    function syncVisitorDeviceSelectionState() {
      if (!visitorDeviceList) {
        return;
      }
      const allChecked = visitorDeviceSelectAll ? visitorDeviceSelectAll.checked : true;
      const checkboxes = visitorDeviceList.querySelectorAll('input.visitor-device-checkbox');
      checkboxes.forEach((checkbox) => {
        checkbox.disabled = allChecked;
        if (allChecked) {
          checkbox.checked = false;
        }
      });
    }

    function renderVisitorDevices() {
      if (!visitorDeviceList) {
        return;
      }

      visitorDeviceList.innerHTML = "";

      if (!visitorDevices.length) {
        const placeholder = document.createElement('span');
        placeholder.className = 'person-meta';
        placeholder.textContent = 'No devices found for this society.';
        visitorDeviceList.appendChild(placeholder);
        return;
      }

      visitorDevices.forEach((device) => {
        const option = document.createElement('label');
        option.className = 'device-option';
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.value = device.id;
        checkbox.dataset.deviceId = device.id;
        checkbox.classList.add('visitor-device-checkbox');
        checkbox.addEventListener('change', () => {
          if (visitorDeviceSelectAll && visitorDeviceSelectAll.checked) {
            visitorDeviceSelectAll.checked = false;
            syncVisitorDeviceSelectionState();
          }
        });
        const labelSpan = document.createElement('span');
        labelSpan.textContent = device.label;
        option.appendChild(checkbox);
        option.appendChild(labelSpan);
        visitorDeviceList.appendChild(option);
      });

      syncVisitorDeviceSelectionState();
    }

    function getSelectedVisitorDevices() {
      if (visitorDeviceSelectAll && visitorDeviceSelectAll.checked) {
        return [];
      }
      if (!visitorDeviceList) {
        return [];
      }
      const checkboxes = visitorDeviceList.querySelectorAll('input.visitor-device-checkbox:checked');
      return Array.from(checkboxes).map((checkbox) => checkbox.value);
    }

    async function loadVisitorDevices() {
      if (!currentToken) {
        return;
      }
      try {
        const response = await fetch(`${backend_url}/admin/devices`, {
          headers: {
            Authorization: `Bearer ${currentToken}`,
            'Content-Type': 'application/json'
          }
        });
        if (!response.ok) {
          throw new Error(`Failed to load devices (${response.status})`);
        }
        const data = await response.json();
        visitorDevices = Array.isArray(data.devices) ? data.devices : [];
        visitorDeviceMap = {};
        visitorDevices.forEach((device) => {
          visitorDeviceMap[device.id] = device.label;
        });
        renderVisitorDevices();
      } catch (error) {
        console.error('Device load error:', error);
        visitorDevices = [];
        visitorDeviceMap = {};
        if (visitorDeviceList) {
          visitorDeviceList.innerHTML = '<span class="person-meta">Unable to load devices.</span>';
        }
      }
    }

    function updateVisitorPreview(pass) {
      if (!visitorPassPreview) {
        return;
      }
      currentVisitorPreview = pass;
      if (visitorPassCodeEl) {
        visitorPassCodeEl.textContent = pass.code || "";
      }
      if (visitorPassQrEl) {
        if (pass.qr_code_data_url) {
          visitorPassQrEl.src = pass.qr_code_data_url;
          visitorPassQrEl.alt = `Visitor pass QR for ${pass.visitor_name || "visitor"}`;
          visitorPassQrEl.classList.remove("hidden");
        } else {
          visitorPassQrEl.removeAttribute("src");
          visitorPassQrEl.classList.add("hidden");
        }
      }
      if (visitorPreviewMeta) {
        const parts = [];
        if (pass.valid_until) {
          parts.push(`Valid until ${formatVisitorDate(pass.valid_until)}`);
        }
        if (pass.allow_multiple_entries) {
          parts.push(
            pass.max_uses ? `Multiple entries (${pass.max_uses} max)` : "Multiple entries enabled"
          );
        } else {
          parts.push("Single entry only");
        }
        parts.push(`Allowed gates: ${getAllowedDevicesText(pass)}`);
        visitorPreviewMeta.textContent = parts.join("  ");
      }
      const overlay = document.getElementById('visitor-preview-overlay');
      if (overlay) {
        overlay.classList.remove('hidden');
      }
      visitorPassPreview.classList.remove("hidden");
    }

    async function loadVisitorPasses(status = "") {
      if (!visitorTableBody || !currentToken) {
        return;
      }

      try {
        const params = new URLSearchParams({ limit: "100" });
        if (status) {
          params.append("status_filter", status);
        }

        visitorTableBody.innerHTML = `
          <tr>
            <td colspan="7" style="text-align:center; padding: 32px; color: #475569;">
              Loading visitor passes...
            </td>
          </tr>
        `;

        const response = await fetch(`${backend_url}/admin/visitor-passes?${params.toString()}`, {
          headers: {
            Authorization: `Bearer ${currentToken}`,
            "Content-Type": "application/json",
          },
        });

        if (!response.ok) {
          throw new Error(`Failed to load visitor passes (${response.status})`);
        }

        const data = await response.json();
        visitorPasses = Array.isArray(data.passes) ? data.passes : [];
        renderVisitorPassTable(visitorPasses);
      } catch (error) {
        console.error("Visitor pass load error:", error);
        visitorTableBody.innerHTML = `
          <tr>
            <td colspan="7" style="text-align:center; padding: 32px; color: #dc2626;">
              ${error.message || "Unable to load visitor passes"}
            </td>
          </tr>
        `;
      }
    }

    function renderVisitorPassTable(passes) {
      if (!visitorTableBody) {
        return;
      }

      if (!passes.length) {
        visitorTableBody.innerHTML = `
          <tr>
            <td colspan="7" style="text-align:center; padding: 32px; color: #6b7280;">
              No visitor passes found for this filter.
            </td>
          </tr>
        `;
        return;
      }

      visitorTableBody.innerHTML = passes
        .map((pass) => {
          const statusClass = normalizeVisitorStatus(pass);
          const allowedSummary = getAllowedDevicesText(pass);
          return `
            <tr data-pass-id="${pass.id}">
              <td>
                <div class="person-cell">
                  <div class="person-name">${pass.visitor_name || "Visitor"}</div>
                  <div class="person-meta">${pass.purpose || ""}</div>
                </div>
              </td>
              <td>
                <code>${pass.code || "-"}</code>
              </td>
              <td>
                <span class="badge ${statusClass}">${statusClass}</span>
              </td>
              <td>${formatVisitorDate(pass.valid_until)}</td>
              <td>${allowedSummary}</td>
              <td>${formatVisitorEntries(pass)}</td>
              <td>
                <div class="visitor-action-buttons">
                  <button type="button" class="secondary" data-action="view" data-pass-id="${pass.id}">View</button>
                  <button type="button" class="secondary" data-action="copy" data-pass-code="${pass.code || ""}">Copy</button>
                  ${
                    statusClass === "active"
                      ? `<button type="button" class="secondary danger" data-action="revoke" data-pass-id="${pass.id}">Revoke</button>`
                      : ""
                  }
                </div>
              </td>
            </tr>
          `;
        })
        .join("");
    }

    async function viewVisitorPass(passId) {
      if (!passId || !currentToken) {
        return;
      }
      try {
        const response = await fetch(`${backend_url}/admin/visitor-passes/${passId}`, {
          headers: {
            Authorization: `Bearer ${currentToken}`,
            "Content-Type": "application/json",
          },
        });

        if (!response.ok) {
          throw new Error("Failed to fetch visitor pass details");
        }

        const data = await response.json();
        updateVisitorPreview(data);
      } catch (error) {
        console.error("View visitor pass error:", error);
        showVisitorFeedback(error.message || "Unable to load visitor pass details", "error");
      }
    }

    async function revokeVisitorPass(passId) {
      if (!passId || !currentToken) {
        return;
      }
      const confirmed = window.confirm("Revoke this visitor pass? This action cannot be undone.");
      if (!confirmed) {
        return;
      }

      try {
        const response = await fetch(`${backend_url}/admin/visitor-passes/${passId}/revoke`, {
          method: "POST",
          headers: {
            Authorization: `Bearer ${currentToken}`,
            "Content-Type": "application/json",
          },
        });

        if (!response.ok) {
          const body = await response.json().catch(() => ({}));
          throw new Error(body.detail || "Failed to revoke visitor pass");
        }

        showVisitorFeedback("Visitor pass revoked successfully", "success");
        await loadVisitorPasses(visitorStatusFilter ? visitorStatusFilter.value : "");
      } catch (error) {
        console.error("Revoke visitor pass error:", error);
        showVisitorFeedback(error.message || "Failed to revoke visitor pass", "error");
      }
    }

    function handleVisitorTableClick(event) {
      const target = event.target;
      if (!(target instanceof HTMLElement)) {
        return;
      }

      const action = target.dataset.action;
      if (!action) {
        return;
      }

      if (action === "view") {
        const passId = target.dataset.passId;
        viewVisitorPass(passId);
      } else if (action === "copy") {
        const code = target.dataset.passCode || (currentVisitorPreview ? currentVisitorPreview.code : "");
        if (code) {
          navigator.clipboard
            .writeText(code)
            .then(() => showVisitorFeedback("Visitor code copied to clipboard", "success"))
            .catch(() => showVisitorFeedback("Unable to copy code", "error"));
        }
      } else if (action === "revoke") {
        const passId = target.dataset.passId;
        revokeVisitorPass(passId);
      }
    }

    function handleVisitorValidityChange(event) {
      if (!visitorCustomRange) {
        return;
      }
      if (event.target.value === "custom") {
        visitorCustomRange.classList.remove("hidden");
      } else {
        visitorCustomRange.classList.add("hidden");
      }
    }

    function handleVisitorAllowMultipleChange() {
      if (!visitorMaxUsesInput) {
        return;
      }
      if (visitorAllowMultiple && visitorAllowMultiple.checked) {
        visitorMaxUsesInput.disabled = false;
        if (!visitorMaxUsesInput.value || parseInt(visitorMaxUsesInput.value, 10) < 2) {
          visitorMaxUsesInput.value = "10";
        }
      } else {
        visitorMaxUsesInput.value = "";
        visitorMaxUsesInput.disabled = true;
      }
    }

    async function handleVisitorFormSubmit(event) {
      event.preventDefault();
      if (isSubmittingVisitor) {
        return;
      }
      if (!visitorPassForm) {
        return;
      }
      if (!currentToken) {
        showVisitorFeedback("You must be logged in to create visitor passes", "error");
        return;
      }

      const visitorName = visitorNameInput ? visitorNameInput.value.trim() : "";
      if (!visitorName) {
        showVisitorFeedback("Visitor name is required", "error");
        if (visitorNameInput) {
          visitorNameInput.focus();
        }
        return;
      }

      const payload = {
        visitor_name: visitorName,
        visitor_contact: visitorContactInput && visitorContactInput.value.trim() ? visitorContactInput.value.trim() : null,
        purpose: visitorPurposeInput && visitorPurposeInput.value.trim() ? visitorPurposeInput.value.trim() : null,
        host_name: visitorHostInput && visitorHostInput.value.trim() ? visitorHostInput.value.trim() : null,
        tower_name: visitorTowerInput && visitorTowerInput.value.trim() ? visitorTowerInput.value.trim() : null,
        flat_number: visitorFlatInput && visitorFlatInput.value.trim() ? visitorFlatInput.value.trim() : null,
        notes: visitorNotesInput && visitorNotesInput.value.trim() ? visitorNotesInput.value.trim() : null,
        allow_multiple_entries: visitorAllowMultiple ? visitorAllowMultiple.checked : false,
      };

      const validityChoice = visitorValiditySelect ? visitorValiditySelect.value : "60";
      const now = new Date();

      if (validityChoice === "custom") {
        const startValue = visitorCustomStart ? visitorCustomStart.value : "";
        const endValue = visitorCustomEnd ? visitorCustomEnd.value : "";

        if (!startValue || !endValue) {
          showVisitorFeedback("Select both start and end time for custom validity", "error");
          return;
        }

        const startDate = new Date(startValue);
        const endDate = new Date(endValue);

        if (Number.isNaN(startDate.getTime()) || Number.isNaN(endDate.getTime())) {
          showVisitorFeedback("Invalid custom date range", "error");
          return;
        }

        if (endDate <= startDate) {
          showVisitorFeedback("Valid until must be after the start time", "error");
          return;
        }

        const diffMinutes = Math.round((endDate.getTime() - startDate.getTime()) / 60000);
        if (diffMinutes > 43200) {
          showVisitorFeedback("Custom duration cannot exceed 30 days", "error");
          return;
        }

        if (endDate <= now) {
          showVisitorFeedback("Valid until must be in the future", "error");
          return;
        }

        payload.valid_from = startDate.toISOString();
        payload.valid_until = endDate.toISOString();
      } else {
        const durationMinutes = parseInt(validityChoice || "0", 10);
        if (!Number.isFinite(durationMinutes) || durationMinutes <= 0) {
          showVisitorFeedback("Choose a valid duration", "error");
          return;
        }
        payload.valid_for_minutes = durationMinutes;
      }

      if (payload.allow_multiple_entries) {
        const maxUsesValue = visitorMaxUsesInput ? parseInt(visitorMaxUsesInput.value || "0", 10) : 0;
        payload.max_uses = Number.isFinite(maxUsesValue) && maxUsesValue > 0 ? maxUsesValue : null;
      } else {
        payload.max_uses = 1;
      }

      const selectedDevices = getSelectedVisitorDevices();
      if (selectedDevices.length) {
        payload.allowed_device_ids = selectedDevices;
      }

      showVisitorFeedback("Generating visitor pass...", "info");
      isSubmittingVisitor = true;

      try {
        const response = await fetch(`${backend_url}/admin/visitor-passes`, {
          method: "POST",
          headers: {
            Authorization: `Bearer ${currentToken}`,
            "Content-Type": "application/json",
          },
          body: JSON.stringify(payload),
        });

        if (!response.ok) {
          const errorBody = await response.json().catch(() => ({}));
          throw new Error(errorBody.detail || "Failed to create visitor pass");
        }

        const data = await response.json();
        showVisitorFeedback("Visitor pass generated successfully", "success");
        updateVisitorPreview(data);
        resetVisitorForm();
        await loadVisitorPasses(visitorStatusFilter ? visitorStatusFilter.value : "");
      } catch (error) {
        console.error("Visitor pass creation error:", error);
        showVisitorFeedback(error.message || "Failed to create visitor pass", "error");
      } finally {
        isSubmittingVisitor = false;
      }
    }

    function initializeVisitorSection() {
      if (visitorValiditySelect) {
        visitorValiditySelect.addEventListener("change", handleVisitorValidityChange);
      }
      if (visitorAllowMultiple) {
        visitorAllowMultiple.addEventListener("change", handleVisitorAllowMultipleChange);
        handleVisitorAllowMultipleChange();
      }
      if (visitorPassForm) {
        visitorPassForm.addEventListener("submit", handleVisitorFormSubmit);
      }
      if (visitorResetFormBtn) {
        visitorResetFormBtn.addEventListener("click", () => {
          resetVisitorForm();
          hideVisitorPreview();
        });
      }
      if (visitorClosePreviewBtn) {
        visitorClosePreviewBtn.addEventListener("click", hideVisitorPreview);
      }
      if (visitorCopyCodeBtn) {
        visitorCopyCodeBtn.addEventListener("click", () => {
          if (currentVisitorPreview && currentVisitorPreview.code) {
            navigator.clipboard
              .writeText(currentVisitorPreview.code)
              .then(() => showVisitorFeedback("Visitor code copied to clipboard", "success"))
              .catch(() => showVisitorFeedback("Unable to copy code", "error"));
          }
        });
      }
      if (visitorDownloadQrBtn) {
        visitorDownloadQrBtn.addEventListener("click", () => {
          if (!currentVisitorPreview || !currentVisitorPreview.qr_code_data_url) {
            showVisitorFeedback("No QR code available to download", "error");
            return;
          }
          const link = document.createElement("a");
          link.href = currentVisitorPreview.qr_code_data_url;
          const filename = currentVisitorPreview.visitor_name
            ? currentVisitorPreview.visitor_name.replace(/\s+/g, "_").toLowerCase()
            : "visitor-pass";
          link.download = `${filename}.png`;
          link.click();
        });
      }
      if (visitorRefreshPassBtn) {
        visitorRefreshPassBtn.addEventListener("click", () =>
          loadVisitorPasses(visitorStatusFilter ? visitorStatusFilter.value : "")
        );
      }
      if (refreshVisitorPassesBtn) {
        refreshVisitorPassesBtn.addEventListener("click", () =>
          loadVisitorPasses(visitorStatusFilter ? visitorStatusFilter.value : "")
        );
      }
      if (visitorStatusFilter) {
        visitorStatusFilter.addEventListener("change", () =>
          loadVisitorPasses(visitorStatusFilter.value)
        );
      }
      if (visitorTableBody) {
        visitorTableBody.addEventListener("click", handleVisitorTableClick);
      }
      if (visitorDeviceSelectAll) {
        visitorDeviceSelectAll.addEventListener('change', syncVisitorDeviceSelectionState);
      }
      resetVisitorForm();
      loadVisitorDevices();
    }

    // Event listeners
    navButtons.forEach(button => {
      button.addEventListener('click', () => {
        const target = button.dataset.section;
        activateSection(target);
      });
    });

    // logoutButton.addEventListener('click', () => {
    //   handleLogout();
    // });

    // Access Logs event listeners
    if (logsDateRange) {
      logsDateRange.addEventListener("change", (event) => {
        if (event.target.value === "custom") {
          customDateRange.classList.remove("hidden");
        } else {
          customDateRange.classList.add("hidden");
        }
      });
    }

    if (logsApplyFilters) {
      logsApplyFilters.addEventListener("click", applyLogsFilters);
    }

    if (logsClearFilters) {
      logsClearFilters.addEventListener("click", clearLogsFilters);
    }

    if (logsPageSize) {
      logsPageSize.addEventListener("change", (event) => {
        currentLogsPageSize = parseInt(event.target.value, 10) || 50;
        currentLogsPage = 1;
        loadAccessLogs();
      });
    }

    if (accessLogsPrevButton) {
      accessLogsPrevButton.addEventListener("click", () => {
        if (currentLogsPage > 1) {
          currentLogsPage -= 1;
          loadAccessLogs();
        }
      });
    }

    if (accessLogsNextButton) {
      accessLogsNextButton.addEventListener("click", () => {
        if (currentLogsData && currentLogsPage < currentLogsData.total_pages) {
          currentLogsPage += 1;
          loadAccessLogs();
        }
      });
    }

    
    // User Statistics Functions
    async function loadUserStatistics() {
      setUserStatsLoading(true);
      try {
        const [countsResponse, attendanceResponse] = await Promise.all([
          fetch(`${backend_url}/admin/users/statistics/counts`, {
            headers: {
              'Authorization': `Bearer ${currentToken}`,
              'Content-Type': 'application/json'
            }
          }),
          fetch(`${backend_url}/admin/users/statistics/today-attendance`, {
            headers: {
              'Authorization': `Bearer ${currentToken}`,
              'Content-Type': 'application/json'
            }
          })
        ]);

        if (!countsResponse.ok) {
          throw new Error(`Counts API error: ${countsResponse.status}`);
        }

        if (!attendanceResponse.ok) {
          throw new Error(`Attendance API error: ${attendanceResponse.status}`);
        }

        const countsData = await countsResponse.json();
        const attendanceData = await attendanceResponse.json();

        // Update statistics cards
        const totalUsers = countsData.total_users || 0;
        const activeUsers = countsData.active_users || 0;
        const inactiveUsers = countsData.inactive_users || 0;
        const pendingUsers = countsData.pending_users || 0;

        totalUsersCount.textContent = totalUsers;
        activeUsersCount.textContent = activeUsers;
        inactiveUsersCount.textContent = inactiveUsers;
        pendingUsersCount.textContent = pendingUsers;

        // Update attendance summary
        const presentCount = attendanceData.present_users || 0;
        const absentCount = Math.max(activeUsers - presentCount, 0);
        todayPresentCount.textContent = presentCount;
        todayAbsentCount.textContent = absentCount;

        const totalAttendanceToday = presentCount + absentCount;
        if (attendancePercentage) {
          const percentage = totalAttendanceToday ? Math.round((presentCount / totalAttendanceToday) * 100) : 0;
          attendancePercentage.textContent = `${percentage}%`;
        }

        updateUsersStatusChart({ active: activeUsers, inactive: inactiveUsers, pending: pendingUsers });
        updateAttendanceChart({ present: presentCount, absent: absentCount });

      } catch (error) {
        console.error('Error loading user statistics:', error);
        showFeedback(dashboardFeedback, 'Failed to load user statistics', 'error');
      } finally {
        setUserStatsLoading(false);
      }
    }

    function updateUsersStatusChart({ active = 0, inactive = 0, pending = 0 }) {
      if (!usersStatusChartCanvas || typeof Chart === 'undefined') {
        return;
      }

      const totals = [active, inactive, pending];
      const totalSum = totals.reduce((sum, value) => sum + value, 0);
      const noData = totalSum === 0;

      const labels = noData ? ['No data'] : ['Active', 'Inactive', 'Pending'];
      const values = noData ? [1] : totals;
      const colors = noData
        ? [chartPalette.fallback]
        : [chartPalette.active, chartPalette.inactive, chartPalette.pending];

      const chartData = {
        labels,
        datasets: [
          {
            data: values,
            backgroundColor: colors,
            borderWidth: 0,
            hoverOffset: 8,
          },
        ],
      };

      const chartOptions = {
        responsive: true,
        maintainAspectRatio: false,
        cutout: '60%',
        plugins: {
          legend: {
            position: 'bottom',
            labels: {
              usePointStyle: true,
              padding: 16,
            },
          },
          tooltip: {
            callbacks: {
              label: (context) => {
                if (noData) {
                  return 'No data';
                }
                const label = context.label || '';
                const value = context.parsed || 0;
                const percentage = totalSum ? ((value / totalSum) * 100).toFixed(1) : 0;
                return `${label}: ${value} (${percentage}%)`;
              },
            },
          },
        },
      };

      if (!usersStatusChartInstance) {
        usersStatusChartInstance = new Chart(usersStatusChartCanvas, {
          type: 'doughnut',
          data: chartData,
          options: chartOptions,
        });
      } else {
        usersStatusChartInstance.data = chartData;
        usersStatusChartInstance.options = chartOptions;
        usersStatusChartInstance.update();
      }
    }

    function updateAttendanceChart({ present = 0, absent = 0 }) {
      if (!attendanceChartCanvas || typeof Chart === 'undefined') {
        return;
      }

      const labels = ['Present', 'Absent'];
      const values = [present, absent];
      const maxValue = Math.max(...values, 1);

      const chartData = {
        labels,
        datasets: [
          {
            label: 'Count',
            data: values,
            backgroundColor: [chartPalette.present, chartPalette.absent],
            borderRadius: 12,
            borderSkipped: false,
            maxBarThickness: 56,
          },
        ],
      };

      const chartOptions = {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          x: {
            grid: {
              display: false,
            },
            ticks: {
              font: {
                weight: 600,
              },
            },
          },
          y: {
            beginAtZero: true,
            suggestedMax: Math.max(maxValue, 4),
            grid: {
              color: '#e2e8f0',
            },
            ticks: {
              precision: 0,
            },
          },
        },
        plugins: {
          legend: {
            display: false,
          },
          tooltip: {
            callbacks: {
              label: (context) => {
                const value = typeof context.parsed?.y === 'number' ? context.parsed.y : context.parsed;
                return `${context.label}: ${value}`;
              },
            },
          },
        },
      };

      if (!attendanceBarChartInstance) {
        attendanceBarChartInstance = new Chart(attendanceChartCanvas, {
          type: 'bar',
          data: chartData,
          options: chartOptions,
        });
      } else {
        attendanceBarChartInstance.data = chartData;
        attendanceBarChartInstance.options = chartOptions;
        attendanceBarChartInstance.update();
      }
    }

    async function loadOverviewAnalytics({ force = false } = {}) {
      if (!currentToken) {
        return;
      }

      if (overviewAnalyticsLoaded && !force) {
        return;
      }

      try {
        const response = await fetch(`${backend_url}/admin/authorized-summary?days=${OVERVIEW_ANALYTICS_LOOKBACK_DAYS}`, {
          headers: {
            'Authorization': `Bearer ${currentToken}`,
            'Content-Type': 'application/json'
          }
        });

        if (response.status === 401) {
          handleLogout(true);
          return;
        }

        if (!response.ok) {
          throw new Error(`Analytics API error: ${response.status}`);
        }

        const analyticsData = await response.json();
        overviewAnalyticsLoaded = true;
        updateDailyEntryTrendChart(analyticsData);
        updateTopUsersChart(analyticsData);
      } catch (error) {
        console.error('Error loading overview analytics:', error);
        updateDailyEntryTrendChart(null);
        updateTopUsersChart(null);
        if (topUsersChartCaption) {
          topUsersChartCaption.textContent = 'Analytics unavailable right now.';
        }
      }
    }

    function updateDailyEntryTrendChart(analyticsData) {
      if (!dailyEntryChartCanvas || typeof Chart === 'undefined') {
        return;
      }

      const dailySummaries = Array.isArray(analyticsData?.daily) ? [...analyticsData.daily] : [];
      dailySummaries.sort((a, b) => new Date(a.date) - new Date(b.date));

      const labels = dailySummaries.map(day => formatShortDateLabel(day.date));
      const dataPoints = dailySummaries.map(day =>
        (day.records || []).reduce((sum, record) => sum + (Number(record.entry_count) || 0), 0)
      );

      if (!labels.length) {
        labels.push('No data');
        dataPoints.push(0);
      }

      const maxValue = Math.max(...dataPoints, 1);

      const chartData = {
        labels,
        datasets: [
          {
            label: 'Entries',
            data: dataPoints,
            fill: true,
            backgroundColor: 'rgba(42, 157, 244, 0.18)',
            borderColor: chartPalette.primary,
            pointBackgroundColor: chartPalette.primary,
            pointBorderColor: '#ffffff',
            pointBorderWidth: 2,
            tension: 0.35,
            pointRadius: 4,
            pointHoverRadius: 6,
          },
        ],
      };

      const chartOptions = {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          x: {
            grid: {
              display: false,
            },
            ticks: {
              maxRotation: 0,
              autoSkip: true,
              autoSkipPadding: 10,
            },
          },
          y: {
            beginAtZero: true,
            suggestedMax: maxValue + Math.ceil(maxValue * 0.15),
            grid: {
              color: '#e2e8f0',
            },
            ticks: {
              precision: 0,
            },
          },
        },
        plugins: {
          legend: {
            display: false,
          },
          tooltip: {
            callbacks: {
              title: (items) => items[0]?.label || '',
              label: (context) => `Entries: ${context.parsed.y ?? context.parsed}`,
            },
          },
        },
      };

      if (!dailyEntryChartInstance) {
        dailyEntryChartInstance = new Chart(dailyEntryChartCanvas, {
          type: 'line',
          data: chartData,
          options: chartOptions,
        });
      } else {
        dailyEntryChartInstance.data = chartData;
        dailyEntryChartInstance.options = chartOptions;
        dailyEntryChartInstance.update();
      }
    }

    function updateTopUsersChart(analyticsData) {
      if (!topUsersChartCanvas || typeof Chart === 'undefined') {
        return;
      }

      const entryTotals = new Map();
      const dailySummaries = Array.isArray(analyticsData?.daily) ? analyticsData.daily : [];

      dailySummaries.forEach(day => {
        (day.records || []).forEach(record => {
          const name = (record.person_name || 'Unknown').trim() || 'Unknown';
          const entries = Number(record.entry_count) || 0;
          if (entries > 0) {
            entryTotals.set(name, (entryTotals.get(name) || 0) + entries);
          }
        });
      });

      const sortedEntries = Array.from(entryTotals.entries()).sort((a, b) => b[1] - a[1]);
      const topEntries = sortedEntries.slice(0, 5);

      let labels = topEntries.map(([name]) => name);
      let values = topEntries.map(([, count]) => count);

      if (!labels.length) {
        labels = ['No data'];
        values = [0];
      }

      const chartData = {
        labels,
        datasets: [
          {
            label: 'Entries',
            data: values,
            backgroundColor: chartPalette.accent,
            borderRadius: 12,
            borderSkipped: false,
            maxBarThickness: 32,
          },
        ],
      };

      const chartOptions = {
        indexAxis: 'y',
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          x: {
            beginAtZero: true,
            grid: {
              color: '#e2e8f0',
            },
            ticks: {
              precision: 0,
            },
          },
          y: {
            grid: {
              display: false,
            },
          },
        },
        plugins: {
          legend: {
            display: false,
          },
          tooltip: {
            callbacks: {
              label: (context) => `${context.label}: ${context.parsed.x ?? context.parsed}`,
            },
          },
        },
      };

      if (!topUsersChartInstance) {
        topUsersChartInstance = new Chart(topUsersChartCanvas, {
          type: 'bar',
          data: chartData,
          options: chartOptions,
        });
      } else {
        topUsersChartInstance.data = chartData;
        topUsersChartInstance.options = chartOptions;
        topUsersChartInstance.update();
      }

      if (topUsersChartCaption) {
        if (sortedEntries.length === 0) {
          topUsersChartCaption.textContent = 'No recent activity captured.';
        } else {
          const windowLabel = formatDateRangeLabel(analyticsData?.date_range?.from, analyticsData?.date_range?.to)
            || `last ${OVERVIEW_ANALYTICS_LOOKBACK_DAYS} days`;
          topUsersChartCaption.textContent = `Top ${topEntries.length} members by entries (${windowLabel})`;
        }
      }
    }

    // Active Users Functions

    // Attendance Functions
    // Event Listeners for new sections
    // Event Listeners for user management sections
    function setupUserManagementEventListeners() {
      // User statistics will be loaded when users section is activated
    }

    // Utility functions
    function viewUserDetail(userId) {
      openUserDetail(userId);
    }



    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }


    // ===== USER ATTENDANCE SECTION =====
    
    // Global variables for attendance
    let currentAttendanceData = null;
    let currentAttendancePage = 1;
    let currentAttendancePageSize = 10;
    let currentAttendanceTotalCount = 0;
    let currentAttendanceTotalPages = 0;
    
    // DOM elements for user attendance
    let attendanceDate, loadAttendanceBtn, refreshAttendanceBtn, attendanceTableBody;
    let attendanceTotalUsers, attendancePresentCount, attendanceAbsentCount, attendancePercentage;
    let attendanceSearch, attendanceStatusFilter, attendanceUserTypeFilter, attendancePageSize;
    let attendancePaginationInfo, attendancePrevBtn, attendanceNextBtn;

    // Initialize attendance section
    function initializeAttendanceSection() {
      console.log(' Initializing User Attendance Section...');
      
      // Initialize DOM elements
      initializeAttendanceDOM();
      
      // Set default date to today
      const today = new Date().toISOString().split('T')[0];
      attendanceDate.value = today;
      console.log(' Set default date to:', today);
      
      // Add event listeners
      setupAttendanceEventListeners();
      
      // Load today's attendance by default
      loadUserAttendance();
    }

    // Initialize DOM elements
    function initializeAttendanceDOM() {
      attendanceDate = document.getElementById('attendance-date');
      loadAttendanceBtn = document.getElementById('load-attendance-btn');
      refreshAttendanceBtn = document.getElementById('refresh-attendance-btn');
      attendanceTableBody = document.getElementById('attendance-table-body');
      attendanceTotalUsers = document.getElementById('attendance-total-users');
      attendancePresentCount = document.getElementById('attendance-present-count');
      attendanceAbsentCount = document.getElementById('attendance-absent-count');
      attendancePercentage = document.getElementById('attendance-percentage');
      attendanceSearch = document.getElementById('attendance-search');
      attendanceStatusFilter = document.getElementById('attendance-status-filter');
      attendanceUserTypeFilter = document.getElementById('attendance-user-type-filter');
      attendancePageSize = document.getElementById('attendance-page-size');
      attendancePaginationInfo = document.getElementById('attendance-pagination-info');
      attendancePrevBtn = document.getElementById('attendance-prev');
      attendanceNextBtn = document.getElementById('attendance-next');
      
      console.log(' Attendance DOM elements initialized');
    }

    // Setup event listeners
    function setupAttendanceEventListeners() {
      loadAttendanceBtn.addEventListener('click', loadUserAttendance);
      refreshAttendanceBtn.addEventListener('click', loadUserAttendance);
      attendanceSearch.addEventListener('input', debounce(applyAttendanceFilters, 300));
      attendanceStatusFilter.addEventListener('change', applyAttendanceFilters);
      attendanceUserTypeFilter.addEventListener('change', applyAttendanceFilters);
      attendancePageSize.addEventListener('change', (e) => {
        currentAttendancePageSize = parseInt(e.target.value);
        currentAttendancePage = 1;
        loadUserAttendance();
      });
      attendancePrevBtn.addEventListener('click', () => {
        if (currentAttendancePage > 1) {
          currentAttendancePage--;
          loadUserAttendance();
        }
      });
      attendanceNextBtn.addEventListener('click', () => {
        if (currentAttendancePage < currentAttendanceTotalPages) {
          currentAttendancePage++;
          loadUserAttendance();
        }
      });
      
      console.log(' Attendance event listeners added');
    }

    // Load user attendance data with pagination
    async function loadUserAttendance() {
      console.log(' Loading user attendance data...');
      
      if (!currentToken) {
        showFeedback(dashboardFeedback, 'Please log in to view attendance data', 'error');
        return;
      }

      const selectedDate = attendanceDate.value;
      console.log(' Selected date:', selectedDate);
      
      if (!selectedDate) {
        showFeedback(dashboardFeedback, 'Please select a date', 'error');
        return;
      }

      // Show loading state
      showAttendanceLoading();

      try {
        // Build query parameters
        const params = new URLSearchParams({
          date: selectedDate,
          page: currentAttendancePage.toString(),
          page_size: currentAttendancePageSize.toString()
        });

        // Add filters
        const searchTerm = attendanceSearch.value.trim();
        if (searchTerm) {
          params.append('search', searchTerm);
        }

        const statusFilter = attendanceStatusFilter.value;
        if (statusFilter && statusFilter !== 'all') {
          params.append('status_filter', statusFilter);
        }

        const userTypeFilter = attendanceUserTypeFilter.value;
        if (userTypeFilter && userTypeFilter !== 'all') {
          params.append('user_type_filter', userTypeFilter);
        }

        const url = `${backend_url}/admin/society-users-with-logs?${params}`;
        console.log(' Making request to:', url);
        
        const response = await fetch(url, {
          headers: {
            'Authorization': `Bearer ${currentToken}`,
            'Content-Type': 'application/json'
          }
        });

        console.log(' Response status:', response.status);

        if (response.status === 401) {
          console.log(' Unauthorized, logging out');
          handleLogout(true);
          return;
        }

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();
        console.log(' Received data:', data);
        
        currentAttendanceData = data;
        currentAttendanceTotalCount = data.pagination.total_count;
        currentAttendanceTotalPages = data.pagination.total_pages;
        if (data.pagination && typeof data.pagination.page === 'number') {
          currentAttendancePage = data.pagination.page;
        }
        
        renderAttendanceTable();
        updateAttendanceStats();
        updateAttendancePagination();

      } catch (error) {
        console.error(' Error loading user attendance:', error);
        showAttendanceError(error.message || 'Failed to load attendance data');
        showFeedback(dashboardFeedback, error.message || 'Failed to load attendance data', 'error');
      }
    }

    // Show loading state
    function showAttendanceLoading() {
      if (attendanceTableBody) {
        attendanceTableBody.innerHTML = `
          <tr>
            <td colspan="8" class="loading-logs">
              <span class="spinner"></span>Loading attendance data...
            </td>
          </tr>
        `;
      }
    }

    // Show error state
    function showAttendanceError(message) {
      if (attendanceTableBody) {
        attendanceTableBody.innerHTML = `
          <tr>
            <td colspan="8" style="text-align: center; padding: 40px; color: #dc2626;">
               ${message}
            </td>
          </tr>
        `;
      }
    }

    // Apply filters (now triggers a new API call)
    function applyAttendanceFilters() {
      console.log(' Applying filters and reloading data...');
      currentAttendancePage = 1; // Reset to first page when filters change
      loadUserAttendance();
    }

    // Render attendance table (simplified since data is already filtered)
    function renderAttendanceTable() {
      console.log(' Rendering attendance table...');
      
      if (!currentAttendanceData || !currentAttendanceData.users || currentAttendanceData.users.length === 0) {
        if (attendanceTableBody) {
          attendanceTableBody.innerHTML = `
            <tr>
              <td colspan="8" style="text-align: center; padding: 40px; color: #6b7280;">
                No users found matching the current filters.
              </td>
            </tr>
          `;
        }
        return;
      }

      console.log(` Rendering page ${currentAttendancePage}: ${currentAttendanceData.users.length} users`);

      const rows = currentAttendanceData.users.map(user => {
        const statusClass = user.attendance.is_present ? 'status-active' : 'status-inactive';
        const statusText = user.attendance.is_present ? 'Present' : 'Absent';
        
        // Format all entry times
        const allEntryTimes = user.attendance.all_entry_times || [];
        const formattedEntryTimes = allEntryTimes.length > 0 
          ? allEntryTimes.map(time => new Date(time).toLocaleTimeString()).join(', ')
          : '-';
        
        const entryCount = user.attendance.entry_count || 0;
        
        const thumbnail = user.thumbnail_url ? 
          `<img src="${user.thumbnail_url}" alt="${user.name}" class="user-thumbnail" />` : 
          '<div class="user-thumbnail-placeholder"></div>';

        return `
          <tr>
            <td>
              <div class="user-info">
                ${thumbnail}
                <div>
                  <strong>${user.name || 'Unknown'}</strong>
                  <div class="small-label">${user.flat_number || 'N/A'}</div>
                </div>
              </div>
            </td>
            <td>
              <div>${user.mobile_number || 'N/A'}</div>
            </td>
            <td>
              <span class="user-type-badge">${formatUserLabel(user.user_type || 'N/A')}</span>
            </td>
            <td>
              <span class="status-badge ${statusClass}">${statusText}</span>
            </td>
            <td title="${allEntryTimes.map(time => new Date(time).toLocaleString()).join(', ')}">${formattedEntryTimes}</td>
            <td>${entryCount}</td>
            <td>${user.attendance.total_logs}</td>
            <td>
              <button class="btn-small" onclick="viewUserAttendanceDetail('${user.id}')">View Logs</button>
            </td>
          </tr>
        `;
      }).join('');

      if (attendanceTableBody) {
        attendanceTableBody.innerHTML = rows;
        console.log(' Table rendered successfully');
      }
    }

    // Update attendance statistics
    function updateAttendanceStats() {
      if (!currentAttendanceData) return;

      const totalUsers = currentAttendanceData.summary.total_users || 0;
      const presentCount = currentAttendanceData.summary.present || 0;
      const absentCount = currentAttendanceData.summary.absent || 0;
      const attendancePercent = currentAttendanceData.summary.attendance_percentage || 0;

      if (attendanceTotalUsers) attendanceTotalUsers.textContent = totalUsers;
      if (attendancePresentCount) attendancePresentCount.textContent = presentCount;
      if (attendanceAbsentCount) attendanceAbsentCount.textContent = absentCount;
      if (attendancePercentage) attendancePercentage.textContent = `${attendancePercent}%`;

      console.log(' Updated attendance stats:', { totalUsers, presentCount, absentCount, attendancePercent });
    }

    // Update pagination
    function updateAttendancePagination() {
      if (!currentAttendanceData) return;

      const totalItems = currentAttendanceTotalCount;
      const totalPages = currentAttendanceTotalPages;
      const startItem = (currentAttendancePage - 1) * currentAttendancePageSize + 1;
      const endItem = Math.min(currentAttendancePage * currentAttendancePageSize, totalItems);

      if (attendancePaginationInfo) {
        if (totalItems === 0) {
          attendancePaginationInfo.textContent = 'No users to display.';
        } else {
          attendancePaginationInfo.textContent = `Showing ${startItem}-${endItem} of ${totalItems} users`;
        }
      }

      if (attendancePrevBtn) {
        attendancePrevBtn.disabled = currentAttendancePage <= 1;
      }
      if (attendanceNextBtn) {
        attendanceNextBtn.disabled = currentAttendancePage >= totalPages;
      }

      console.log(` Pagination: Page ${currentAttendancePage}/${totalPages}, Items ${startItem}-${endItem}/${totalItems}`);
    }

    // View user attendance detail
    function viewUserAttendanceDetail(userId) {
      if (!currentAttendanceData || !currentAttendanceData.users) {
        showFeedback(dashboardFeedback, 'No attendance data available', 'error');
        return;
      }

      const user = currentAttendanceData.users.find(u => u.id === userId);
      if (!user) {
        showFeedback(dashboardFeedback, 'User not found', 'error');
        return;
      }

      openUserDetail(user.id);
    }


    // ===== USERS SECTION =====
    
    // Global variables for users management
    let currentUsersData = null;
    let currentUsersPage = 1;
    let currentUsersPageSize = 25;
    let currentUsersTotalCount = 0;
    let currentUsersTotalPages = 0;
    
    // DOM elements for users section
    let usersSearch, usersStatusFilter, usersTypeFilter, usersPageSize;
    let usersApplyFilters, usersClearFilters, usersRefresh, usersAddButton;
    let usersTableBody, usersPaginationInfo, usersPrevBtn, usersNextBtn;

    // User form modal elements
    let userFormOverlay, userForm, userFormTitle, userFormSocietyLabel;
    let userFormSubmitButton, userFormCancelButton, userFormErrorBox;
    let userFormNameInput, userFormMobileInput, userFormTypeSelect;
    let userFormTowerInput, userFormFlatInput, userFormExpireInput;
    let userFormForeverToggle, userFormImagesInput, userFormImagesRow;
    let userFormExistingContainer, userFormExistingGrid, userFormExistingCount;
    let userFormExpireRow, userFormSubmitText, userFormSubmitSpinner;
    let userFormMode = 'create';
    let editingUserId = null;
    let editingUserImages = [];
    let userFormRemovedImages = new Set();
    let userDetailModalInitialized = false;

    // Initialize users section
    function initializeUsersSection() {
      console.log(' Initializing Users Section...');
      
      // Initialize DOM elements
      initializeUsersDOM();
      
      // Add event listeners
      setupUsersEventListeners();
      
      // Load users data
      loadUsers();
    }

    // Initialize DOM elements
    function initializeUsersDOM() {
      usersSearch = document.getElementById('users-search');
      usersStatusFilter = document.getElementById('users-status-filter');
      usersTypeFilter = document.getElementById('users-type-filter');
      usersPageSize = document.getElementById('users-page-size');
      usersApplyFilters = document.getElementById('users-apply-filters');
      usersClearFilters = document.getElementById('users-clear-filters');
      usersRefresh = document.getElementById('users-refresh');
      usersAddButton = document.getElementById('users-add');
      usersTableBody = document.getElementById('users-table-body');
      usersPaginationInfo = document.getElementById('users-pagination-info');
      usersPrevBtn = document.getElementById('users-prev');
      usersNextBtn = document.getElementById('users-next');
      
      console.log(' Users DOM elements initialized');
    }

    // Setup event listeners
    function setupUsersEventListeners() {
      if (usersApplyFilters) usersApplyFilters.addEventListener('click', applyUsersFilters);
      if (usersClearFilters) usersClearFilters.addEventListener('click', clearUsersFilters);
      if (usersRefresh) usersRefresh.addEventListener('click', () => loadUsers());
      if (usersAddButton) usersAddButton.addEventListener('click', openCreateUserModal);
      if (usersSearch) usersSearch.addEventListener('input', debounce(applyUsersFilters, 300));
      if (usersStatusFilter) usersStatusFilter.addEventListener('change', applyUsersFilters);
      if (usersTypeFilter) usersTypeFilter.addEventListener('change', applyUsersFilters);
      
      if (usersPageSize) {
        usersPageSize.addEventListener('change', (e) => {
          currentUsersPageSize = parseInt(e.target.value);
          currentUsersPage = 1;
          if (currentUsersData) {
            renderUsersTable();
            updateUsersPagination();
          }
        });
      }
      
      if (usersPrevBtn) {
        usersPrevBtn.addEventListener('click', () => {
          if (currentUsersPage > 1) {
            currentUsersPage--;
            if (currentUsersData) {
              renderUsersTable();
              updateUsersPagination();
            }
          }
        });
      }
      
      if (usersNextBtn) {
        usersNextBtn.addEventListener('click', () => {
          if (currentUsersPage < currentUsersTotalPages) {
            currentUsersPage++;
            if (currentUsersData) {
              renderUsersTable();
              updateUsersPagination();
            }
          }
        });
      }
      
      console.log(' Users event listeners added');
    }

    // Load users data
    async function loadUsers() {
      console.log(' Loading users data...');
      
      if (!currentToken) {
        showFeedback(dashboardFeedback, 'Please log in to view users', 'error');
        return;
      }

      // Show loading state
      showUsersLoading();

      try {
        // Current API doesn't support filtering/pagination, so we get all users
        const url = `${backend_url}/admin/users`;
        console.log(' Making request to:', url);
        
        const response = await fetch(url, {
          headers: {
            'Authorization': `Bearer ${currentToken}`,
            'Content-Type': 'application/json'
          }
        });

        console.log(' Response status:', response.status);

        if (response.status === 401) {
          console.log(' Unauthorized, logging out');
          handleLogout(true);
          return;
        }

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();
        console.log(' Received data:', data);
        
        currentUsersData = data;
        // Current API doesn't support pagination, so we'll handle it client-side
        currentUsersTotalCount = data.users ? data.users.length : 0;
        currentUsersTotalPages = Math.ceil(currentUsersTotalCount / currentUsersPageSize);
        
        renderUsersTable();
        updateUsersPagination();

      } catch (error) {
        console.error(' Error loading users:', error);
        showUsersError(error.message || 'Failed to load users data');
        showFeedback(dashboardFeedback, error.message || 'Failed to load users data', 'error');
      }
    }

    // Show loading state
    function showUsersLoading() {
      if (usersTableBody) {
        usersTableBody.innerHTML = `
          <tr>
            <td colspan="7" class="loading-logs">
              <span class="spinner"></span>Loading users...
            </td>
          </tr>
        `;
      }
    }

    // Show error state
    function showUsersError(message) {
      if (usersTableBody) {
        usersTableBody.innerHTML = `
          <tr>
            <td colspan="7" style="text-align: center; padding: 40px; color: #dc2626;">
               ${message}
            </td>
          </tr>
        `;
      }
    }

    async function fetchUserDetail(userId) {
      const url = `${backend_url}/admin/users/${userId}`;
      console.log(' Fetching user detail:', url);
      const response = await fetch(url, {
        headers: {
          Authorization: `Bearer ${currentToken}`,
          'Content-Type': 'application/json',
        },
      });

      if (response.status === 401) {
        handleLogout(true);
        throw new Error('Session expired. Please log in again.');
      }

      if (!response.ok) {
        throw new Error(`Unable to load user detail (status ${response.status})`);
      }

      return response.json();
    }

    function initializeUserFormModal() {
      userFormOverlay = document.getElementById('user-form-overlay');
      userForm = document.getElementById('user-form');
      if (!userFormOverlay || !userForm) {
        console.warn(' User form modal elements missing');
        return;
      }

      userFormTitle = document.getElementById('user-form-title');
      userFormSocietyLabel = document.getElementById('user-form-society');
      userFormSubmitButton = document.getElementById('user-form-submit');
      userFormSubmitText = document.getElementById('user-form-submit-text');
      userFormSubmitSpinner = document.getElementById('user-form-submit-spinner');
      userFormCancelButton = document.getElementById('user-form-cancel');
      userFormErrorBox = document.getElementById('user-form-error');
      userFormNameInput = document.getElementById('user-form-name');
      userFormMobileInput = document.getElementById('user-form-mobile');
      userFormTypeSelect = document.getElementById('user-form-type');
      userFormTowerInput = document.getElementById('user-form-tower');
      userFormFlatInput = document.getElementById('user-form-flat');
      userFormExpireInput = document.getElementById('user-form-expire');
      userFormForeverToggle = document.getElementById('user-form-forever');
      userFormImagesInput = document.getElementById('user-form-images');
      userFormImagesRow = document.getElementById('user-form-images-row');
      userFormExpireRow = document.getElementById('user-form-expire-row');
      userFormExistingContainer = document.getElementById('user-form-existing');
      userFormExistingGrid = document.getElementById('user-form-existing-grid');
      userFormExistingCount = document.getElementById('user-form-existing-count');

      document.querySelectorAll('[data-close-user-form]').forEach((el) => {
        el.addEventListener('click', (event) => {
          if (event.target === el || el.dataset.closeUserForm === 'true') {
            closeUserFormModal();
          }
        });
      });

      if (userFormCancelButton) {
        userFormCancelButton.addEventListener('click', (event) => {
          event.preventDefault();
          closeUserFormModal();
        });
      }

      if (userFormForeverToggle) {
        userFormForeverToggle.addEventListener('change', toggleUserFormExpire);
      }

      if (userFormExistingGrid) {
        userFormExistingGrid.addEventListener('click', handleUserFormExistingImageClick);
      }

      if (userFormImagesInput) {
        userFormImagesInput.addEventListener('change', handleUserFormImagesChange);
      }

      userForm.addEventListener('submit', handleUserFormSubmit);
      renderUserFormExistingImages();
    }

    function openCreateUserModal() {
      if (!currentProfile) {
        showFeedback(dashboardFeedback, 'Profile not loaded. Please log in again.', 'error');
        return;
      }
      userFormMode = 'create';
      editingUserId = null;
      resetUserForm();
      if (userFormTitle) userFormTitle.textContent = 'Register New User';
      if (userFormSubmitText) userFormSubmitText.textContent = 'Register User';
      if (userFormImagesRow) userFormImagesRow.classList.remove('hidden');
      if (userFormImagesInput) userFormImagesInput.required = true;
      if (userFormSocietyLabel) {
        userFormSocietyLabel.textContent = `${currentProfile.society}, ${currentProfile.city}, ${currentProfile.state}`;
      }
      toggleUserFormExpire();
      userFormOverlay.classList.remove('hidden');
      document.body.style.setProperty('overflow', 'hidden');
    }

    async function openEditUserModal(userId) {
      if (!currentToken) {
        showFeedback(dashboardFeedback, 'Please log in to edit users', 'error');
        return;
      }
      userFormMode = 'edit';
      editingUserId = userId;
      resetUserForm();
      try {
        const detail = await fetchUserDetail(userId);
        const user = detail?.user;
        if (!user) {
          throw new Error('User details unavailable');
        }

        const imagePaths = Array.isArray(user.images) ? user.images : [];
        const imageUrls = Array.isArray(user.image_urls) ? user.image_urls : [];
        editingUserImages = imagePaths.map((path, index) => ({
          path,
          url: imageUrls[index] || null,
        })).filter(item => item.path);
        userFormRemovedImages = new Set();
        renderUserFormExistingImages();

        if (userFormTitle) userFormTitle.textContent = 'Edit User Details';
        if (userFormSubmitText) userFormSubmitText.textContent = 'Save Changes';
        if (userFormImagesRow) userFormImagesRow.classList.remove('hidden');
        if (userFormImagesInput) {
          userFormImagesInput.required = false;
          userFormImagesInput.value = '';
        }
        if (userFormSocietyLabel) {
          userFormSocietyLabel.textContent = `${currentProfile?.society ?? ''}, ${currentProfile?.city ?? ''}, ${currentProfile?.state ?? ''}`;
        }

        prefillUserForm(user);
        toggleUserFormExpire();
        userFormOverlay.classList.remove('hidden');
        document.body.style.setProperty('overflow', 'hidden');
      } catch (error) {
        console.error(' Failed to load user detail for edit:', error);
        showFeedback(dashboardFeedback, error?.message || 'Unable to load user details', 'error');
        editingUserId = null;
        userFormMode = 'create';
      }
    }

    function resetUserForm(user) {
      if (userFormErrorBox) {
        userFormErrorBox.classList.add('hidden');
        userFormErrorBox.textContent = '';
      }
      if (userFormSubmitButton) {
        userFormSubmitButton.disabled = false;
      }
      if (userFormSubmitSpinner) {
        userFormSubmitSpinner.classList.add('hidden');
      }
      if (userFormSubmitText) {
        userFormSubmitText.textContent = userFormMode === 'edit' ? 'Save Changes' : 'Register User';
      }
      editingUserImages = [];
      userFormRemovedImages = new Set();
      if (userFormImagesInput) {
        userFormImagesInput.value = '';
      }
      renderUserFormExistingImages();
      if (!user) {
        if (userFormNameInput) userFormNameInput.value = '';
        if (userFormMobileInput) userFormMobileInput.value = '';
        if (userFormTypeSelect) userFormTypeSelect.value = '';
        if (userFormTowerInput) userFormTowerInput.value = '';
        if (userFormFlatInput) userFormFlatInput.value = '';
        if (userFormExpireInput) userFormExpireInput.value = '';
        if (userFormForeverToggle) userFormForeverToggle.checked = false;
        if (userFormImagesInput) userFormImagesInput.value = '';
      }
    }

    function prefillUserForm(user) {
      if (!user) return;
      if (userFormNameInput) userFormNameInput.value = user.name || '';
      if (userFormMobileInput) userFormMobileInput.value = user.mobile_number || '';
      if (userFormTypeSelect) userFormTypeSelect.value = (user.user_type || '').toLowerCase();
      if (userFormTowerInput) userFormTowerInput.value = user.tower_name || '';
      if (userFormFlatInput) userFormFlatInput.value = user.flat_number || '';
      if (userFormForeverToggle) userFormForeverToggle.checked = Boolean(user.forever_access);
      if (userFormExpireInput) {
        if (user.forever_access) {
          userFormExpireInput.value = '';
        } else if (user.expire_at) {
          const dateValue = new Date(user.expire_at);
          if (!Number.isNaN(dateValue.getTime())) {
            userFormExpireInput.value = dateValue.toISOString().split('T')[0];
          } else {
            userFormExpireInput.value = user.expire_at.slice(0, 10);
          }
        } else {
          userFormExpireInput.value = '';
        }
      }
    }

    function closeUserFormModal() {
      if (userFormOverlay) {
        userFormOverlay.classList.add('hidden');
      }
      editingUserId = null;
      userFormMode = 'create';
      resetUserForm();
      document.body.style.removeProperty('overflow');
    }

    function toggleUserFormExpire() {
      const forever = userFormForeverToggle?.checked;
      if (userFormExpireRow) {
        userFormExpireRow.classList.toggle('hidden', Boolean(forever));
      }
      if (userFormExpireInput) {
        userFormExpireInput.required = !forever;
        if (forever) {
          userFormExpireInput.value = '';
        }
      }
    }

    function getRemainingImageCount() {
  return editingUserImages.filter((image) => !userFormRemovedImages.has(image.path)).length;
}

    function updateUserFormImageCounters() {
  if (!userFormExistingCount) {
    return;
  }
  const remaining = getRemainingImageCount();
  const newFileCount = userFormImagesInput?.files ? userFormImagesInput.files.length : 0;
  userFormExistingCount.textContent = `Keeping ${remaining}  New ${newFileCount}  Max ${MAX_USER_IMAGES}`;
}

    function renderUserFormExistingImages() {
  if (!userFormExistingContainer || !userFormExistingGrid) {
    return;
  }

  if (!editingUserImages || editingUserImages.length === 0) {
    userFormExistingContainer.classList.add('hidden');
    userFormExistingGrid.innerHTML = '';
    updateUserFormImageCounters();
    return;
  }

  userFormExistingContainer.classList.remove('hidden');
  const cards = editingUserImages.map((image) => {
    const isRemoved = userFormRemovedImages.has(image.path);
    const imageContent = image.url
      ? `<img src="${image.url}" alt="User photo" />`
      : '<div class="user-form-existing-placeholder"></div>';
    const buttonLabel = isRemoved ? 'Undo Remove' : 'Remove';
    const cardClass = isRemoved ? 'user-form-existing-card removed' : 'user-form-existing-card';
    return `
      <div class="${cardClass}" data-image-path="${image.path}">
        ${imageContent}
        <button type="button" class="user-form-existing-toggle" data-remove-image="${image.path}">
          ${buttonLabel}
        </button>
      </div>
    `;
  }).join('');

  userFormExistingGrid.innerHTML = cards;
  updateUserFormImageCounters();
}

    function handleUserFormExistingImageClick(event) {
  const button = event.target.closest('[data-remove-image]');
  if (!button) {
    return;
  }
  const path = button.dataset.removeImage;
  if (!path) {
    return;
  }
  if (userFormRemovedImages.has(path)) {
    userFormRemovedImages.delete(path);
  } else {
    userFormRemovedImages.add(path);
  }
  renderUserFormExistingImages();
}

    function handleUserFormImagesChange(event) {
  const files = Array.from(event?.target?.files || userFormImagesInput?.files || []);
  const remaining = getRemainingImageCount();
  if (files.length + remaining > MAX_USER_IMAGES) {
    const allowed = Math.max(0, MAX_USER_IMAGES - remaining);
    if (userFormErrorBox) {
      userFormErrorBox.textContent = allowed > 0
        ? `You can add up to ${allowed} more image${allowed === 1 ? '' : 's'}.`
        : 'Remove existing images before uploading new ones.';
      userFormErrorBox.classList.remove('hidden');
    }
    if (userFormImagesInput) {
      userFormImagesInput.value = '';
    }
    return;
  }
  if (userFormErrorBox && userFormErrorBox.textContent?.startsWith('You can add up to')) {
    userFormErrorBox.classList.add('hidden');
    userFormErrorBox.textContent = '';
  }
  updateUserFormImageCounters();
}

    function shouldUpdateImages() {
  const newFileCount = userFormImagesInput?.files ? userFormImagesInput.files.length : 0;
  return userFormRemovedImages.size > 0 || newFileCount > 0;
}

    function getStatusChipClass(status) {
      const normalized = (status || '').toLowerCase();
      if (normalized === 'active') return 'active';
      if (normalized === 'inactive') return 'inactive';
      if (normalized === 'pending') return 'pending';
      return 'pending';
    }

    function formatUserLabel(value) {
      if (!value) return '';
      return value
        .split(' ')
        .map((word) => word.charAt(0).toUpperCase() + word.slice(1))
        .join(' ');
    }

    function initializeUserDetailModal() {
      if (userDetailModalInitialized || !userDetailOverlay) {
        return;
      }
      if (userDetailCloseButton) {
        userDetailCloseButton.addEventListener('click', closeUserDetailModal);
      }
      if (userDetailBackdrop) {
        userDetailBackdrop.addEventListener('click', closeUserDetailModal);
      }
      document.addEventListener('keydown', (event) => {
        if (event.key === 'Escape' && !userDetailOverlay.classList.contains('hidden')) {
          closeUserDetailModal();
        }
      });
      userDetailModalInitialized = true;
    }

    function openUserDetailModal() {
      if (!userDetailOverlay) return;
      userDetailOverlay.classList.remove('hidden');
      userDetailOverlay.setAttribute('aria-modal', 'true');
      userDetailOverlay.setAttribute('role', 'dialog');
      document.body.style.setProperty('overflow', 'hidden');
    }

    function closeUserDetailModal() {
      if (!userDetailOverlay) return;
      userDetailOverlay.classList.add('hidden');
      userDetailOverlay.removeAttribute('aria-modal');
      userDetailOverlay.removeAttribute('role');
      if (userDetailError) {
        userDetailError.classList.add('hidden');
        userDetailError.textContent = '';
      }
      if (userDetailContent) {
        userDetailContent.classList.add('hidden');
      }
      if (userDetailLoading) {
        userDetailLoading.classList.add('hidden');
      }
      if (userDetailInfo) {
        userDetailInfo.innerHTML = '';
      }
      if (userDetailGallery) {
        userDetailGallery.innerHTML = '';
        userDetailGallery.classList.remove('empty');
      }
      if (userDetailLogsBody) {
        userDetailLogsBody.innerHTML = '';
      }
      document.body.style.removeProperty('overflow');
    }

    async function openUserDetail(userId) {
      if (!currentToken) {
        showFeedback(dashboardFeedback, 'Please log in to view user details', 'error');
        return;
      }
      initializeUserDetailModal();
      if (!userDetailOverlay) {
        showFeedback(dashboardFeedback, 'User detail modal is unavailable', 'error');
        return;
      }
      openUserDetailModal();
      if (userDetailLoading) userDetailLoading.classList.remove('hidden');
      if (userDetailContent) userDetailContent.classList.add('hidden');
      if (userDetailError) {
        userDetailError.classList.add('hidden');
        userDetailError.textContent = '';
      }
      try {
        const detail = await fetchUserDetail(userId);
        renderUserDetail(detail);
        if (userDetailLoading) userDetailLoading.classList.add('hidden');
        if (userDetailContent) userDetailContent.classList.remove('hidden');
      } catch (error) {
        console.error(' Failed to load user detail:', error);
        if (userDetailLoading) userDetailLoading.classList.add('hidden');
        if (userDetailError) {
          userDetailError.textContent = error?.message || 'Unable to load user detail';
          userDetailError.classList.remove('hidden');
        }
        showFeedback(dashboardFeedback, error?.message || 'Unable to load user detail', 'error');
      }
    }

    function renderUserDetail(detail) {
      const user = detail?.user || {};
      const logs = Array.isArray(detail?.daily_logs) ? detail.daily_logs : [];
      const locationLine = [user.society, user.city, user.state].filter(Boolean).join(', ');
      const statusClass = getStatusChipClass(user.status);
      const statusLabel = formatUserLabel(user.status || 'Unknown');
      const typeLabel = formatUserLabel(user.user_type);
      const flatLabel = user.flat_number ? `Flat ${user.flat_number}` : '';
      const towerLabel = user.tower_name ? `Tower ${user.tower_name}` : '';
      const contactLabel = user.mobile_number ? `Mobile ${user.mobile_number}` : '';
      const accessLabel = user.forever_access
        ? 'Forever access'
        : user.expire_at
          ? `Access till ${formatDateTimeIST(user.expire_at)}`
          : 'No expiry set';

      if (userDetailInfo) {
        userDetailInfo.innerHTML = `
          <div>
            <div class="user-detail-name">${user.name || 'Unknown User'}</div>
            <div class="user-detail-meta">
              ${locationLine ? `<span>${locationLine}</span>` : ''}
              ${typeLabel ? `<span>${typeLabel}</span>` : ''}
            </div>
          </div>
          <div class="user-detail-meta">
            <span class="status-chip ${statusClass}">${statusLabel}</span>
            ${contactLabel ? `<span>${contactLabel}</span>` : ''}
            ${towerLabel ? `<span>${towerLabel}</span>` : ''}
            ${flatLabel ? `<span>${flatLabel}</span>` : ''}
            <span>${accessLabel}</span>
          </div>
        `;
      }

      if (userDetailGallery) {
        const images = Array.isArray(user.image_urls) ? user.image_urls.filter(Boolean) : [];
        if (images.length === 0) {
          userDetailGallery.classList.add('empty');
          userDetailGallery.innerHTML = '<div class="user-detail-gallery-placeholder">No images available.</div>';
        } else {
          userDetailGallery.classList.remove('empty');
          userDetailGallery.innerHTML = images.map((url, index) => `
            <figure>
              <img src="${url}" alt="User photo ${index + 1}" />
              <figcaption>Photo ${index + 1}</figcaption>
            </figure>
          `).join('');
        }
      }

      if (userDetailLogsBody) {
        if (logs.length === 0) {
          userDetailLogsBody.innerHTML = `
            <tr>
              <td colspan="6" style="text-align:center; padding: 20px; color: #64748b;">
                No access activity captured for this user yet.
              </td>
            </tr>
          `;
        } else {
          userDetailLogsBody.innerHTML = logs.map((log) => {
            const logDate = log.date ? new Date(log.date) : null;
            const dateLabel = logDate && !Number.isNaN(logDate.getTime())
              ? formatDateOnly(logDate)
              : (log.date || '-');
            return `
              <tr>
                <td>${dateLabel}</td>
                <td>${log.total_logs ?? 0}</td>
                <td>${log.entries ?? 0}</td>
                <td>${log.exits ?? 0}</td>
                <td>${formatDateTimeIST(log.first_entry)}</td>
                <td>${formatDateTimeIST(log.last_exit)}</td>
              </tr>
            `;
          }).join('');
        }
      }
    }

    function setUserFormLoading(isLoading) {
      if (!userFormSubmitButton || !userFormSubmitText) return;
      userFormSubmitButton.disabled = isLoading;
      if (userFormSubmitSpinner) {
        userFormSubmitSpinner.classList.toggle('hidden', !isLoading);
      }
      if (isLoading) {
        userFormSubmitText.textContent = userFormMode === 'edit' ? 'Saving' : 'Registering';
      } else {
        userFormSubmitText.textContent = userFormMode === 'edit' ? 'Save Changes' : 'Register User';
      }
    }

    async function handleUserFormSubmit(event) {
      event.preventDefault();
      if (!currentToken) {
        showFeedback(dashboardFeedback, 'Authentication required. Please log in again.', 'error');
        return;
      }
      setUserFormLoading(true);
      if (userFormErrorBox) {
        userFormErrorBox.classList.add('hidden');
        userFormErrorBox.textContent = '';
      }
      try {
        const mode = userFormMode;
        if (mode === 'edit') {
          await submitSocietyUserUpdate();
          if (shouldUpdateImages()) {
            await submitSocietyUserImagesUpdate();
          }
        } else {
          await submitNewSocietyUser();
        }
        closeUserFormModal();
        await loadUsers();
        showFeedback(
          dashboardFeedback,
          mode === 'edit' ? 'User details updated successfully' : 'User registered successfully',
          'success'
        );
      } catch (error) {
        console.error(' User form submission error:', error);
        const message = error?.message || 'Unable to process request';
        if (userFormErrorBox) {
          userFormErrorBox.textContent = message;
          userFormErrorBox.classList.remove('hidden');
        }
        showFeedback(dashboardFeedback, message, 'error');
      } finally {
        setUserFormLoading(false);
      }
    }

    async function submitNewSocietyUser() {
      if (!currentProfile) {
        throw new Error('Admin profile unavailable');
      }
      if (!userFormNameInput || !userFormMobileInput || !userFormTypeSelect) {
        throw new Error('Form not ready');
      }
      const name = userFormNameInput.value.trim();
      const mobile = userFormMobileInput.value.trim();
      const userType = userFormTypeSelect.value.trim();
      const flat = userFormFlatInput?.value.trim();
      const tower = userFormTowerInput?.value.trim();
      const forever = Boolean(userFormForeverToggle?.checked);
      const expireValue = userFormExpireInput?.value ?? '';

      if (!name) {
        throw new Error('Please enter the user name');
      }
      if (!mobile) {
        throw new Error('Please enter a mobile number');
      }
      if (!userType) {
        throw new Error('Please select a user type');
      }
      if (userType === 'resident' && !flat) {
        throw new Error('Flat number is required for residents');
      }
      if (!forever && !expireValue) {
        throw new Error('Select an expiry date or mark as forever access');
      }
      if (!userFormImagesInput || userFormImagesInput.files.length === 0) {
        throw new Error('Please upload at least one face image');
      }
      if (userFormImagesInput.files.length > MAX_USER_IMAGES) {
        throw new Error(`You can upload up to ${MAX_USER_IMAGES} images.`);
      }

      const formData = new FormData();
      formData.append('state_name', currentProfile.state);
      formData.append('city_name', currentProfile.city);
      formData.append('society_name', currentProfile.society);
      if (tower) {
        formData.append('tower_name', tower);
      }
      if (flat) {
        formData.append('flat_number', flat);
      }
      formData.append('user_name', name);
      formData.append('mobile_number', mobile);
      formData.append('user_type', userType);
      if (forever) {
        formData.append('forever_access', 'true');
      } else {
        formData.append('expire_at', expireValue);
      }
      Array.from(userFormImagesInput.files).forEach((file) => {
        formData.append('images', file, file.name);
      });

      const response = await fetch(`${backend_url}/register-user`, {
        method: 'POST',
        headers: {
          Authorization: `Bearer ${currentToken}`,
        },
        body: formData,
      });

      if (!response.ok) {
        const errorPayload = await response.json().catch(() => ({}));
        const detail = errorPayload?.detail || errorPayload?.message || `Request failed (${response.status})`;
        throw new Error(detail);
      }
    }

    async function submitSocietyUserUpdate() {
      if (!editingUserId) {
        throw new Error('No user selected for editing');
      }
      if (!userFormNameInput || !userFormTypeSelect || !userFormMobileInput) {
        throw new Error('Form not ready');
      }

      const name = userFormNameInput.value.trim();
      const mobile = userFormMobileInput.value.trim();
      const userType = userFormTypeSelect.value.trim();
      const tower = userFormTowerInput ? userFormTowerInput.value.trim() : '';
      const flat = userFormFlatInput ? userFormFlatInput.value.trim() : '';
      const forever = Boolean(userFormForeverToggle?.checked);
      const expireValue = userFormExpireInput?.value ?? '';

      if (!name) {
        throw new Error('Please enter the user name');
      }
      if (!mobile) {
        throw new Error('Please enter a mobile number');
      }
      if (!userType) {
        throw new Error('Please select a user type');
      }
      if (userType === 'resident' && (!flat || !flat.trim())) {
        throw new Error('Flat number is required for residents');
      }
      if (!forever && !expireValue) {
        throw new Error('Select an expiry date or mark as forever access');
      }

      const payload = {
        name,
        mobile_number: mobile,
        user_type: userType,
        tower_name: tower,
        flat_number: flat,
        forever_access: forever,
        expire_at: forever ? null : expireValue,
      };

      const response = await fetch(`${backend_url}/admin/users/${editingUserId}`, {
        method: 'PATCH',
        headers: {
          Authorization: `Bearer ${currentToken}`,
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(payload),
      });

      if (!response.ok) {
        const errorPayload = await response.json().catch(() => ({}));
        const detail = errorPayload?.detail || errorPayload?.message || `Request failed (${response.status})`;
        throw new Error(detail);
      }
    }

    async function submitSocietyUserImagesUpdate() {
      if (!editingUserId) {
        throw new Error('No user selected for editing');
      }

      const removal = Array.from(userFormRemovedImages);
      const newFiles = userFormImagesInput?.files ? Array.from(userFormImagesInput.files) : [];
      if (removal.length === 0 && newFiles.length === 0) {
        return;
      }

      const remaining = getRemainingImageCount();
      if (remaining + newFiles.length > MAX_USER_IMAGES) {
        throw new Error(`Total images cannot exceed ${MAX_USER_IMAGES}`);
      }

      const formData = new FormData();
      removal.forEach((path) => formData.append('images_to_remove', path));
      newFiles.forEach((file) => formData.append('new_images', file));

      const response = await fetch(`${backend_url}/admin/users/${editingUserId}/images`, {
        method: 'PATCH',
        headers: {
          Authorization: `Bearer ${currentToken}`,
        },
        body: formData,
      });

      if (!response.ok) {
        const errorPayload = await response.json().catch(() => ({}));
        const detail = errorPayload?.detail || errorPayload?.message || `Request failed (${response.status})`;
        throw new Error(detail);
      }
    }

    // Apply filters
    function applyUsersFilters() {
      console.log(' Applying filters...');
      currentUsersPage = 1; // Reset to first page when filters change
      if (currentUsersData) {
        renderUsersTable();
        updateUsersPagination();
      }
    }

    // Clear filters
    function clearUsersFilters() {
      console.log(' Clearing filters...');
      if (usersSearch) usersSearch.value = '';
      if (usersStatusFilter) usersStatusFilter.value = '';
      if (usersTypeFilter) usersTypeFilter.value = '';
      currentUsersPage = 1;
      if (currentUsersData) {
        renderUsersTable();
        updateUsersPagination();
      }
    }

    // Render users table
    function renderUsersTable() {
      console.log(' Rendering users table...');
      
      if (!currentUsersData || !currentUsersData.users || currentUsersData.users.length === 0) {
        if (usersTableBody) {
          usersTableBody.innerHTML = `
            <tr>
              <td colspan="7" style="text-align: center; padding: 40px; color: #6b7280;">
                No users found matching the current filters.
              </td>
            </tr>
          `;
        }
        return;
      }

      // Apply client-side filtering and pagination
      let filteredUsers = currentUsersData.users;
      
      // Apply search filter
      const searchTerm = usersSearch ? usersSearch.value.trim().toLowerCase() : '';
      if (searchTerm) {
        filteredUsers = filteredUsers.filter(user => 
          (user.name && user.name.toLowerCase().includes(searchTerm)) ||
          (user.flat_number && user.flat_number.toLowerCase().includes(searchTerm)) ||
          (user.mobile_number && user.mobile_number.includes(searchTerm))
        );
      }
      
      // Apply status filter
      const statusFilter = usersStatusFilter ? usersStatusFilter.value : '';
      if (statusFilter) {
        filteredUsers = filteredUsers.filter(user => user.status === statusFilter);
      }
      
      // Apply type filter
      const typeFilter = usersTypeFilter ? usersTypeFilter.value : '';
      if (typeFilter) {
        filteredUsers = filteredUsers.filter(user => user.user_type === typeFilter);
      }
      
      // Update total count for pagination
      currentUsersTotalCount = filteredUsers.length;
      currentUsersTotalPages = Math.ceil(currentUsersTotalCount / currentUsersPageSize);
      
      // Apply pagination
      const startIndex = (currentUsersPage - 1) * currentUsersPageSize;
      const endIndex = startIndex + currentUsersPageSize;
      const paginatedUsers = filteredUsers.slice(startIndex, endIndex);

      console.log(` Rendering page ${currentUsersPage}: ${paginatedUsers.length} users (${currentUsersTotalCount} total)`);

      const rows = paginatedUsers.map(user => {
        const statusClass = getStatusChipClass(user.status);
        const statusBadge = formatUserLabel(user.status || 'unknown');
        
        // Format access expiry
        let expiryClass = 'access-expiry';
        let expiryText = 'N/A';
        
        if (user.forever_access) {
          expiryClass = 'access-expiry forever';
          expiryText = 'Forever';
        } else if (user.expire_at) {
          const expiryDate = new Date(user.expire_at);
          const today = new Date();
          const diffDays = Math.floor((expiryDate - today) / (1000 * 60 * 60 * 24));
          
          if (diffDays < 0) {
            expiryClass = 'access-expiry expired';
            expiryText = 'Expired';
          } else if (diffDays <= 7) {
            expiryClass = 'access-expiry expiring-soon';
            expiryText = expiryDate.toLocaleDateString();
          } else {
            expiryClass = 'access-expiry valid';
            expiryText = expiryDate.toLocaleDateString();
          }
        }
        
        const registeredOn = 'N/A'; // API doesn't provide registration date
        
        const thumbnail = user.thumbnail_url ? 
          `<img src="${user.thumbnail_url}" alt="${user.name}" class="user-photo" />` : 
          '<div class="no-photo"></div>';

        return `
          <tr>
            <td>
              <div class="person-cell">
                ${thumbnail}
                <div>
                  <div class="person-name">${user.name || 'Unknown'}</div>
                  <div class="person-meta">${user.flat_number || 'N/A'}</div>
                </div>
              </div>
            </td>
            <td>
              <div>${user.mobile_number || 'N/A'}</div>
              ${user.email ? `<div class="person-meta">${user.email}</div>` : ''}
            </td>
            <td>
              <span class="user-type-badge">${user.user_type || 'N/A'}</span>
            </td>
            <td>
              <span class="status-chip ${statusClass}">${statusBadge}</span>
            </td>
            <td>
              <div class="${expiryClass}">${expiryText}</div>
            </td>
            <td>${registeredOn}</td>
            <td>
              <div class="table-actions">
                <button class="action-secondary" onclick="viewUserDetails('${user.id}')">View</button>
                <button class="action-primary" onclick="openEditUserModal('${user.id}')">Edit</button>
              </div>
            </td>
          </tr>
        `;
      }).join('');

      if (usersTableBody) {
        usersTableBody.innerHTML = rows;
        console.log(' Table rendered successfully');
      }
    }

    // Update pagination
    function updateUsersPagination() {
      if (!currentUsersData) return;

      const totalItems = currentUsersTotalCount;
      const totalPages = currentUsersTotalPages;
      const startItem = (currentUsersPage - 1) * currentUsersPageSize + 1;
      const endItem = Math.min(currentUsersPage * currentUsersPageSize, totalItems);

      if (usersPaginationInfo) {
        if (totalItems === 0) {
          usersPaginationInfo.textContent = 'No users to display.';
        } else {
          usersPaginationInfo.textContent = `Showing ${startItem}-${endItem} of ${totalItems} users`;
        }
      }

      if (usersPrevBtn) {
        usersPrevBtn.disabled = currentUsersPage <= 1;
      }
      if (usersNextBtn) {
        usersNextBtn.disabled = currentUsersPage >= totalPages;
      }

      console.log(` Pagination: Page ${currentUsersPage}/${totalPages}, Items ${startItem}-${endItem}/${totalItems}`);
    }

    // View user details
    function viewUserDetails(userId) {
      console.log(' Viewing user details for:', userId);
      openUserDetail(userId);
    }


    // Load section-specific data
    function loadSectionData(sectionId) {
      console.log(" loadSectionData called with:", sectionId);      console.log(" loadSectionData called with:", sectionId);      switch(sectionId) {
        case 'overview-section':
          initializeWorkingDaysSection();
          loadUserStatistics();
          loadOverviewAnalytics();
          break;
        case 'users-section':
          initializeUsersSection();
          break;
        case 'user-attendance-section':
          initializeAttendanceSection();
          break;
        case 'access-logs-section':
          // Access logs are loaded in activateSection
          break;
        default:
          console.log('No specific data loading for section:', sectionId);
      }
    }


    // ===== WORKING DAYS SECTION =====
    
    // Global variables for working days
    let workingDaysData = null;
    let workingDaysPage = 1;
    let workingDaysPageSize = 10;
    let workingDaysTotalCount = 0;
    let workingDaysTotalPages = 0;
    
    // DOM elements for working days
    let workingDaysPeriod, workingDaysCustomDate, workingDaysDateFrom, workingDaysDateTo;
    let workingDaysSearch, workingDaysStatusFilter, workingDaysPageSizeSelect;
    let workingDaysLoadBtn, workingDaysRefreshBtn, workingDaysDownloadBtn, workingDaysTableBody;
    let workingDaysPaginationInfo, workingDaysPrevBtn, workingDaysNextBtn;
    let workingDaysInitialized = false;
    let workingDaysEventListenersSetup = false;

    // Initialize working days section
    function initializeWorkingDaysSection() {
      if (workingDaysInitialized) {
        console.log(" Working Days section already initialized, skipping...");
        return;
      }
      workingDaysInitialized = true;
      console.log(" Initializing Working Days Section...");
      // Initialize DOM elements
      initializeWorkingDaysDOM();
      updateWorkingDaysCustomDateLimits({ setDefaults: true });
      
      // Add event listeners
      setupWorkingDaysEventListeners();
      
      // Load data automatically
      loadWorkingDays();
    }
    // Initialize DOM elements
    function initializeWorkingDaysDOM() {
      workingDaysPeriod = document.getElementById("working-days-period");
      workingDaysCustomDate = document.getElementById("working-days-custom-date");
      workingDaysDateFrom = document.getElementById("working-days-date-from");
      workingDaysDateTo = document.getElementById("working-days-date-to");
      workingDaysSearch = document.getElementById("working-days-search");
      workingDaysStatusFilter = document.getElementById("working-days-status-filter");
      workingDaysPageSizeSelect = document.getElementById("working-days-page-size");
      workingDaysLoadBtn = document.getElementById("working-days-load-btn");
      workingDaysRefreshBtn = document.getElementById("working-days-refresh-btn");
      workingDaysDownloadBtn = document.getElementById("working-days-download-btn");
      workingDaysTableBody = document.getElementById("working-days-table-body");
      workingDaysPaginationInfo = document.getElementById("working-days-pagination-info");
      workingDaysPrevBtn = document.getElementById("working-days-prev");
      workingDaysNextBtn = document.getElementById("working-days-next");
      
      console.log(" Working Days DOM elements initialized");
      console.log(" DOM Elements found:", {
        workingDaysPeriod: !!workingDaysPeriod,
        workingDaysLoadBtn: !!workingDaysLoadBtn,
        workingDaysRefreshBtn: !!workingDaysRefreshBtn,
        workingDaysTableBody: !!workingDaysTableBody
      });
    }
    // Setup event listeners
    function setupWorkingDaysEventListeners() {
      if (workingDaysEventListenersSetup) {
        console.log(" Working Days event listeners already setup, skipping...");
        return;
      }
      workingDaysEventListenersSetup = true;
      console.log(" Setting up Working Days event listeners...");
      
      if (workingDaysLoadBtn) {
        console.log(" Setting up Load Data button listener for:", workingDaysLoadBtn);
        workingDaysLoadBtn.addEventListener("click", () => {
          console.log(" Load Data button clicked!");
          loadWorkingDays();
        });        
        workingDaysRefreshBtn.addEventListener("click", loadWorkingDays);
        if (workingDaysDownloadBtn) {
          workingDaysDownloadBtn.addEventListener("click", downloadWorkingDaysExcel);
        }
      }
      
      if (workingDaysPeriod) {
        workingDaysPeriod.addEventListener("change", () => {
          const isCustom = workingDaysPeriod.value === "custom";
          if (isCustom) {
            workingDaysCustomDate.classList.remove("hidden");
            updateWorkingDaysCustomDateLimits({ setDefaults: true });
          } else {
            workingDaysCustomDate.classList.add("hidden");
          }
        });
      }

      if (workingDaysDateFrom) {
        workingDaysDateFrom.addEventListener("change", () => {
          updateWorkingDaysCustomDateLimits();
        });
      }

      if (workingDaysDateTo) {
        workingDaysDateTo.addEventListener("change", () => {
          updateWorkingDaysCustomDateLimits();
        });
      }
      
      if (workingDaysSearch) {
        workingDaysSearch.addEventListener("input", debounce(applyWorkingDaysFilters, 300));
      }
      
      if (workingDaysStatusFilter) {
        workingDaysStatusFilter.addEventListener("change", applyWorkingDaysFilters);
      }
      
      if (workingDaysPageSizeSelect) {
        workingDaysPageSizeSelect.addEventListener("change", (e) => {
          workingDaysPageSize = parseInt(e.target.value);
          workingDaysPage = 1;
          loadWorkingDays();
        });
      }
      
      if (workingDaysPrevBtn) {
        workingDaysPrevBtn.addEventListener("click", () => {
          if (workingDaysPage > 1) {
            workingDaysPage--;
            loadWorkingDays();
          }
        });
      }
      
      if (workingDaysNextBtn) {
        workingDaysNextBtn.addEventListener("click", () => {
          if (workingDaysPage < workingDaysTotalPages) {
            workingDaysPage++;
            loadWorkingDays();
          }
        });
      }
      
      console.log(" Working Days event listeners added");
    }

    // Load working days data using the new API
    async function loadWorkingDays() {
      console.log(" Loading working days data...");
      
      if (!currentToken) {
        showFeedback(dashboardFeedback, "Please log in to view working days data", "error");
        return;
      }

      // Show loading state
      showWorkingDaysLoading();

      try {
        // Calculate date range
        const dateRange = getWorkingDaysDateRange();
        if (!dateRange.from || !dateRange.to) {
          showFeedback(dashboardFeedback, "Please select a valid date range", "error");
          return;
        }

        // Build query parameters
        const params = new URLSearchParams({
          date_from: dateRange.from,
          date_to: dateRange.to,
          page: workingDaysPage.toString(),
          page_size: workingDaysPageSize.toString()
        });

        // Add filters
        const searchTerm = workingDaysSearch ? workingDaysSearch.value.trim() : "";
        if (searchTerm) {
          params.append("search", searchTerm);
        }

        const statusFilter = workingDaysStatusFilter ? workingDaysStatusFilter.value : "";
        if (statusFilter) {
          params.append("status_filter", statusFilter);
        }

        const url = `${backend_url}/admin/users/working-days?${params}`;
        console.log(" Making request to:", url);
        
        const response = await fetch(url, {
          headers: {
            "Authorization": `Bearer ${currentToken}`,
            "Content-Type": "application/json"
          }
        });

        console.log(" Response status:", response.status);

        if (response.status === 401) {
          console.log(" Unauthorized, logging out");
          handleLogout(true);
          return;
        }

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();
        console.log(" Received data:", data);
        
        workingDaysData = data;
        workingDaysTotalCount = data.pagination.total_count;
        workingDaysTotalPages = data.pagination.total_pages;
        
        renderWorkingDaysTable();
        updateWorkingDaysPagination();

      } catch (error) {
        console.error(" Error loading working days:", error);
        showWorkingDaysError(error.message || "Failed to load working days data");
        showFeedback(dashboardFeedback, error.message || "Failed to load working days data", "error");
      }
    }

    async function downloadWorkingDaysExcel() {
      console.log(" Downloading working days data...");

      if (!currentToken) {
        showFeedback(dashboardFeedback, "Please log in to download working days data", "error");
        return;
      }

      const dateRange = getWorkingDaysDateRange();
      if (!dateRange.from || !dateRange.to) {
        showFeedback(dashboardFeedback, "Please select a valid date range before downloading", "error");
        return;
      }

      let originalLabel = "Download Excel";
      if (workingDaysDownloadBtn) {
        originalLabel = workingDaysDownloadBtn.textContent;
        workingDaysDownloadBtn.disabled = true;
        workingDaysDownloadBtn.textContent = "Preparing...";
      }

      try {
        const allUsers = [];
        let pageToFetch = 1;
        const exportPageSize = 200;

        while (true) {
          const params = new URLSearchParams({
            date_from: dateRange.from,
            date_to: dateRange.to,
            page: pageToFetch.toString(),
            page_size: exportPageSize.toString()
          });

          const searchTerm = workingDaysSearch ? workingDaysSearch.value.trim() : "";
          if (searchTerm) {
            params.append("search", searchTerm);
          }

          const statusFilter = workingDaysStatusFilter ? workingDaysStatusFilter.value : "";
          if (statusFilter) {
            params.append("status_filter", statusFilter);
          }

          const url = `${backend_url}/admin/users/working-days?${params}`;
          const response = await fetch(url, {
            headers: {
              "Authorization": `Bearer ${currentToken}`,
              "Content-Type": "application/json"
            }
          });

          if (!response.ok) {
            throw new Error(`Export failed (status ${response.status})`);
          }

          const data = await response.json();
          if (Array.isArray(data.users)) {
            allUsers.push(...data.users);
          }

          const pagination = data.pagination || {};
          if (!pagination.has_next) {
            break;
          }

          pageToFetch += 1;

          if (pageToFetch > 1000) {
            console.warn("Stopping export after 1000 pages to avoid infinite loop");
            break;
          }
        }

        if (allUsers.length === 0) {
          showFeedback(dashboardFeedback, "No working days data found for export", "error");
          return;
        }

        exportWorkingDaysToExcel(allUsers, dateRange);
        showFeedback(dashboardFeedback, `Downloaded ${allUsers.length} records`, "success");
      } catch (error) {
        console.error(" Error downloading working days data:", error);
        showFeedback(dashboardFeedback, error.message || "Failed to download working days data", "error");
      } finally {
        if (workingDaysDownloadBtn) {
          workingDaysDownloadBtn.disabled = false;
          workingDaysDownloadBtn.textContent = originalLabel;
        }
      }
    }

    function exportWorkingDaysToExcel(users, dateRange) {
      const headers = [
        "Name",
        "Flat Number",
        "User Type",
        "Status",
        "Working Days",
        "Total Entries",
        "First Access",
        "Last Access",
        "Mobile Number",
        "Forever Access",
        "Access Expires"
      ];

      const headerRow = `<tr>${headers.map(h => `<th>${escapeExcelCell(h)}</th>`).join("")}</tr>`;

      const rows = users.map(user => {
        return `<tr>
          <td>${escapeExcelCell(user.name || "Unknown")}</td>
          <td>${escapeExcelCell(user.flat_number || "")}</td>
          <td>${escapeExcelCell(user.user_type || "")}</td>
          <td>${escapeExcelCell(user.status || "")}</td>
          <td>${escapeExcelCell(user.working_days ?? 0)}</td>
          <td>${escapeExcelCell(user.total_entries ?? 0)}</td>
          <td>${escapeExcelCell(formatExcelDate(user.first_access))}</td>
          <td>${escapeExcelCell(formatExcelDate(user.last_access))}</td>
          <td>${escapeExcelCell(user.mobile_number || "")}</td>
          <td>${escapeExcelCell(user.forever_access ? "Yes" : "No")}</td>
          <td>${escapeExcelCell(formatExcelDate(user.expire_at))}</td>
        </tr>`;
      }).join("");

      const tableHtml = `<table>${headerRow}${rows}</table>`;
      const workbookHtml = `<html><head><meta charset="utf-8" /></head><body>${tableHtml}</body></html>`;
      const blob = new Blob(["\ufeff" + workbookHtml], { type: "application/vnd.ms-excel" });
      const downloadUrl = URL.createObjectURL(blob);

      const safeFrom = sanitizeFileName(dateRange.from || "start");
      const safeTo = sanitizeFileName(dateRange.to || "end");
      const filename = `working-days-${safeFrom}-to-${safeTo}.xls`;

      const link = document.createElement("a");
      link.href = downloadUrl;
      link.download = filename;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(downloadUrl);
    }

    function escapeExcelCell(value) {
      if (value === null || value === undefined) {
        return "";
      }
      return String(value)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;");
    }

    function sanitizeFileName(value) {
      return value.replace(/[^a-z0-9\-]+/gi, "-").replace(/-+/g, "-");
    }

    function formatExcelDate(value) {
      if (!value) {
        return "";
      }
      const date = new Date(value);
      if (Number.isNaN(date.getTime())) {
        return value;
      }
      return date.toISOString().replace("T", " ").split(".")[0];
    }

    function formatDateOnly(date) {
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, "0");
      const day = String(date.getDate()).padStart(2, "0");
      return `${year}-${month}-${day}`;
    }

    function updateWorkingDaysCustomDateLimits({ setDefaults = false } = {}) {
      if (!workingDaysDateFrom || !workingDaysDateTo) {
        return;
      }

      const today = new Date();
      today.setHours(0, 0, 0, 0);
      const maxDate = formatDateOnly(today);
      const minDateObj = new Date(today);
      minDateObj.setMonth(minDateObj.getMonth() - 3);
      const minDate = formatDateOnly(minDateObj);

      workingDaysDateFrom.min = minDate;
      workingDaysDateFrom.max = maxDate;
      workingDaysDateTo.min = minDate;
      workingDaysDateTo.max = maxDate;

      if (setDefaults) {
        if (!workingDaysDateFrom.value || workingDaysDateFrom.value < minDate || workingDaysDateFrom.value > maxDate) {
          workingDaysDateFrom.value = minDate;
        }
        if (!workingDaysDateTo.value || workingDaysDateTo.value < workingDaysDateFrom.value || workingDaysDateTo.value > maxDate) {
          workingDaysDateTo.value = maxDate;
        }
      } else {
        if (workingDaysDateFrom.value) {
          if (workingDaysDateFrom.value < minDate) {
            workingDaysDateFrom.value = minDate;
          } else if (workingDaysDateFrom.value > maxDate) {
            workingDaysDateFrom.value = maxDate;
          }
        }

        if (workingDaysDateTo.value) {
          if (workingDaysDateTo.value > maxDate) {
            workingDaysDateTo.value = maxDate;
          }
          if (workingDaysDateFrom.value && workingDaysDateTo.value < workingDaysDateFrom.value) {
            workingDaysDateTo.value = workingDaysDateFrom.value;
          }
        }
      }

      if (workingDaysDateFrom.value) {
        workingDaysDateTo.min = workingDaysDateFrom.value;
        if (workingDaysDateTo.value && workingDaysDateTo.value < workingDaysDateFrom.value) {
          workingDaysDateTo.value = workingDaysDateFrom.value;
        }
      }
    }

    // Get date range from selection
    function getWorkingDaysDateRange() {
      const period = workingDaysPeriod ? workingDaysPeriod.value : "today";
      const today = new Date();
      today.setHours(0, 0, 0, 0);

      if (period === "custom") {
        updateWorkingDaysCustomDateLimits();
        const from = workingDaysDateFrom ? workingDaysDateFrom.value : "";
        const to = workingDaysDateTo ? workingDaysDateTo.value : "";
        if (!from || !to || from > to) {
          return { from: "", to: "" };
        }
        return { from, to };
      }

      switch (period) {
        case "today":
          return {
            from: formatDateOnly(today),
            to: formatDateOnly(today)
          };
        case "tomorrow": {
          const tomorrow = new Date(today);
          tomorrow.setDate(tomorrow.getDate() + 1);
          return {
            from: formatDateOnly(tomorrow),
            to: formatDateOnly(tomorrow)
          };
        }
        case "this_week": {
          const startOfWeek = new Date(today);
          const day = startOfWeek.getDay();
          const diffToMonday = (day + 6) % 7;
          startOfWeek.setDate(startOfWeek.getDate() - diffToMonday);
          return {
            from: formatDateOnly(startOfWeek),
            to: formatDateOnly(today)
          };
        }
        case "this_month": {
          const startOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
          return {
            from: formatDateOnly(startOfMonth),
            to: formatDateOnly(today)
          };
        }
        default:
          return {
            from: formatDateOnly(today),
            to: formatDateOnly(today)
          };
      }
    }

    // Show loading state
    function showWorkingDaysLoading() {
      if (workingDaysTableBody) {
        workingDaysTableBody.innerHTML = `
          <tr>
            <td colspan="8" class="loading-logs">
              <span class="spinner"></span>Loading working days data...
            </td>
          </tr>
        `;
      }
    }

    // Show error state
    function showWorkingDaysError(message) {
      if (workingDaysTableBody) {
        workingDaysTableBody.innerHTML = `
          <tr>
            <td colspan="8" style="text-align: center; padding: 40px; color: #dc2626;">
               ${message}
            </td>
          </tr>
        `;
      }
    }

    // Apply filters
    function applyWorkingDaysFilters() {
      console.log(" Applying filters...");
      workingDaysPage = 1;
      loadWorkingDays();
    }

    // Render working days table
    function renderWorkingDaysTable() {
      console.log(" Rendering working days table...");
      
      if (!workingDaysData || !workingDaysData.users || workingDaysData.users.length === 0) {
        if (workingDaysTableBody) {
          workingDaysTableBody.innerHTML = `
            <tr>
              <td colspan="8" style="text-align: center; padding: 40px; color: #6b7280;">
                No users found matching the current filters.
              </td>
            </tr>
          `;
        }
        return;
      }

      console.log(` Rendering page ${workingDaysPage}: ${workingDaysData.users.length} users`);

      const rows = workingDaysData.users.map(user => {
        const statusClass = getStatusChipClass(user.status);
        
        const thumbnail = user.thumbnail_url ? 
          `<img src="${user.thumbnail_url}" alt="${user.name}" class="user-photo" />` : 
          `<div class="no-photo"></div>`;

        return `
          <tr>
            <td>
              <div class="person-cell">
                ${thumbnail}
                <div>
                  <div class="person-name">${user.name || "Unknown"}</div>
                  <div class="person-meta">${user.flat_number || "N/A"}</div>
                </div>
              </div>
            </td>
            <td>
              <div>${user.mobile_number || "N/A"}</div>
              ${user.email ? `<div class="person-meta">${user.email}</div>` : ""}
            </td>
            <td>
              <span class="user-type-badge">${formatUserLabel(user.user_type || "N/A")}</span>
            </td>
            <td>
              <span class="status-chip ${statusClass}">${formatUserLabel(user.status || "unknown")}</span>
            </td>
            <td>
              <strong style="font-size: 18px; color: #2a9df4;">${user.working_days || 0}</strong>
            </td>
            <td>${user.total_entries || 0}</td>
            <td>${formatDateTimeIST(user.first_access)}</td>
            <td>${formatDateTimeIST(user.last_access)}</td>
          </tr>
        `;
      }).join("");
      if (workingDaysTableBody) {
        workingDaysTableBody.innerHTML = rows;
        console.log(" Table rendered successfully");
      }
    }

    // Update pagination
    function updateWorkingDaysPagination() {
      if (!workingDaysData) return;

      const totalItems = workingDaysTotalCount;
      const totalPages = workingDaysTotalPages;
      const startItem = (workingDaysPage - 1) * workingDaysPageSize + 1;
      const endItem = Math.min(workingDaysPage * workingDaysPageSize, totalItems);

      if (workingDaysPaginationInfo) {
        if (totalItems === 0) {
          workingDaysPaginationInfo.textContent = "No users to display.";
        } else {
          workingDaysPaginationInfo.textContent = `Showing ${startItem}-${endItem} of ${totalItems} users`;
        }
      }

      if (workingDaysPrevBtn) {
        workingDaysPrevBtn.disabled = workingDaysPage <= 1;
      }
      if (workingDaysNextBtn) {
        workingDaysNextBtn.disabled = workingDaysPage >= totalPages;
      }

      console.log(` Pagination: Page ${workingDaysPage}/${totalPages}, Items ${startItem}-${endItem}/${totalItems}`);
    }

    // Initialize the dashboard
    checkAuthentication();
    setupUserManagementEventListeners();
    initializeUserFormModal();
    initializeUserDetailModal();
    initializeVisitorSection();
    initializeWorkingDaysSection();
    loadUserStatistics(); // Load user stats on page load since overview is active by default
    loadOverviewAnalytics();
    loadVisitorPasses();
  </script>
</body>
</html>
  <div id="visitor-preview-overlay" class="modal-overlay hidden">
    <div class="visitor-preview-modal">
      <button type="button" class="modal-close" id="visitor-close-preview" aria-label="Close preview">&times;</button>
      <div id="visitor-pass-preview" class="visitor-pass-preview hidden">
        <div class="preview-header">
          <h4>Visitor Pass Ready</h4>
        </div>
        <div class="preview-content">
          <div class="preview-code">
            <span class="code-label">Code:</span>
            <span id="visitor-pass-code" class="code-value"></span>
            <button type="button" id="visitor-copy-code" class="link-button">Copy</button>
          </div>
          <img id="visitor-pass-qr" alt="Visitor QR code" />
          <div class="preview-actions">
            <button type="button" id="visitor-download-qr">Download QR</button>
            <button type="button" id="visitor-refresh-pass" class="secondary">Refresh List</button>
          </div>
          <p id="visitor-preview-meta" class="preview-meta"></p>
        </div>
      </div>
    </div>
  </div>
