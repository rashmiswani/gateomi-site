<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Society Dashboard | Gateomi</title>
  <link rel="icon" type="image/x-icon" href="https://storage.googleapis.com/gateomi-static-data/logo.png">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.6/dist/chart.umd.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Inter', sans-serif;
    }
    body {
      background: #f8f9fa;
      color: #333;
      min-height: 100vh;
    }
    header {
      background: white;
      padding: 0 40px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
    }
    .logo img {
      height: 70px;
    }
    nav a {
      margin-left: 20px;
      text-decoration: none;
      color: #555;
      font-weight: 500;
    }
    .admin-profile {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .admin-info {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      font-size: 14px;
    }
    .admin-info #admin-name {
      font-weight: 600;
      color: #1f2937;
    }
    .admin-info #admin-society {
      font-size: 12px;
      color: #6b7280;
    }
    .logout-btn {
      background: #ef4444;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    .logout-btn:hover {
      background: #dc2626;
    }
    .hidden {
      display: none !important;
    }
    .page-shell {
      max-width: 1200px;
      margin: 40px auto;
      padding: 0 20px 60px;
    }
    .card {
      background: white;
      border-radius: 12px;
      box-shadow: 0 8px 24px rgba(15, 23, 42, 0.08);
      padding: 36px;
      margin-bottom: 30px;
    }
    .card h2 {
      margin-bottom: 12px;
      font-size: 26px;
    }
    .card p {
      color: #666;
      margin-bottom: 20px;
    }
    button {
      background: #2a9df4;
      color: white;
      border: none;
      border-radius: 8px;
      padding: 12px 20px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.12s ease, box-shadow 0.12s ease;
    }
    button:hover {
      transform: translateY(-1px);
      box-shadow: 0 6px 16px rgba(42, 157, 244, 0.25);
    }
    button.secondary {
      background: #6c757d;
    }
    button:disabled {
      opacity: 0.6;
      cursor: wait;
      box-shadow: none;
    }
    .hidden {
      display: none !important;
    }
    .feedback {
      margin-bottom: 18px;
      padding: 14px 16px;
      border-radius: 10px;
      font-size: 14px;
    }
    .feedback.error {
      background: #ffe9e9;
      color: #b02a37;
      border: 1px solid #f5c2c7;
    }
    .feedback.success {
      background: #e9f7ef;
      color: #1e7e34;
      border: 1px solid #badbcc;
    }
    .portal-toolbar {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 16px;
      margin-bottom: 24px;
    }
    .portal-toolbar h2 {
      font-size: 28px;
      margin-bottom: 4px;
    }
    .portal-toolbar .small-label {
      color: #6b7280;
    }
    .portal-body {
      display: grid;
      grid-template-columns: 220px 1fr;
      gap: 24px;
    }
    .portal-nav {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .portal-nav .nav-link {
      padding: 14px 16px;
      border-radius: 10px;
      border: 1px solid #e4e7ec;
      background: #f8fafc;
      text-align: left;
      color: #1f2937;
      font-weight: 600;
      transition: all 0.15s ease;
    }
    .portal-nav .nav-link:hover {
      background: #eef2ff;
      border-color: #c7d2fe;
      transform: translateY(-1px);
    }
    .portal-nav .nav-link.active {
      background: linear-gradient(135deg, #2a9df4, #7f5af0);
      color: white;
      border-color: transparent;
      box-shadow: 0 12px 24px rgba(42, 157, 244, 0.25);
    }
    .portal-content {
      background: #ffffff;
      border-radius: 16px;
      border: 1px solid #e5e7eb;
      padding: 28px;
      box-shadow: 0 10px 30px rgba(148, 163, 184, 0.15);
    }
    .portal-section {
      display: none;
      flex-direction: column;
      gap: 26px;
    }
    .portal-section.active {
      display: flex;
    }
    .summary-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 18px;
    }
    .summary-tile {
      background: #f8fafc;
      border: 1px solid #e2e8f0;
      border-radius: 14px;
      padding: 18px;
      transition: transform 0.12s ease, box-shadow 0.12s ease;
    }
    .summary-tile:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 24px rgba(15, 23, 42, 0.08);
    }
    .summary-tile h4 {
      font-size: 13px;
      color: #475569;
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }
    .summary-tile span {
      font-weight: 700;
      font-size: 28px;
      color: #1f2937;
      display: block;
    }
    .summary-tile .small-label {
      margin-top: 4px;
      color: #64748b;
      font-size: 13px;
    }
    .charts-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 18px;
    }
    .chart-card {
      background: #ffffff;
      border-radius: 16px;
      border: 1px solid #e2e8f0;
      padding: 20px;
      box-shadow: 0 10px 24px rgba(15, 23, 42, 0.05);
      min-height: 280px;
    }
    .chart-card__title {
      font-weight: 600;
      margin-bottom: 12px;
      color: #1f2937;
    }
    .chart-card canvas {
      width: 100% !important;
      height: 240px !important;
    }
    .logs-panel {
      background: #f8fafc;
      border-radius: 16px;
      border: 1px solid #e2e8f0;
      padding: 22px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    .logs-panel__header {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
    }
    .logs-panel__controls {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    select {
      border-radius: 8px;
      border: 1px solid #d0d5dd;
      padding: 10px 14px;
      font-size: 14px;
      background: white;
    }
    .table-wrapper {
      border: 1px solid #e2e8f0;
      border-radius: 12px;
      overflow: hidden;
      background: white;
    }
    table {
      width: 100%;
      border-collapse: collapse;
    }
    th, td {
      text-align: left;
      padding: 14px 16px;
      border-bottom: 1px solid #f1f5f9;
      vertical-align: top;
      font-size: 14px;
    }
    th {
      color: #475569;
      font-weight: 600;
      background: #f8fafc;
      text-transform: uppercase;
      font-size: 12px;
      letter-spacing: 0.06em;
    }
    .status-chip {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 600;
      text-transform: capitalize;
    }
    .status-chip.pending {
      background: #fff4cc;
      color: #b7791f;
    }
    .status-chip.active {
      background: #dcfce7;
      color: #166534;
    }
    .status-chip.inactive {
      background: #fee2e2;
      color: #b91c1c;
    }
    .person-cell {
      display: flex;
      align-items: center;
      gap: 14px;
    }
    .person-avatar {
      width: 48px;
      height: 48px;
      border-radius: 10px;
      overflow: hidden;
      background: linear-gradient(135deg, #cbd5f5, #f1f5f9);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      color: #334155;
      text-transform: uppercase;
    }
    .person-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .person-name {
      font-weight: 600;
      color: #111827;
      margin-bottom: 6px;
    }
    .person-meta {
      color: #64748b;
      font-size: 13px;
    }
    .contact-link {
      color: #2563eb;
      text-decoration: none;
      font-weight: 500;
    }
    .contact-link:hover {
      text-decoration: underline;
    }
    .user-detail-link {
      background: none;
      border: none;
      padding: 0;
      margin: 0;
      color: #2563eb;
      font-weight: 600;
      cursor: pointer;
    }
    .user-detail-link:hover {
      text-decoration: underline;
    }
    .filters-bar {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
      background: #f8fafc;
      border: 1px solid #e2e8f0;
      border-radius: 12px;
      padding: 14px 16px;
    }
    .filters-group {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
    }
    .filters-group input[type="search"] {
      min-width: 240px;
      border-radius: 8px;
      border: 1px solid #d0d5dd;
      padding: 10px 14px;
      font-size: 14px;
    }
    .filters-group select {
      border-radius: 8px;
      border: 1px solid #d0d5dd;
      padding: 10px 14px;
      font-size: 14px;
      background: white;
    }
    .table-actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    .table-actions button {
      padding: 8px 14px;
      font-size: 13px;
    }
    .table-actions button.action-primary {
      background: #22c55e;
    }
    .table-actions button.action-danger {
      background: #ef4444;
    }
    .table-actions button.action-secondary {
      background: #6b7280;
    }
    .pagination-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-top: 14px;
      padding: 12px 0;
      color: #475569;
      font-size: 14px;
    }
    .pagination-controls {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .pagination-controls button {
      padding: 8px 14px;
      font-size: 13px;
      background: #e2e8f0;
      color: #0f172a;
    }
    .pagination-controls button:disabled {
      opacity: 0.4;
      cursor: not-allowed;
      box-shadow: none;
      transform: none;
    }
    .modal {
      position: fixed;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 999;
    }
    .modal.hidden {
      display: none;
    }
    .modal-backdrop {
      position: absolute;
      inset: 0;
      background: rgba(15, 23, 42, 0.55);
      backdrop-filter: blur(2px);
    }
    .modal-dialog {
      position: relative;
      width: min(90vw, 860px);
      max-height: 90vh;
      overflow-y: auto;
      background: #ffffff;
      border-radius: 16px;
      box-shadow: 0 24px 60px rgba(15, 23, 42, 0.25);
      padding: 30px;
      z-index: 1;
    }
    .modal-close {
      position: absolute;
      top: 16px;
      right: 16px;
      background: #0f172a;
      color: white;
      border: none;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      font-size: 18px;
      line-height: 32px;
      cursor: pointer;
    }
    .modal-loading,
    .modal-error {
      padding: 18px;
      border-radius: 10px;
      margin-top: 12px;
    }
    .modal-loading {
      background: #f8fafc;
      color: #1f2937;
      border: 1px solid #e2e8f0;
    }
    .modal-error {
      background: #fee2e2;
      color: #b91c1c;
      border: 1px solid #fecaca;
    }
    .modal-content {
      display: flex;
      flex-direction: column;
      gap: 24px;
    }
    .user-detail-header {
      display: grid;
      grid-template-columns: minmax(0, 1fr) minmax(0, 1fr);
      gap: 20px;
      align-items: start;
    }
    .user-detail-header .user-detail-name {
      font-size: 24px;
      font-weight: 700;
      color: #0f172a;
      margin-bottom: 6px;
    }
    .user-detail-header .user-detail-meta {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 12px;
      font-size: 14px;
      color: #475569;
    }
    .user-detail-gallery {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 12px;
    }
    .user-detail-gallery img {
      width: 100%;
      border-radius: 14px;
      box-shadow: 0 12px 24px rgba(15, 23, 42, 0.18);
      aspect-ratio: 1 / 1;
      object-fit: cover;
    }
    .user-detail-gallery figure {
      margin: 0;
    }
    .user-detail-gallery figcaption {
      margin-top: 6px;
      font-size: 13px;
      color: #475569;
      text-align: center;
    }
    .user-detail-gallery.empty {
      display: block;
      background: #f8fafc;
      border: 1px dashed #cbd5f5;
      border-radius: 14px;
      padding: 24px;
      text-align: center;
      color: #475569;
    }
    .user-detail-logs h4 {
      font-size: 18px;
      margin-bottom: 10px;
      color: #0f172a;
    }
    .detail-logs-table th,
    .detail-logs-table td {
      font-size: 13px;
      padding: 10px 12px;
    }
    .detail-logs-table td {
      color: #475569;
    }
    .custom-date-inputs {
      display: flex;
      gap: 8px;
      align-items: center;
    }
    .custom-date-inputs input[type="date"] {
      padding: 8px 12px;
      border: 1px solid #d0d5dd;
      border-radius: 6px;
      font-size: 14px;
      background: white;
    }
    .access-log-row {
      transition: background-color 0.2s ease;
    }
    .access-log-row:hover {
      background-color: #f8fafc;
    }
    .recognition-score {
      font-weight: 600;
    }
    .recognition-score.high {
      color: #16a34a;
    }
    .recognition-score.medium {
      color: #ca8a04;
    }
    .recognition-score.low {
      color: #dc2626;
    }
    .action-badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 600;
      text-transform: capitalize;
    }
    .action-badge.entry {
      background: #dcfce7;
      color: #166534;
    }
    .action-badge.exit {
      background: #fef3c7;
      color: #92400e;
    }
    .action-badge.access_granted {
      background: #dbeafe;
      color: #1e40af;
    }
    .action-badge.access_denied {
      background: #fee2e2;
      color: #991b1b;
    }
    .action-badge.authorized {
      background: #dcfce7;
      color: #166534;
    }
    .action-badge.unauthorized {
      background: #fee2e2;
      color: #991b1b;
    }
    .location-info {
      font-size: 13px;
      color: #6b7280;
    }
    .location-info .building {
      font-weight: 600;
      color: #374151;
    }
    .loading-logs {
      text-align: center;
      padding: 40px;
      color: #6b7280;
    }
    .loading-logs .spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 2px solid #e5e7eb;
      border-top: 2px solid #2a9df4;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-right: 8px;
    }
    @keyframes spin {
    }
    .face-thumbnail {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 50px;
      height: 50px;
      position: relative;
    }
    .thumbnail-img {
      width: 50px;
      height: 50px;
      object-fit: cover;
      border-radius: 8px;
      border: 2px solid #e5e7eb;
    }
    .no-thumbnail {
      width: 50px;
      height: 50px;
      background: #f3f4f6;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
    }
    .no-thumbnail-icon {
      font-size: 20px;
      color: #9ca3af;
      margin-bottom: 2px;
    }
    .no-thumbnail-text {
      font-size: 10px;
      color: #9ca3af;
      font-weight: 500;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }    @media (max-width: 768px) {
      .modal-dialog {
        width: min(94vw, 720px);
        padding: 24px;
      }
      .user-detail-header {
        grid-template-columns: 1fr;
      }
    }
    .section-heading h3 {
      font-size: 20px;
      margin-bottom: 6px;
    }
    .section-heading .small-label {
      color: #64748b;
    }
    .empty-state {
      background: #f8fafc;
      border: 1px dashed #cbd5f5;
      border-radius: 16px;
      padding: 32px;
      text-align: center;
      color: #475569;
      display: flex;
      flex-direction: column;
      gap: 14px;
      align-items: center;
    }
    .empty-state h4 {
      font-size: 20px;
      color: #1f2937;
    }
    footer {
      text-align: center;
      padding: 40px 20px;
      margin-top: 60px;
      background: #f1f5f9;
      color: #64748b;
      font-size: 14px;
    }
    @media (max-width: 992px) {
      .portal-body {
        grid-template-columns: 1fr;
      }
      .portal-nav {
        flex-direction: row;
        justify-content: space-between;
      }
      .portal-nav .nav-link {
        flex: 1;
        text-align: center;
      }
    }
    .custom-date-inputs {
      display: flex;
      gap: 8px;
      align-items: center;
    }
    .custom-date-inputs input[type="date"] {
      padding: 8px 12px;
      border: 1px solid #d0d5dd;
      border-radius: 6px;
      font-size: 14px;
      background: white;
    }
    .access-log-row {
      transition: background-color 0.2s ease;
    }
    .access-log-row:hover {
      background-color: #f8fafc;
    }
    .recognition-score {
      font-weight: 600;
    }
    .recognition-score.high {
      color: #16a34a;
    }
    .recognition-score.medium {
      color: #ca8a04;
    }
    .recognition-score.low {
      color: #dc2626;
    }
    .action-badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 600;
      text-transform: capitalize;
    }
    .action-badge.entry {
      background: #dcfce7;
      color: #166534;
    }
    .action-badge.exit {
      background: #fef3c7;
      color: #92400e;
    }
    .action-badge.access_granted {
      background: #dbeafe;
      color: #1e40af;
    }
    .action-badge.access_denied {
      background: #fee2e2;
      color: #991b1b;
    }
    .action-badge.authorized {
      background: #dcfce7;
      color: #166534;
    }
    .action-badge.unauthorized {
      background: #fee2e2;
      color: #991b1b;
    }
    .location-info {
      font-size: 13px;
      color: #6b7280;
    }
    .location-info .building {
      font-weight: 600;
      color: #374151;
    }
    .loading-logs {
      text-align: center;
      padding: 40px;
      color: #6b7280;
    }
    .loading-logs .spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 2px solid #e5e7eb;
      border-top: 2px solid #2a9df4;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-right: 8px;
    }
    @keyframes spin {
    }
    .face-thumbnail {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 50px;
      height: 50px;
      position: relative;
    }
    .thumbnail-img {
      width: 50px;
      height: 50px;
      object-fit: cover;
      border-radius: 8px;
      border: 2px solid #e5e7eb;
    }
    .no-thumbnail {
      width: 50px;
      height: 50px;
      background: #f3f4f6;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
    }
    .no-thumbnail-icon {
      font-size: 20px;
      color: #9ca3af;
      margin-bottom: 2px;
    }
    .no-thumbnail-text {
      font-size: 10px;
      color: #9ca3af;
      font-weight: 500;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }    @media (max-width: 768px) {
      header { padding: 0 20px; }
      .card { padding: 24px; }
      .portal-content { padding: 20px; }
      .portal-toolbar {
        flex-direction: column;
        align-items: flex-start;
      }
      table { display: block; overflow-x: auto; }
    }

    /* User Statistics Styles */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    
    .stat-card {
      background: white;
      border-radius: 12px;
      padding: 24px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
      display: flex;
      align-items: center;
      gap: 16px;
      border-left: 4px solid #2a9df4;
    }
    
    .stat-icon {
      font-size: 32px;
      width: 60px;
      height: 60px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #f0f9ff;
      border-radius: 12px;
    }
    
    .stat-content {
      flex: 1;
    }
    
    .stat-number {
      font-size: 28px;
      font-weight: 700;
      color: #1f2937;
      line-height: 1;
      margin-bottom: 4px;
    }
    
    .stat-label {
      font-size: 14px;
      color: #6b7280;
      font-weight: 500;
    }
    
    .attendance-summary {
      background: white;
      border-radius: 12px;
      padding: 24px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    }
    
    .attendance-summary h4 {
      margin: 0 0 20px 0;
      font-size: 18px;
      color: #1f2937;
    }
    
    .attendance-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 20px;
    }
    
    .attendance-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 16px;
      border-radius: 8px;
    }
    
    .attendance-item.present {
      background: #f0fdf4;
      border-left: 4px solid #22c55e;
    }
    
    .attendance-item.absent {
      background: #fef2f2;
      border-left: 4px solid #ef4444;
    }
    
    .attendance-item.total {
      background: #f0f9ff;
      border-left: 4px solid #2a9df4;
    }
    
    .attendance-icon {
      font-size: 24px;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .attendance-content {
      flex: 1;
    }
    
    .attendance-number {
      font-size: 20px;
      font-weight: 700;
      color: #1f2937;
      line-height: 1;
      margin-bottom: 2px;
    }
    
    .attendance-label {
      font-size: 12px;
      color: #6b7280;
      font-weight: 500;
    }
    
    /* Active Users Table Styles */
    .loading-users {
      text-align: center;
      padding: 40px;
      color: #6b7280;
    }
    
    .user-photo {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid #e5e7eb;
    }
    
    .no-photo {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: #f3f4f6;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #9ca3af;
      font-size: 16px;
      border: 2px solid #e5e7eb;
    }
    
    .access-expiry {
      font-size: 13px;
    }
    
    .access-expiry.forever {
      color: #059669;
      font-weight: 600;
    }
    
    .access-expiry.expired {
      color: #dc2626;
      font-weight: 600;
    }
    
    .access-expiry.expiring-soon {
      color: #d97706;
      font-weight: 600;
    }
    
    .access-expiry.valid {
      color: #059669;
    }
    
    /* Attendance Table Styles */
    .attendance-table-wrapper {
      background: white;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    }
    
    .loading-attendance {
      text-align: center;
      padding: 40px;
      color: #6b7280;
    }
    
    .attendance-percentage {
      font-weight: 600;
    }
    
    .attendance-percentage.high {
      color: #059669;
    }
    
    .attendance-percentage.medium {
      color: #d97706;
    }
    
    .attendance-percentage.low {
      color: #dc2626;
    }
    
    .last-login {
      font-size: 13px;
      color: #6b7280;
    }
    
    .last-login.recent {
      color: #059669;
    }
    
    .last-login.old {
      color: #dc2626;
    }
    
    /* Refresh Button */
    .refresh-btn {
      background: #10b981;
      color: white;
      border: none;
      border-radius: 6px;
      padding: 8px 16px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    
    .refresh-btn:hover {
      background: #059669;
    }
    
    /* Responsive adjustments */
    @media (max-width: 768px) {
      .stats-grid {
        grid-template-columns: 1fr;
      }
      
      .attendance-stats {
        grid-template-columns: 1fr;
      }
      
      .stat-card {
        padding: 16px;
      }
      
      .stat-icon {
        width: 50px;
        height: 50px;
        font-size: 24px;
      }
      
      .stat-number {
        font-size: 24px;
      }
    }


    /* User Attendance Section Styles */
    .user-info {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .user-thumbnail {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid #e5e7eb;
    }

    .user-thumbnail-placeholder {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background-color: #f3f4f6;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      border: 2px solid #e5e7eb;
    }

    .status-badge {
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 500;
      text-transform: uppercase;
    }

    .status-badge.status-active {
      background-color: #dcfce7;
      color: #166534;
    }

    .status-badge.status-inactive {
      background-color: #fee2e2;
      color: #991b1b;
    }

    .btn-small {
      padding: 4px 8px;
      font-size: 12px;
      border-radius: 4px;
      border: 1px solid #d1d5db;
      background-color: #ffffff;
      color: #374151;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-small:hover {
      background-color: #f9fafb;
      border-color: #9ca3af;
    }

    .log-entry {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 8px 12px;
      border: 1px solid #e5e7eb;
      border-radius: 6px;
      margin-bottom: 8px;
      background-color: #f9fafb;
    }

    .log-time {
      font-size: 12px;
      color: #6b7280;
      min-width: 140px;
    }

    .log-action {
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 500;
      text-transform: uppercase;
    }

    .log-action.entry,
    .log-action.access_granted,
    .log-action.authorized {
      background-color: #dcfce7;
      color: #166534;
    }

    .log-action.exit {
      background-color: #fef3c7;
      color: #92400e;
    }

    .log-camera {
      font-size: 12px;
      color: #374151;
      flex: 1;
    }

    .log-score {
      font-size: 11px;
      color: #6b7280;
    }

    .no-logs {
      text-align: center;
      color: #6b7280;
      font-style: italic;
      padding: 20px;
    }

    .attendance-summary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .attendance-summary h4 {
      color: white;
    }

    .attendance-summary p {
      color: rgba(255, 255, 255, 0.9);
    }

    .attendance-summary .small-label {
      color: rgba(255, 255, 255, 0.7);
    }

    
    /* User Attendance Section Styles */
    .user-info {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .user-thumbnail {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid #e5e7eb;
    }

    .user-thumbnail-placeholder {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background-color: #f3f4f6;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      border: 2px solid #e5e7eb;
    }

    .status-badge {
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 500;
      text-transform: uppercase;
    }

    .status-badge.status-active {
      background-color: #dcfce7;
      color: #166534;
    }

    .status-badge.status-inactive {
      background-color: #fee2e2;
      color: #991b1b;
    }

    .user-type-badge {
      padding: 2px 6px;
      border-radius: 8px;
      font-size: 11px;
      font-weight: 500;
      background-color: #f3f4f6;
      color: #374151;
      text-transform: capitalize;
    }

    .btn-small {
      padding: 4px 8px;
      font-size: 12px;
      border-radius: 4px;
      border: 1px solid #d1d5db;
      background-color: #ffffff;
      color: #374151;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-small:hover {
      background-color: #f9fafb;
      border-color: #9ca3af;
    }

    .log-entry {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 8px 12px;
      border: 1px solid #e5e7eb;
      border-radius: 6px;
      margin-bottom: 8px;
      background-color: #f9fafb;
    }

    .log-time {
      font-size: 12px;
      color: #6b7280;
      min-width: 140px;
    }

    .log-action {
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 500;
      text-transform: uppercase;
    }

    .log-action.entry,
    .log-action.access_granted,
    .log-action.authorized {
      background-color: #dcfce7;
      color: #166534;
    }

    .log-action.exit {
      background-color: #fef3c7;
      color: #92400e;
    }

    .log-camera {
      font-size: 12px;
      color: #374151;
      flex: 1;
    }

    .log-score {
      font-size: 11px;
      color: #6b7280;
    }

    .no-logs {
      text-align: center;
      color: #6b7280;
      font-style: italic;
      padding: 20px;
    }

    .loading-logs {
      text-align: center;
      padding: 40px;
      color: #6b7280;
    }

    .spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid #f3f3f3;
      border-top: 3px solid #3498db;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-right: 10px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Pagination styles */
    .pagination-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 20px;
      padding: 15px 0;
    }

    .pagination-controls {
      display: flex;
      gap: 10px;
    }

    .pagination-controls button {
      padding: 8px 16px;
      border: 1px solid #d1d5db;
      background-color: #ffffff;
      color: #374151;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .pagination-controls button:hover:not(:disabled) {
      background-color: #f9fafb;
      border-color: #9ca3af;
    }

    .pagination-controls button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* Filters bar improvements */
    .filters-bar {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      margin-bottom: 20px;
      padding: 15px;
      background-color: #f8fafc;
      border-radius: 8px;
      border: 1px solid #e2e8f0;
    }

    .filters-group {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .filters-group label {
      font-weight: 500;
      color: #374151;
      white-space: nowrap;
    }

    .filters-group input,
    .filters-group select {
      padding: 8px 12px;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      font-size: 14px;
    }

    .filters-group input:focus,
    .filters-group select:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

</style>
</head>
<body>
  <header>
    <div class="logo">
      <a href="index.html"><img src="https://storage.googleapis.com/gateomi-static-data/logo.png" alt="Gateomi Logo"></a>
    </div>
    <nav>
      <a href="index.html">Home</a>
      <a href="register.html">Register User</a>
      <a href="login.html" id="admin-login-link">Admin Login</a>
      <div id="admin-profile" class="admin-profile hidden">
        <span class="admin-info">
          <span id="admin-name">Admin</span>
          <span id="admin-society">Society</span>
        </span>
        <button id="header-logout" class="logout-btn">Logout</button>
      </div>
    </nav>
  </header>

  <main class="page-shell">
    <section id="portal" class="portal card">
      <div class="portal-toolbar">
        <div>
          <h2>Society Operations Console</h2>
          <p id="society-subtitle" class="small-label"></p>
        </div>
        <div class="toolbar-actions" style="display:flex; gap:12px;">
          <!-- <button id="refresh-button" class="secondary" type="button">Refresh Data</button> -->
          <!-- <button id="logout-button" type="button">Log out</button> -->
        </div>
      </div>
      <div id="dashboard-feedback" class="feedback hidden"></div>
      <div class="portal-body">
        <nav class="portal-nav">
          <button class="nav-link active" data-section="overview-section">Dashboard</button>
          <button class="nav-link" data-section="users-section">Society Users</button>
          <button class="nav-link" data-section="user-attendance-section">User Attendance</button>
          <button class="nav-link" data-section="access-logs-section">Access Logs</button>
          
          <button class="nav-link" data-section="visitors-section">Visitors (Comming soon)</button>
          
          
          
        </nav>
        <div class="portal-content">
          <section id="overview-section" class="portal-section active">
            <div class="summary-grid" id="summary-grid"></div>

            <!-- Society User Statistics -->
            <div class="section-heading" style="margin-top: 30px;">
              <h3>Society Users</h3>
              <p class="small-label">Overview of user registrations and today's attendance.</p>
            </div>
            <div class="stats-grid" id="user-stats-grid">
              <div class="stat-card">
                <h4>Total Users</h4>
                <p id="total-users-count">0</p>
              </div>
              <div class="stat-card">
                <h4>Active Users</h4>
                <p id="active-users-count">0</p>
              </div>
              <div class="stat-card">
                <h4>Inactive Users</h4>
                <p id="inactive-users-count">0</p>
              </div>
              <div class="stat-card">
                <h4>Pending Users</h4>
                <p id="pending-users-count">0</p>
              </div>
              <div class="stat-card attendance-summary">
                <h4>Today's Attendance</h4>
                <p>Present: <span id="today-present-count">0</span></p>
                <p>Absent: <span id="today-absent-count">0</span></p>
                <!-- <p class="small-label">Total Active: <span id="today-total-active">0</span></p> -->
              </div>
            </div>
          </section>
          <section id="access-logs-section" class="portal-section">
            <div class="section-heading">
              <h3>Access Logs</h3>
              <p class="small-label">View and filter authorized person access logs from all cameras.</p>
            </div>
            
            <!-- Filters Bar -->
            <div class="filters-bar">
              <div class="filters-group">
                <input type="search" id="logs-username-search" placeholder="Search by username" />
                <select id="logs-camera-filter">
                  <option value="">All cameras</option>
                </select>
                <select id="logs-action-filter">
                  <option value="">All actions</option>
                </select>
                <select id="logs-date-range">
                  <option value="1">Last 1 day</option>
                  <option value="7">Last 7 days</option>
                  <option value="15">Last 15 days</option>
                  <option value="30" selected>Last 30 days</option>
                  <option value="90">Last 3 months</option>
                  <option value="180">Last 6 months</option>
                  <option value="365">Last 1 year</option>
                  <option value="custom">Custom date range</option>
                </select>
                <div id="custom-date-range" class="custom-date-inputs hidden">
                  <input type="date" id="logs-date-from" />
                  <input type="date" id="logs-date-to" />
                </div>
              </div>
              <div class="filters-group">
                <select id="logs-page-size">
                  <option value="25">25 / page</option>
                  <option value="50" selected>50 / page</option>
                  <option value="100">100 / page</option>
                </select>
                <button id="logs-apply-filters" type="button">Apply Filters</button>
                <button id="logs-clear-filters" class="secondary" type="button">Clear</button>
              </div>
            </div>
            
            <!-- Logs Table -->
            <div class="table-wrapper">
              <table>
                <thead>
                  <tr>
                    <th>Face</th>
                    <th>Timestamp</th>
                    <th>Person</th>
                    <th>Camera</th>
                    <th>Action</th>
                    <th>Recognition Score</th>
                    <th>Location</th>
                  </tr>
                </thead>
                <tbody id="access-logs-table-body"></tbody>
              </table>
            </div>
            
            <!-- Pagination -->
            <div class="pagination-bar">
              <span id="access-logs-pagination-info">Loading logs...</span>
              <div class="pagination-controls">
                <button id="access-logs-prev" type="button">Prev</button>
                <button id="access-logs-next" type="button">Next</button>
              </div>
            </div>
          </section>
          <section id="users-section" class="portal-section">
          
            <div class="section-heading">
              <h3>Society Users</h3>
              <p class="small-label">Manage and view all registered society users.</p>
            </div>
            
            <!-- Filters Bar -->
            <div class="filters-bar">
              <div class="filters-group">
                <input type="search" id="users-search" placeholder="Search by name, flat, mobile..." />
                <select id="users-status-filter">
                  <option value="">All Status</option>
                  <option value="active">Active</option>
                  <option value="inactive">Inactive</option>
                  <option value="pending">Pending</option>
                </select>
                <select id="users-type-filter">
                  <option value="">All Types</option>
                  <option value="resident">Resident</option>
                  <option value="maid">Maid</option>
                  <option value="labor">Labor</option>
                  <option value="security">Security</option>
                  <option value="maintenance staff">Maintenance Staff</option>
                  <option value="housekeeping staff">Housekeeping Staff</option>
                  <option value="mali">Mali</option>
                </select>
                <select id="users-page-size">
                  <option value="10">10 / page</option>
                  <option value="25" selected>25 / page</option>
                  <option value="50">50 / page</option>
                  <option value="100">100 / page</option>
                </select>
              </div>
              <div class="filters-group">
                <button id="users-apply-filters" type="button">Apply Filters</button>
                <button id="users-clear-filters" class="secondary" type="button">Clear</button>
                <button id="users-refresh" class="refresh-btn" type="button">Refresh</button>
              </div>
            </div>

            <!-- Users Table -->
            <div class="table-wrapper">
              <table>
                <thead>
                  <tr>
                    <th>Person</th>
                    <th>Contact</th>
                    <th>Type</th>
                    <th>Status</th>
                    <th>Access Expiry</th>
                    <th>Registered On</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="users-table-body">
                  <tr>
                    <td colspan="7" style="text-align: center; padding: 40px; color: #6b7280;">
                      <div class="spinner"></div> Loading users...
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
            
            <!-- Pagination -->
            <div class="pagination-bar">
              <span id="users-pagination-info">Loading...</span>
              <div class="pagination-controls">
                <button id="users-prev" type="button">Prev</button>
                <button id="users-next" type="button">Next</button>
              </div>
            </div>

          </section>

          <!-- User Attendance Section -->
          <section id="user-attendance-section" class="portal-section">
            <div class="section-heading">
              <h3>User Attendance</h3>
              <p class="small-label">View daily attendance status and entry logs for all society users.</p>
            </div>
            
            <!-- Date Selection and Filters -->
            <div class="filters-bar">
              <div class="filters-group">
                <label for="attendance-date">Select Date:</label>
                <input type="date" id="attendance-date" />
                <button id="load-attendance-btn" class="primary">Load Attendance</button>
                <button id="refresh-attendance-btn" class="secondary">Refresh</button>
              </div>
              <div class="filters-group">
                <input type="search" id="attendance-search" placeholder="Search by name, flat, mobile..." />
                <select id="attendance-status-filter">
                  <option value="all">All Status</option>
                  <option value="present">Present</option>
                  <option value="absent">Absent</option>
                </select>
                <select id="attendance-user-type-filter">
                  <option value="all">All Types</option>
                  <option value="resident">Resident</option>
                  <option value="maid">Maid</option>
                  <option value="labor">Labor</option>
                  <option value="security">Security</option>
                  <option value="maintenance staff">Maintenance Staff</option>
                  <option value="housekeeping staff">Housekeeping Staff</option>
                  <option value="mali">Mali</option>
                </select>
                <select id="attendance-page-size">
                  <option value="10" selected>10 / page</option>
                  <option value="25">25 / page</option>
                  <option value="50">50 / page</option>
                  <option value="100">100 / page</option>
                </select>
              </div>
            </div>

            <!-- Attendance Summary -->
            <div class="stats-grid" id="attendance-stats-grid">
              <div class="stat-card">
                <h4>Total Users</h4>
                <p id="attendance-total-users">0</p>
              </div>
              <div class="stat-card">
                <h4>Present</h4>
                <p id="attendance-present-count">0</p>
              </div>
              <div class="stat-card">
                <h4>Absent</h4>
                <p id="attendance-absent-count">0</p>
              </div>
              <div class="stat-card">
                <h4>Attendance %</h4>
                <p id="attendance-percentage">0%</p>
              </div>
            </div>

            <!-- User List with Attendance -->
            <div class="table-wrapper">
              <table>
                <thead>
                  <tr>
                    <th>Person</th>
                    <th>Contact</th>
                    <th>Type</th>
                    <th>Status</th>
                    <th>All Entry Times</th>
                    <th>Total Entries</th>
                    <th>Total Logs</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="attendance-table-body">
                  <tr>
                    <td colspan="8" style="text-align: center; padding: 40px; color: #6b7280;">
                      Select a date and click "Load Attendance" to view user attendance
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
            
            <!-- Pagination -->
            <div class="pagination-bar">
              <span id="attendance-pagination-info">No users to display.</span>
              <div class="pagination-controls">
                <button id="attendance-prev" type="button">Prev</button>
                <button id="attendance-next" type="button">Next</button>
              </div>
            </div>
          </section>
        </div>
      </div>
    </section>
  </main>
  <footer>
    © <span id="year"></span> Gateomi. All rights reserved.
  </footer>
</body>
</html>

<script>
    const backend_url = "http://localhost:8000";
    const tokenStorageKey = 'gateomiAdminToken';
    const profileStorageKey = 'gateomiAdminProfile';
    const gcsBucketName = 'gateomi-data';

    // Get all DOM elements
    const portalSection = document.getElementById('portal');
    const dashboardFeedback = document.getElementById('dashboard-feedback');
    const summaryGrid = document.getElementById('summary-grid');
    // const refreshButton = document.getElementById('refresh-button');
    // const logoutButton = document.getElementById('logout-button');
    const societySubtitle = document.getElementById('society-subtitle');
    const navButtons = document.querySelectorAll('.portal-nav .nav-link');
    const portalSections = document.querySelectorAll('.portal-section');

    // Access Logs elements
    const logsDateRange = document.getElementById('logs-date-range');
    if (!logsDateRange) {
      console.warn('logsDateRange element not found');
    }
    const logsUsernameSearch = document.getElementById('logs-username-search');
    const logsCameraFilter = document.getElementById('logs-camera-filter');
    const logsActionFilter = document.getElementById('logs-action-filter');
    const customDateRange = document.getElementById('custom-date-range');
    const logsDateFrom = document.getElementById('logs-date-from');
    const logsDateTo = document.getElementById('logs-date-to');
    const logsPageSize = document.getElementById('logs-page-size');
    const logsApplyFilters = document.getElementById('logs-apply-filters');
    const logsClearFilters = document.getElementById('logs-clear-filters');
    const accessLogsTableBody = document.getElementById('access-logs-table-body');
    const accessLogsPaginationInfo = document.getElementById('access-logs-pagination-info');
    const accessLogsPrevButton = document.getElementById('access-logs-prev');
    const accessLogsNextButton = document.getElementById('access-logs-next');

    let currentToken = null;
    // User Statistics elements
    const userStatsGrid = document.getElementById('user-stats-grid');
    const totalUsersCount = document.getElementById('total-users-count');
    const activeUsersCount = document.getElementById('active-users-count');
    const inactiveUsersCount = document.getElementById('inactive-users-count');
    const pendingUsersCount = document.getElementById('pending-users-count');
    const todayPresentCount = document.getElementById('today-present-count');
    const todayAbsentCount = document.getElementById('today-absent-count');
    // const todayTotalActive = document.getElementById('today-total-active');


    // User management state variables

    let currentProfile = null;
    let currentLogsPage = 1;
    let currentLogsPageSize = 50;
    let currentLogsData = null;

    const yearElement = document.getElementById('year');
    if (yearElement) {
      yearElement.textContent = new Date().getFullYear();
    }

    function showElement(el) {
      el.classList.remove('hidden');
    }

    function hideElement(el) {
      el.classList.add('hidden');
    }

    function showFeedback(el, message, type = 'error') {
      el.textContent = message;
      el.classList.remove('hidden', 'error', 'success');
      el.classList.add('feedback', type);
    }

    function clearFeedback(el) {
      el.classList.add('hidden');
      el.textContent = '';
    }

    function activateSection(targetId) {
      portalSections.forEach(section => {
        section.classList.toggle('active', section.id === targetId);
      });
      navButtons.forEach(button => {
        button.classList.toggle('active', button.dataset.section === targetId);
      });
      
      if (targetId === "access-logs-section" && !currentLogsData) {
        loadAccessLogs();
      }
      loadSectionData(targetId);
    }

    function handleLogout(skipMessage = false) {
      currentToken = null;
      currentProfile = null;
      localStorage.removeItem(tokenStorageKey);
      localStorage.removeItem(profileStorageKey);
      updateHeaderForLoggedOutUser();      if (!skipMessage) {
        showFeedback(dashboardFeedback, 'You have been logged out.', 'success');
      }
      window.location.href = 'login.html';
    }

    function updateHeaderForLoggedInUser() {
      const adminLoginLink = document.getElementById('admin-login-link');
      const adminProfile = document.getElementById('admin-profile');
      const adminName = document.getElementById('admin-name');
      const adminSociety = document.getElementById('admin-society');
      const headerLogout = document.getElementById('header-logout');
      
      if (currentProfile && adminLoginLink && adminProfile) {
        // Hide admin login link
        adminLoginLink.style.display = 'none';
        
        // Show admin profile
        adminProfile.classList.remove('hidden');
        
        // Update admin info
        if (adminName) adminName.textContent = currentProfile.name || 'Admin';
        if (adminSociety) adminSociety.textContent = `${currentProfile.society}, ${currentProfile.city}`;
        
        // Add logout event listener
        if (headerLogout) {
          headerLogout.onclick = () => handleLogout();
        }
      }
    }
    
    function updateHeaderForLoggedOutUser() {
      const adminLoginLink = document.getElementById('admin-login-link');
      const adminProfile = document.getElementById('admin-profile');
      
      if (adminLoginLink && adminProfile) {
        // Show admin login link
        adminLoginLink.style.display = 'inline';
        
        // Hide admin profile
        adminProfile.classList.add('hidden');
      }
    }
    function checkAuthentication() {
      const storedToken = localStorage.getItem(tokenStorageKey);
      const storedProfile = localStorage.getItem(profileStorageKey);
      
      if (!storedToken || !storedProfile) {
        window.location.href = 'login.html';
        return;
      }
      
      try {
        currentToken = storedToken;
        currentProfile = JSON.parse(storedProfile);
        societySubtitle.textContent = `${currentProfile.society}, ${currentProfile.city}, ${currentProfile.state}`;
        updateHeaderForLoggedInUser();
      } catch (error) {
        localStorage.removeItem(tokenStorageKey);
        localStorage.removeItem(profileStorageKey);
      updateHeaderForLoggedOutUser();
        window.location.href = 'login.html';
      }
    }

    // Access Logs functionality
    function formatTimestamp(timestamp) {
      if (!timestamp) return "—";
      try {
        const date = new Date(timestamp);
        return date.toLocaleString(undefined, {
          year: "numeric",
          month: "short",
          day: "numeric",
          hour: "2-digit",
          minute: "2-digit",
          second: "2-digit"
        });
      } catch (error) {
        return timestamp;
      }
    }

    function getRecognitionScoreClass(score) {
      if (!score) return "";
      if (score >= 0.8) return "high";
      if (score >= 0.6) return "medium";
      return "low";
    }

    function getActionBadgeClass(action) {
      const actionMap = {
        "entry": "entry",
        "exit": "exit",
        "access_granted": "access_granted",
        "access_denied": "access_denied",
        "authorized": "authorized",
        "unauthorized": "unauthorized"
      };
      return actionMap[action?.toLowerCase()] || "";
    }

    function formatLocation(log) {
      const parts = [];
      if (log.location_building) parts.push(`<span class="building">${log.location_building}</span>`);
      if (log.location_unit) parts.push(`Unit ${log.location_unit}`);
      return parts.length > 0 ? `<div class="location-info">${parts.join(" • ")}</div>` : "—";
    }

    function renderAccessLogsTable(logsData) {
      if (!logsData || !logsData.logs) {
        accessLogsTableBody.innerHTML = "<tr><td colspan=\"6\" class=\"loading-logs\">No logs found</td></tr>";
        return;
      }

      accessLogsTableBody.innerHTML = "";

      if (logsData.logs.length === 0) {
        const row = document.createElement("tr");
        const cell = document.createElement("td");
        cell.colSpan = 6;
        cell.textContent = "No access logs found for the selected filters.";
        cell.style.textAlign = "center";
        cell.style.padding = "40px";
        cell.style.color = "#6b7280";
        row.appendChild(cell);
        accessLogsTableBody.appendChild(row);
        return;
      }

      logsData.logs.forEach(log => {
        const row = document.createElement("tr");
        row.className = "access-log-row";
        
        const recognitionScoreClass = getRecognitionScoreClass(log.recognition_score);
        const actionBadgeClass = getActionBadgeClass(log.action);
        const locationHtml = formatLocation(log);
        
        row.innerHTML = `
          <td>
            <div class="face-thumbnail">
              ${log.face_image_b64 ? `<img src="data:image/jpeg;base64,${log.face_image_b64}" alt="Face" class="thumbnail-img" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">` : ""}
              <div class="no-thumbnail" style="display: ${log.face_image_b64 ? "none" : "block"};">
                <div class="no-thumbnail-icon">👤</div>
                <div class="no-thumbnail-text">No Image</div>
              </div>
            </div>
          </td>
          <td>
            <div style="font-size: 13px; color: #374151;">${formatTimestamp(log.timestamp)}</div>
          </td>
          <td>
            <div style="font-weight: 600; color: #111827;">${log.person_name || "Unknown"}</div>
            <div style="font-size: 12px; color: #6b7280;">${log.user_id || "No ID"}</div>
          </td>
          <td>
            <div style="font-weight: 500; color: #374151;">${log.camera_name || "—"}</div>
            <div style="font-size: 12px; color: #6b7280;">${log.device_id || ""}</div>
          </td>
          <td>
            <span class="action-badge ${actionBadgeClass}">${log.action || "unknown"}</span>
          </td>
          <td>
            <div class="recognition-score ${recognitionScoreClass}">
              ${log.recognition_score ? (log.recognition_score * 100).toFixed(1) + "%" : "—"}
            </div>
          </td>
          <td>${locationHtml}</td>
        `;
        accessLogsTableBody.appendChild(row);
      });
    }

    function renderAccessLogsPagination(logsData) {
      if (!logsData) {
        accessLogsPaginationInfo.textContent = "No data available";
        accessLogsPrevButton.disabled = true;
        accessLogsNextButton.disabled = true;
        return;
      }

      const { total_count, page, page_size, total_pages } = logsData;
      const startItem = (page - 1) * page_size + 1;
      const endItem = Math.min(page * page_size, total_count);

      if (total_count === 0) {
        accessLogsPaginationInfo.textContent = "No logs found";
      } else {
        accessLogsPaginationInfo.textContent = `Showing ${startItem}–${endItem} of ${total_count} logs`;
      }

      accessLogsPrevButton.disabled = page <= 1;
      accessLogsNextButton.disabled = page >= total_pages;
    }

    function populateLogsFilterOptions(logsData) {
      if (!logsData) return;

      // Populate camera filter
      const cameraOptions = logsData.cameras || [];
      logsCameraFilter.innerHTML = "<option value=\"\">All cameras</option>";
      cameraOptions.forEach(camera => {
        const option = document.createElement("option");
        option.value = camera;
        option.textContent = camera;
        logsCameraFilter.appendChild(option);
      });

      // Populate action filter
      const actionOptions = logsData.actions || [];
      logsActionFilter.innerHTML = "<option value=\"\">All actions</option>";
      actionOptions.forEach(action => {
        const option = document.createElement("option");
        option.value = action;
        option.textContent = action.replace(/_/g, " ").replace(/\b\w/g, l => l.toUpperCase());
        logsActionFilter.appendChild(option);
      });
    }

    function getDateRangeFromSelection() {
      const range = logsDateRange.value;
      const today = new Date();
      
      if (range === "custom") {
        return {
          from: logsDateFrom.value,
          to: logsDateTo.value
        };
      }
      
      const days = parseInt(range);
      if (isNaN(days)) return { from: "", to: "" };
      
      const fromDate = new Date(today);
      fromDate.setDate(today.getDate() - days + 1);
      
      return {
        from: fromDate.toISOString().split("T")[0],
        to: today.toISOString().split("T")[0]
      };
    }

    async function loadAccessLogs() {
      if (!currentToken) return;

      // Show loading state
      accessLogsTableBody.innerHTML = "<tr><td colspan=\"6\" class=\"loading-logs\"><span class=\"spinner\"></span>Loading access logs...</td></tr>";

      try {
        const dateRange = getDateRangeFromSelection();
        const params = new URLSearchParams({
          page: currentLogsPage.toString(),
          page_size: currentLogsPageSize.toString()
        });

        if (logsCameraFilter.value) params.append("camera_name", logsCameraFilter.value);
        if (logsUsernameSearch.value.trim()) params.append("username", logsUsernameSearch.value.trim());
        if (dateRange.from) params.append("date_from", dateRange.from);
        if (dateRange.to) params.append("date_to", dateRange.to);
        if (logsActionFilter.value) params.append("action", logsActionFilter.value);

        const response = await fetch(`${backend_url}/admin/authorized-logs?${params}`, {
          headers: { "Authorization": `Bearer ${currentToken}` }
        });

        if (response.status === 401) {
          handleLogout(true);
          return;
        }

        if (!response.ok) {
          throw new Error("Failed to load access logs");
        }

        const data = await response.json();
        currentLogsData = data;
        
        renderAccessLogsTable(data);
        renderAccessLogsPagination(data);
        populateLogsFilterOptions(data);

      } catch (error) {
        console.error("Error loading access logs:", error);
        accessLogsTableBody.innerHTML = "<tr><td colspan=\"6\" style=\"text-align: center; padding: 40px; color: #dc2626;\">Error loading access logs. Please try again.</td></tr>";
        showFeedback(dashboardFeedback, error.message || "Failed to load access logs", "error");
      }
    }

    function applyLogsFilters() {
      currentLogsPage = 1;
      loadAccessLogs();
    }

    function clearLogsFilters() {
      logsUsernameSearch.value = "";
      logsCameraFilter.value = "";
      logsActionFilter.value = "";
      logsDateRange.value = "30";
      logsDateFrom.value = "";
      logsDateTo.value = "";
      customDateRange.classList.add("hidden");
      currentLogsPage = 1;
      loadAccessLogs();
    }

    // Event listeners
    navButtons.forEach(button => {
      button.addEventListener('click', () => {
        const target = button.dataset.section;
        activateSection(target);
      });
    });

    // logoutButton.addEventListener('click', () => {
    //   handleLogout();
    // });

    // Access Logs event listeners
    if (logsDateRange) {
      logsDateRange.addEventListener("change", (event) => {
        if (event.target.value === "custom") {
          customDateRange.classList.remove("hidden");
        } else {
          customDateRange.classList.add("hidden");
        }
      });
    }

    if (logsApplyFilters) {
      logsApplyFilters.addEventListener("click", applyLogsFilters);
    }

    if (logsClearFilters) {
      logsClearFilters.addEventListener("click", clearLogsFilters);
    }

    if (logsPageSize) {
      logsPageSize.addEventListener("change", (event) => {
        currentLogsPageSize = parseInt(event.target.value, 10) || 50;
        currentLogsPage = 1;
        loadAccessLogs();
      });
    }

    if (accessLogsPrevButton) {
      accessLogsPrevButton.addEventListener("click", () => {
        if (currentLogsPage > 1) {
          currentLogsPage -= 1;
          loadAccessLogs();
        }
      });
    }

    if (accessLogsNextButton) {
      accessLogsNextButton.addEventListener("click", () => {
        if (currentLogsData && currentLogsPage < currentLogsData.total_pages) {
          currentLogsPage += 1;
          loadAccessLogs();
        }
      });
    }


    // User Statistics Functions
    async function loadUserStatistics() {
      try {
        const response = await fetch(`${backend_url}/admin/users/statistics`, {
          headers: {
            'Authorization': `Bearer ${currentToken}`,
            'Content-Type': 'application/json'
          }
        });

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();
        
        // Update statistics cards
        totalUsersCount.textContent = data.total_users || 0;
        activeUsersCount.textContent = data.active_users || 0;
        inactiveUsersCount.textContent = data.inactive_users || 0;
        pendingUsersCount.textContent = data.pending_users || 0;
        
        // Update attendance summary
        todayPresentCount.textContent = data.today_attendance.present || 0;
        todayAbsentCount.textContent = data.today_attendance.absent || 0;
        // todayTotalActive.textContent = data.today_attendance.total_active || 0;
        
      } catch (error) {
        console.error('Error loading user statistics:', error);
        showFeedback(dashboardFeedback, 'Failed to load user statistics', 'error');
      }
    }

    // Active Users Functions

    // Attendance Functions
    // Event Listeners for new sections
    // Event Listeners for user management sections
    function setupUserManagementEventListeners() {
      // User statistics will be loaded when users section is activated
    }

    // Utility functions
    function viewUserDetail(userId) {
      // This would open a modal or navigate to user detail page
      showFeedback(dashboardFeedback, `Viewing details for user: ${userId}`, 'info');
    }



    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }


    // ===== USER ATTENDANCE SECTION =====
    
    // Global variables for attendance
    let currentAttendanceData = null;
    let currentAttendancePage = 1;
    let currentAttendancePageSize = 10;
    let currentAttendanceTotalCount = 0;
    let currentAttendanceTotalPages = 0;
    
    // DOM elements for user attendance
    let attendanceDate, loadAttendanceBtn, refreshAttendanceBtn, attendanceTableBody;
    let attendanceTotalUsers, attendancePresentCount, attendanceAbsentCount, attendancePercentage;
    let attendanceSearch, attendanceStatusFilter, attendanceUserTypeFilter, attendancePageSize;
    let attendancePaginationInfo, attendancePrevBtn, attendanceNextBtn;

    // Initialize attendance section
    function initializeAttendanceSection() {
      console.log('🚀 Initializing User Attendance Section...');
      
      // Initialize DOM elements
      initializeAttendanceDOM();
      
      // Set default date to today
      const today = new Date().toISOString().split('T')[0];
      attendanceDate.value = today;
      console.log('📅 Set default date to:', today);
      
      // Add event listeners
      setupAttendanceEventListeners();
      
      // Load today's attendance by default
      loadUserAttendance();
    }

    // Initialize DOM elements
    function initializeAttendanceDOM() {
      attendanceDate = document.getElementById('attendance-date');
      loadAttendanceBtn = document.getElementById('load-attendance-btn');
      refreshAttendanceBtn = document.getElementById('refresh-attendance-btn');
      attendanceTableBody = document.getElementById('attendance-table-body');
      attendanceTotalUsers = document.getElementById('attendance-total-users');
      attendancePresentCount = document.getElementById('attendance-present-count');
      attendanceAbsentCount = document.getElementById('attendance-absent-count');
      attendancePercentage = document.getElementById('attendance-percentage');
      attendanceSearch = document.getElementById('attendance-search');
      attendanceStatusFilter = document.getElementById('attendance-status-filter');
      attendanceUserTypeFilter = document.getElementById('attendance-user-type-filter');
      attendancePageSize = document.getElementById('attendance-page-size');
      attendancePaginationInfo = document.getElementById('attendance-pagination-info');
      attendancePrevBtn = document.getElementById('attendance-prev');
      attendanceNextBtn = document.getElementById('attendance-next');
      
      console.log('✅ Attendance DOM elements initialized');
    }

    // Setup event listeners
    function setupAttendanceEventListeners() {
      loadAttendanceBtn.addEventListener('click', loadUserAttendance);
      refreshAttendanceBtn.addEventListener('click', loadUserAttendance);
      attendanceSearch.addEventListener('input', debounce(applyAttendanceFilters, 300));
      attendanceStatusFilter.addEventListener('change', applyAttendanceFilters);
      attendanceUserTypeFilter.addEventListener('change', applyAttendanceFilters);
      attendancePageSize.addEventListener('change', (e) => {
        currentAttendancePageSize = parseInt(e.target.value);
        currentAttendancePage = 1;
        loadUserAttendance();
      });
      attendancePrevBtn.addEventListener('click', () => {
        if (currentAttendancePage > 1) {
          currentAttendancePage--;
          loadUserAttendance();
        }
      });
      attendanceNextBtn.addEventListener('click', () => {
        if (currentAttendancePage < currentAttendanceTotalPages) {
          currentAttendancePage++;
          loadUserAttendance();
        }
      });
      
      console.log('✅ Attendance event listeners added');
    }

    // Load user attendance data with pagination
    async function loadUserAttendance() {
      console.log('📊 Loading user attendance data...');
      
      if (!currentToken) {
        showFeedback(dashboardFeedback, 'Please log in to view attendance data', 'error');
        return;
      }

      const selectedDate = attendanceDate.value;
      console.log('📅 Selected date:', selectedDate);
      
      if (!selectedDate) {
        showFeedback(dashboardFeedback, 'Please select a date', 'error');
        return;
      }

      // Show loading state
      showAttendanceLoading();

      try {
        // Build query parameters
        const params = new URLSearchParams({
          date: selectedDate,
          page: currentAttendancePage.toString(),
          page_size: currentAttendancePageSize.toString()
        });

        // Add filters
        const searchTerm = attendanceSearch.value.trim();
        if (searchTerm) {
          params.append('search', searchTerm);
        }

        const statusFilter = attendanceStatusFilter.value;
        if (statusFilter && statusFilter !== 'all') {
          params.append('status_filter', statusFilter);
        }

        const userTypeFilter = attendanceUserTypeFilter.value;
        if (userTypeFilter && userTypeFilter !== 'all') {
          params.append('user_type_filter', userTypeFilter);
        }

        const url = `${backend_url}/admin/society-users-with-logs?${params}`;
        console.log('🌐 Making request to:', url);
        
        const response = await fetch(url, {
          headers: {
            'Authorization': `Bearer ${currentToken}`,
            'Content-Type': 'application/json'
          }
        });

        console.log('📡 Response status:', response.status);

        if (response.status === 401) {
          console.log('🔒 Unauthorized, logging out');
          handleLogout(true);
          return;
        }

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();
        console.log('📦 Received data:', data);
        
        currentAttendanceData = data;
        currentAttendanceTotalCount = data.pagination.total_count;
        currentAttendanceTotalPages = data.pagination.total_pages;
        
        renderAttendanceTable();
        updateAttendanceStats();
        updateAttendancePagination();

      } catch (error) {
        console.error('❌ Error loading user attendance:', error);
        showAttendanceError(error.message || 'Failed to load attendance data');
        showFeedback(dashboardFeedback, error.message || 'Failed to load attendance data', 'error');
      }
    }

    // Show loading state
    function showAttendanceLoading() {
      if (attendanceTableBody) {
        attendanceTableBody.innerHTML = `
          <tr>
            <td colspan="8" class="loading-logs">
              <span class="spinner"></span>Loading attendance data...
            </td>
          </tr>
        `;
      }
    }

    // Show error state
    function showAttendanceError(message) {
      if (attendanceTableBody) {
        attendanceTableBody.innerHTML = `
          <tr>
            <td colspan="8" style="text-align: center; padding: 40px; color: #dc2626;">
              ❌ ${message}
            </td>
          </tr>
        `;
      }
    }

    // Apply filters (now triggers a new API call)
    function applyAttendanceFilters() {
      console.log('🔍 Applying filters and reloading data...');
      currentAttendancePage = 1; // Reset to first page when filters change
      loadUserAttendance();
    }

    // Render attendance table (simplified since data is already filtered)
    function renderAttendanceTable() {
      console.log('🎨 Rendering attendance table...');
      
      if (!currentAttendanceData || !currentAttendanceData.users || currentAttendanceData.users.length === 0) {
        if (attendanceTableBody) {
          attendanceTableBody.innerHTML = `
            <tr>
              <td colspan="8" style="text-align: center; padding: 40px; color: #6b7280;">
                No users found matching the current filters.
              </td>
            </tr>
          `;
        }
        return;
      }

      console.log(`📄 Rendering page ${currentAttendancePage}: ${currentAttendanceData.users.length} users`);

      const rows = currentAttendanceData.users.map(user => {
        const statusClass = user.attendance.is_present ? 'status-active' : 'status-inactive';
        const statusText = user.attendance.is_present ? 'Present' : 'Absent';
        
        // Format all entry times
        const allEntryTimes = user.attendance.all_entry_times || [];
        const formattedEntryTimes = allEntryTimes.length > 0 
          ? allEntryTimes.map(time => new Date(time).toLocaleTimeString()).join(', ')
          : '-';
        
        const entryCount = user.attendance.entry_count || 0;
        
        const thumbnail = user.thumbnail_url ? 
          `<img src="${user.thumbnail_url}" alt="${user.name}" class="user-thumbnail" />` : 
          '<div class="user-thumbnail-placeholder">👤</div>';

        return `
          <tr>
            <td>
              <div class="user-info">
                ${thumbnail}
                <div>
                  <strong>${user.name || 'Unknown'}</strong>
                  <div class="small-label">${user.flat_number || 'N/A'}</div>
                </div>
              </div>
            </td>
            <td>
              <div>${user.mobile_number || 'N/A'}</div>
            </td>
            <td>
              <span class="user-type-badge">${user.user_type || 'N/A'}</span>
            </td>
            <td>
              <span class="status-badge ${statusClass}">${statusText}</span>
            </td>
            <td title="${allEntryTimes.map(time => new Date(time).toLocaleString()).join(', ')}">${formattedEntryTimes}</td>
            <td>${entryCount}</td>
            <td>${user.attendance.total_logs}</td>
            <td>
              <button class="btn-small" onclick="viewUserAttendanceDetail('${user.id}')">View Logs</button>
            </td>
          </tr>
        `;
      }).join('');

      if (attendanceTableBody) {
        attendanceTableBody.innerHTML = rows;
        console.log('✅ Table rendered successfully');
      }
    }

    // Update attendance statistics
    function updateAttendanceStats() {
      if (!currentAttendanceData) return;

      const totalUsers = currentAttendanceData.summary.total_users || 0;
      const presentCount = currentAttendanceData.summary.present || 0;
      const absentCount = currentAttendanceData.summary.absent || 0;
      const attendancePercent = currentAttendanceData.summary.attendance_percentage || 0;

      if (attendanceTotalUsers) attendanceTotalUsers.textContent = totalUsers;
      if (attendancePresentCount) attendancePresentCount.textContent = presentCount;
      if (attendanceAbsentCount) attendanceAbsentCount.textContent = absentCount;
      if (attendancePercentage) attendancePercentage.textContent = `${attendancePercent}%`;

      console.log('📊 Updated attendance stats:', { totalUsers, presentCount, absentCount, attendancePercent });
    }

    // Update pagination
    function updateAttendancePagination() {
      if (!currentAttendanceData) return;

      const totalItems = currentAttendanceTotalCount;
      const totalPages = currentAttendanceTotalPages;
      const startItem = (currentAttendancePage - 1) * currentAttendancePageSize + 1;
      const endItem = Math.min(currentAttendancePage * currentAttendancePageSize, totalItems);

      if (attendancePaginationInfo) {
        if (totalItems === 0) {
          attendancePaginationInfo.textContent = 'No users to display.';
        } else {
          attendancePaginationInfo.textContent = `Showing ${startItem}-${endItem} of ${totalItems} users`;
        }
      }

      if (attendancePrevBtn) {
        attendancePrevBtn.disabled = currentAttendancePage <= 1;
      }
      if (attendanceNextBtn) {
        attendanceNextBtn.disabled = currentAttendancePage >= totalPages;
      }

      console.log(`📄 Pagination: Page ${currentAttendancePage}/${totalPages}, Items ${startItem}-${endItem}/${totalItems}`);
    }

    // View user attendance detail
    function viewUserAttendanceDetail(userId) {
      if (!currentAttendanceData || !currentAttendanceData.users) {
        showFeedback(dashboardFeedback, 'No attendance data available', 'error');
        return;
      }

      const user = currentAttendanceData.users.find(u => u.id === userId);
      if (!user) {
        showFeedback(dashboardFeedback, 'User not found', 'error');
        return;
      }

      // Create detailed logs view
      let logsHtml = '';
      if (user.logs && user.logs.length > 0) {
        logsHtml = user.logs.map(log => `
          <div class="log-entry">
            <div class="log-time">${new Date(log.timestamp).toLocaleString()}</div>
            <div class="log-action ${log.action.toLowerCase()}">${log.action}</div>
            <div class="log-camera">${log.camera_name}</div>
            ${log.recognition_score ? `<div class="log-score">Score: ${(log.recognition_score * 100).toFixed(1)}%</div>` : ''}
          </div>
        `).join('');
      } else {
        logsHtml = '<div class="no-logs">No logs found for this user on the selected date.</div>';
      }

      // For now, show in feedback. In a real implementation, you'd use a modal
      showFeedback(dashboardFeedback, `Viewing attendance details for ${user.name} (${user.logs.length} logs)`, 'info');
    }


    // ===== USERS SECTION =====
    
    // Global variables for users management
    let currentUsersData = null;
    let currentUsersPage = 1;
    let currentUsersPageSize = 25;
    let currentUsersTotalCount = 0;
    let currentUsersTotalPages = 0;
    
    // DOM elements for users section
    let usersSearch, usersStatusFilter, usersTypeFilter, usersPageSize;
    let usersApplyFilters, usersClearFilters, usersRefresh;
    let usersTableBody, usersPaginationInfo, usersPrevBtn, usersNextBtn;

    // Initialize users section
    function initializeUsersSection() {
      console.log('🚀 Initializing Users Section...');
      
      // Initialize DOM elements
      initializeUsersDOM();
      
      // Add event listeners
      setupUsersEventListeners();
      
      // Load users data
      loadUsers();
    }

    // Initialize DOM elements
    function initializeUsersDOM() {
      usersSearch = document.getElementById('users-search');
      usersStatusFilter = document.getElementById('users-status-filter');
      usersTypeFilter = document.getElementById('users-type-filter');
      usersPageSize = document.getElementById('users-page-size');
      usersApplyFilters = document.getElementById('users-apply-filters');
      usersClearFilters = document.getElementById('users-clear-filters');
      usersRefresh = document.getElementById('users-refresh');
      usersTableBody = document.getElementById('users-table-body');
      usersPaginationInfo = document.getElementById('users-pagination-info');
      usersPrevBtn = document.getElementById('users-prev');
      usersNextBtn = document.getElementById('users-next');
      
      console.log('✅ Users DOM elements initialized');
    }

    // Setup event listeners
    function setupUsersEventListeners() {
      if (usersApplyFilters) usersApplyFilters.addEventListener('click', applyUsersFilters);
      if (usersClearFilters) usersClearFilters.addEventListener('click', clearUsersFilters);
      if (usersRefresh) usersRefresh.addEventListener('click', () => loadUsers());
      if (usersSearch) usersSearch.addEventListener('input', debounce(applyUsersFilters, 300));
      if (usersStatusFilter) usersStatusFilter.addEventListener('change', applyUsersFilters);
      if (usersTypeFilter) usersTypeFilter.addEventListener('change', applyUsersFilters);
      
      if (usersPageSize) {
        usersPageSize.addEventListener('change', (e) => {
          currentUsersPageSize = parseInt(e.target.value);
          currentUsersPage = 1;
          if (currentUsersData) {
            renderUsersTable();
            updateUsersPagination();
          }
        });
      }
      
      if (usersPrevBtn) {
        usersPrevBtn.addEventListener('click', () => {
          if (currentUsersPage > 1) {
            currentUsersPage--;
            if (currentUsersData) {
              renderUsersTable();
              updateUsersPagination();
            }
          }
        });
      }
      
      if (usersNextBtn) {
        usersNextBtn.addEventListener('click', () => {
          if (currentUsersPage < currentUsersTotalPages) {
            currentUsersPage++;
            if (currentUsersData) {
              renderUsersTable();
              updateUsersPagination();
            }
          }
        });
      }
      
      console.log('✅ Users event listeners added');
    }

    // Load users data
    async function loadUsers() {
      console.log('📊 Loading users data...');
      
      if (!currentToken) {
        showFeedback(dashboardFeedback, 'Please log in to view users', 'error');
        return;
      }

      // Show loading state
      showUsersLoading();

      try {
        // Current API doesn't support filtering/pagination, so we get all users
        const url = `${backend_url}/admin/users`;
        console.log('🌐 Making request to:', url);
        
        const response = await fetch(url, {
          headers: {
            'Authorization': `Bearer ${currentToken}`,
            'Content-Type': 'application/json'
          }
        });

        console.log('📡 Response status:', response.status);

        if (response.status === 401) {
          console.log('🔒 Unauthorized, logging out');
          handleLogout(true);
          return;
        }

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();
        console.log('📦 Received data:', data);
        
        currentUsersData = data;
        // Current API doesn't support pagination, so we'll handle it client-side
        currentUsersTotalCount = data.users ? data.users.length : 0;
        currentUsersTotalPages = Math.ceil(currentUsersTotalCount / currentUsersPageSize);
        
        renderUsersTable();
        updateUsersPagination();

      } catch (error) {
        console.error('❌ Error loading users:', error);
        showUsersError(error.message || 'Failed to load users data');
        showFeedback(dashboardFeedback, error.message || 'Failed to load users data', 'error');
      }
    }

    // Show loading state
    function showUsersLoading() {
      if (usersTableBody) {
        usersTableBody.innerHTML = `
          <tr>
            <td colspan="7" class="loading-logs">
              <span class="spinner"></span>Loading users...
            </td>
          </tr>
        `;
      }
    }

    // Show error state
    function showUsersError(message) {
      if (usersTableBody) {
        usersTableBody.innerHTML = `
          <tr>
            <td colspan="7" style="text-align: center; padding: 40px; color: #dc2626;">
              ❌ ${message}
            </td>
          </tr>
        `;
      }
    }

    // Apply filters
    function applyUsersFilters() {
      console.log('🔍 Applying filters...');
      currentUsersPage = 1; // Reset to first page when filters change
      if (currentUsersData) {
        renderUsersTable();
        updateUsersPagination();
      }
    }

    // Clear filters
    function clearUsersFilters() {
      console.log('🧹 Clearing filters...');
      if (usersSearch) usersSearch.value = '';
      if (usersStatusFilter) usersStatusFilter.value = '';
      if (usersTypeFilter) usersTypeFilter.value = '';
      currentUsersPage = 1;
      if (currentUsersData) {
        renderUsersTable();
        updateUsersPagination();
      }
    }

    // Render users table
    function renderUsersTable() {
      console.log('🎨 Rendering users table...');
      
      if (!currentUsersData || !currentUsersData.users || currentUsersData.users.length === 0) {
        if (usersTableBody) {
          usersTableBody.innerHTML = `
            <tr>
              <td colspan="7" style="text-align: center; padding: 40px; color: #6b7280;">
                No users found matching the current filters.
              </td>
            </tr>
          `;
        }
        return;
      }

      // Apply client-side filtering and pagination
      let filteredUsers = currentUsersData.users;
      
      // Apply search filter
      const searchTerm = usersSearch ? usersSearch.value.trim().toLowerCase() : '';
      if (searchTerm) {
        filteredUsers = filteredUsers.filter(user => 
          (user.name && user.name.toLowerCase().includes(searchTerm)) ||
          (user.flat_number && user.flat_number.toLowerCase().includes(searchTerm)) ||
          (user.mobile_number && user.mobile_number.includes(searchTerm))
        );
      }
      
      // Apply status filter
      const statusFilter = usersStatusFilter ? usersStatusFilter.value : '';
      if (statusFilter) {
        filteredUsers = filteredUsers.filter(user => user.status === statusFilter);
      }
      
      // Apply type filter
      const typeFilter = usersTypeFilter ? usersTypeFilter.value : '';
      if (typeFilter) {
        filteredUsers = filteredUsers.filter(user => user.user_type === typeFilter);
      }
      
      // Update total count for pagination
      currentUsersTotalCount = filteredUsers.length;
      currentUsersTotalPages = Math.ceil(currentUsersTotalCount / currentUsersPageSize);
      
      // Apply pagination
      const startIndex = (currentUsersPage - 1) * currentUsersPageSize;
      const endIndex = startIndex + currentUsersPageSize;
      const paginatedUsers = filteredUsers.slice(startIndex, endIndex);

      console.log(`📄 Rendering page ${currentUsersPage}: ${paginatedUsers.length} users (${currentUsersTotalCount} total)`);

      const rows = paginatedUsers.map(user => {
        const statusClass = user.status === 'active' ? 'status-active' : 
                           user.status === 'inactive' ? 'status-inactive' : 
                           'pending';
        const statusBadge = user.status || 'unknown';
        
        // Format access expiry
        let expiryClass = 'access-expiry';
        let expiryText = 'N/A';
        
        if (user.forever_access) {
          expiryClass = 'access-expiry forever';
          expiryText = 'Forever';
        } else if (user.expire_at) {
          const expiryDate = new Date(user.expire_at);
          const today = new Date();
          const diffDays = Math.floor((expiryDate - today) / (1000 * 60 * 60 * 24));
          
          if (diffDays < 0) {
            expiryClass = 'access-expiry expired';
            expiryText = 'Expired';
          } else if (diffDays <= 7) {
            expiryClass = 'access-expiry expiring-soon';
            expiryText = expiryDate.toLocaleDateString();
          } else {
            expiryClass = 'access-expiry valid';
            expiryText = expiryDate.toLocaleDateString();
          }
        }
        
        const registeredOn = 'N/A'; // API doesn't provide registration date
        
        const thumbnail = user.thumbnail_url ? 
          `<img src="${user.thumbnail_url}" alt="${user.name}" class="user-photo" />` : 
          '<div class="no-photo">👤</div>';

        return `
          <tr>
            <td>
              <div class="person-cell">
                ${thumbnail}
                <div>
                  <div class="person-name">${user.name || 'Unknown'}</div>
                  <div class="person-meta">${user.flat_number || 'N/A'}</div>
                </div>
              </div>
            </td>
            <td>
              <div>${user.mobile_number || 'N/A'}</div>
              ${user.email ? `<div class="person-meta">${user.email}</div>` : ''}
            </td>
            <td>
              <span class="user-type-badge">${user.user_type || 'N/A'}</span>
            </td>
            <td>
              <span class="status-chip ${statusClass}">${statusBadge}</span>
            </td>
            <td>
              <div class="${expiryClass}">${expiryText}</div>
            </td>
            <td>${registeredOn}</td>
            <td>
              <div class="table-actions">
                <button class="action-secondary" onclick="viewUserDetails('${user.id}')">View</button>
              </div>
            </td>
          </tr>
        `;
      }).join('');

      if (usersTableBody) {
        usersTableBody.innerHTML = rows;
        console.log('✅ Table rendered successfully');
      }
    }

    // Update pagination
    function updateUsersPagination() {
      if (!currentUsersData) return;

      const totalItems = currentUsersTotalCount;
      const totalPages = currentUsersTotalPages;
      const startItem = (currentUsersPage - 1) * currentUsersPageSize + 1;
      const endItem = Math.min(currentUsersPage * currentUsersPageSize, totalItems);

      if (usersPaginationInfo) {
        if (totalItems === 0) {
          usersPaginationInfo.textContent = 'No users to display.';
        } else {
          usersPaginationInfo.textContent = `Showing ${startItem}-${endItem} of ${totalItems} users`;
        }
      }

      if (usersPrevBtn) {
        usersPrevBtn.disabled = currentUsersPage <= 1;
      }
      if (usersNextBtn) {
        usersNextBtn.disabled = currentUsersPage >= totalPages;
      }

      console.log(`📄 Pagination: Page ${currentUsersPage}/${totalPages}, Items ${startItem}-${endItem}/${totalItems}`);
    }

    // View user details
    function viewUserDetails(userId) {
      console.log('👤 Viewing user details for:', userId);
      if (!currentUsersData || !currentUsersData.users) {
        showFeedback(dashboardFeedback, 'No user data available', 'error');
        return;
      }

      const user = currentUsersData.users.find(u => u.id === userId);
      if (!user) {
        showFeedback(dashboardFeedback, 'User not found', 'error');
        return;
      }

      // For now, show in feedback. In a real implementation, you'd use a modal
      showFeedback(dashboardFeedback, `Viewing details for: ${user.name}`, 'success');
    }


    // Load section-specific data
    function loadSectionData(sectionId) {
      switch(sectionId) {
        case 'overview-section':
          loadUserStatistics();
          break;
        case 'users-section':
          initializeUsersSection();
          break;
        case 'user-attendance-section':
          initializeAttendanceSection();
          break;
        case 'access-logs-section':
          // Access logs are loaded in activateSection
          break;
        default:
          console.log('No specific data loading for section:', sectionId);
      }
    }

        // Initialize the dashboard
    checkAuthentication();
    setupUserManagementEventListeners();
    loadUserStatistics(); // Load user stats on page load since overview is active by default
  </script>
</body>
</html>

    <div id="user-detail-overlay" class="modal hidden">
      <div class="modal-backdrop" data-close-detail="true"></div>
      <div class="modal-dialog" id="user-detail-dialog">
        <button class="modal-close" id="user-detail-close" aria-label="Close user detail">&times;</button>
        <div id="user-detail-loading" class="modal-loading">Loading user details…</div>
        <div id="user-detail-error" class="modal-error hidden"></div>
        <div id="user-detail-content" class="modal-content hidden">
          <div class="user-detail-header" id="user-detail-info"></div>
          <div class="user-detail-gallery" id="user-detail-gallery"></div>
          <div class="user-detail-logs">
            <h4>Daily Access Summary</h4>
            <div class="table-wrapper">
              <table class="detail-logs-table">
                <thead>
                  <tr>
                    <th>Date</th>
                    <th>Total Logs</th>
                    <th>Entries</th>
                    <th>Exits</th>
                    <th>First Entry</th>
                    <th>Last Exit</th>
                  </tr>
                </thead>
                <tbody id="user-detail-logs-body"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
